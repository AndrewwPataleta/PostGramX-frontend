import{d as P,u as R,r as x,b as p,j as e,R as b,h as E}from"./index-DjgcfNCA.js";import{u as T}from"./useQuery-DJK7f5h8.js";import{u as v}from"./useMutation-ZHRf5x4X.js";import{a as C,b as I}from"./predealsApi-1i8XcGAn.js";import{E as y}from"./ErrorState-B84UGFyA.js";import{P as i}from"./PageContainer-Do6N_G2q.js";import{S as c}from"./skeleton-DaN5d4pV.js";import{g as j}from"./errors-3kY4UU5q.js";import{S as L}from"./ui-UGNIoUFb.js";import{o as D}from"./telegramLinks-DFMIlj7w.js";import{P as a}from"./deals-DojQzn6v.js";import"./channels-CCH0-4EZ.js";const M=new Set(["API","ID","TON","USD"]),_=r=>{const o=r.replace(/[_-]+/g," ").replace(/\s+/g," ").trim();return o?o.split(" ").map(n=>{const d=n.toUpperCase();if(M.has(d))return d;const t=n.toLowerCase();return`${t.charAt(0).toUpperCase()}${t.slice(1)}`}).join(" "):""},U=r=>r?L[r]??_(r):"",k={[a.AWAITING_CREATIVE]:"border-border/60 bg-secondary/40 text-muted-foreground",[a.AWAITING_CONFIRMATION]:"border-border/60 bg-secondary/40 text-muted-foreground",[a.AWAITING_ADMIN_APPROVAL]:"border-border/60 bg-secondary/40 text-muted-foreground",[a.READY_FOR_PAYMENT]:"border-emerald-500/30 bg-emerald-500/15 text-emerald-200",[a.REJECTED]:"border-rose-500/30 bg-rose-500/15 text-rose-200",[a.EXPIRED]:"border-rose-500/30 bg-rose-500/15 text-rose-200",[a.CANCELED]:"border-rose-500/30 bg-rose-500/15 text-rose-200"},O=new Set([a.READY_FOR_PAYMENT,a.REJECTED,a.EXPIRED,a.CANCELED]),Y=r=>{const o=Math.max(0,Math.floor(r)),n=Math.floor(o/3600),d=Math.floor(o%3600/60),t=o%60;return n>0?`${n}h ${d}m`:d>0?`${d}m ${t}s`:`${t}s`},F=r=>U(r)||"Awaiting update",f=({title:r,children:o,className:n})=>e.jsxs("div",{className:E("rounded-2xl border border-border/60 bg-card/80 p-4 space-y-3",n),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground",children:"Step"}),e.jsx("h2",{className:"text-sm font-semibold text-foreground",children:r})]}),o]});function Z(){const{id:r}=P(),o=R(),[n,d]=x.useState(Date.now()),t=T({queryKey:["predeal",r],queryFn:()=>I({id:r??""}),enabled:!!r,refetchInterval:l=>{const N=l.state.data?.status;return N&&O.has(N)?!1:4e3}}),m=v({mutationFn:C,onSuccess:()=>{p.success("Pre-deal canceled"),o(b.MARKETPLACE,{replace:!0})},onError:l=>{p.error(j(l,"Unable to cancel pre-deal"))}});if(x.useEffect(()=>{t.error&&p.error(j(t.error,"Unable to load pre-deal"))},[t.error]),x.useEffect(()=>{if(!t.data?.paymentExpiresAt)return;const l=window.setInterval(()=>d(Date.now()),1e3);return()=>window.clearInterval(l)},[t.data?.paymentExpiresAt]),!r)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(i,{className:"py-6",children:e.jsx(y,{message:"Pre-deal not found",description:"Return to the marketplace to choose a listing.",onRetry:()=>o(b.MARKETPLACE)})})});if(t.isLoading)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(i,{className:"py-6 space-y-4",children:[e.jsx(c,{className:"h-6 w-40"}),e.jsx(c,{className:"h-4 w-64"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(c,{className:"h-36 w-full"}),e.jsx(c,{className:"h-36 w-full"}),e.jsx(c,{className:"h-36 w-full"})]})]})});if(t.isError||!t.data)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(i,{className:"py-6",children:e.jsx(y,{message:"Unable to load pre-deal",description:"We could not fetch the latest status.",onRetry:()=>t.refetch()})})});const s=t.data,A=F(s.status),w=k[s.status]??"border-border/60 bg-secondary/40 text-muted-foreground",S=s.status===a.READY_FOR_PAYMENT,h=s.paymentExpiresAt?new Date(s.paymentExpiresAt):null,u=h?(h.getTime()-n)/1e3:null,g=u!=null?u>0?Y(u):"Payment window expired":null;return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(i,{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Pre-deal status"}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Send your post to the bot"})]}),e.jsxs(f,{title:"Send post to bot",children:[e.jsx("p",{className:"text-sm text-foreground",children:s.botInstructions?.message??"Open the bot and send your post for review."}),s.botInstructions?.startUrl?e.jsx("button",{type:"button",onClick:()=>D(s.botInstructions?.startUrl??""),className:"w-full rounded-lg border border-border/60 bg-secondary/40 px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border",children:"Open bot"}):null]}),e.jsxs(f,{title:"Wait for approvals",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("span",{className:E("inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold",w),children:A}),e.jsx("button",{type:"button",onClick:()=>t.refetch(),className:"rounded-lg border border-border/60 bg-secondary/40 px-3 py-1.5 text-xs font-semibold text-foreground transition hover:border-border",children:"Refresh"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will keep checking for status updates every few seconds."})]}),e.jsx(f,{title:"Payment",children:S?e.jsxs("div",{className:"space-y-3",children:[g?e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Payment window: ",e.jsx("span",{className:"font-semibold text-foreground",children:g})]}):null,s.payment?.escrowAddress?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Escrow address"}),e.jsx("p",{className:"text-xs font-semibold text-foreground break-all",children:s.payment.escrowAddress})]}):null,s.payment?.expectedAmountNano?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Amount (nano)"}),e.jsx("p",{className:"text-xs font-semibold text-foreground",children:s.payment.expectedAmountNano})]}):null,e.jsx("button",{type:"button",onClick:()=>o(b.ESCROW(s.id)),className:"w-full rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground",children:"Open Mini App Payment"})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Payment details will appear once the post is approved."})}),e.jsx("button",{type:"button",onClick:()=>m.mutate({id:s.id}),disabled:m.isPending,className:"w-full rounded-lg border border-border/60 bg-background px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border disabled:opacity-60",children:m.isPending?"Canceling...":"Cancel pre-deal"})]})})}export{Z as default};
