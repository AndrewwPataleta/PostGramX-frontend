import{c as V,a as h,r as y,j as e,h as p,f as D,b as g,p as v,d as H,e as Y}from"./index-BSb6cstv.js";import{u as T}from"./useQuery-BSKplK9T.js";import{a as M,b as w}from"./formatters-B6oyEeL1.js";import{f as B,h as A,b as Q,c as K}from"./labels-EEWNt0UM.js";import{C as $}from"./chevron-left-D1XSnKx7.js";import{a as Z,f as z}from"./dealsApi-CilGAVME.js";import{L as J}from"./LoadingSkeleton-CmuWuxbG.js";import{E as X}from"./ErrorState-mJvP7EnN.js";import{P as ee}from"./PageContainer-C5l0dukc.js";import{g as N}from"./errors-3kY4UU5q.js";import{u as E}from"./useMutation-C-JNqq5A.js";import{t as k}from"./date-DTgQQEB1.js";import{o as U}from"./telegramLinks-DFMIlj7w.js";import"./skeleton-BigLCaJ3.js";/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],se=V("chevron-right",te);function re({deal:t}){const{t:s,language:n}=h(),[o,r]=y.useState(!1),a=`${M(t.listing.priceNano,n)} ${s("common.ton")}`,l=B(s,t.listing.format),i=t.listing.tags??[],u=t.listing.pinDurationHours??t.listing.placementHours,x=t.listing.visibilityDurationHours??t.listing.lifetimeHours,d=y.useMemo(()=>[{label:s("listings.pinDuration"),value:u?A(u,s):s("common.none")},{label:s("listings.lifetimeDuration"),value:x?A(x,s):s("common.emptyValue")},{label:s("listings.allowEdits.label"),value:t.listing.allowEdits===void 0?s("common.emptyValue"):Q(s,t.listing.allowEdits)},{label:s("listings.allowLinkTracking.label"),value:t.listing.allowLinkTracking===void 0?s("common.emptyValue"):K(s,t.listing.allowLinkTracking)}],[t.listing.allowEdits,t.listing.allowLinkTracking,u,x,s]);return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center overflow-hidden rounded-full bg-secondary/60 text-lg font-semibold text-muted-foreground",children:t.channel.avatarUrl?e.jsx("img",{src:t.channel.avatarUrl,alt:t.channel.name,className:"h-full w-full object-cover"}):t.channel.name.slice(0,1)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-foreground",children:[e.jsx("span",{className:"truncate",children:t.channel.name}),t.channel.verified?e.jsx("span",{className:"rounded-full bg-emerald-500/10 px-2 py-0.5 text-[10px] font-semibold text-emerald-400",children:s("channels.verifiedBadge")}):null]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",t.channel.username]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:a}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"button",onClick:()=>r(c=>!c),className:"flex w-full items-center justify-between rounded-lg border border-border/60 bg-background/60 px-3 py-2 text-xs font-semibold text-muted-foreground transition hover:text-foreground",children:[e.jsx("span",{children:s(o?"common.hideDetails":"common.more")}),e.jsx("span",{className:p("text-xs",o?"text-foreground":"text-muted-foreground"),children:s(o?"common.collapseSymbol":"common.expandSymbol")})]})}),o?e.jsxs("div",{className:"mt-4 space-y-3 text-xs text-muted-foreground",children:[i.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:i.map(c=>e.jsxs("span",{className:"rounded-full bg-secondary/60 px-3 py-1 text-xs font-medium text-foreground",children:["#",c]},c))}):null,e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:d.map(c=>e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-[11px] uppercase tracking-wide text-muted-foreground",children:c.label}),e.jsx("span",{className:"font-semibold text-foreground",children:c.value})]},c.label))}),t.listing.contentRulesText?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-muted-foreground",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-wide text-foreground/80",children:s("listings.rulesTitle")}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t.listing.contentRulesText})]}):null]}):null]})}const I=["SCHEDULE","SEND_POST","CONFIRM_POST","ADMIN_APPROVAL","PAYMENT_WINDOW","PAYMENT","PAYMENT_PENDING","SCHEDULED","VERIFYING","DONE"],ne=[...I],oe={SCHEDULING_PENDING:"SCHEDULE",CREATIVE_AWAITING_SUBMIT:"SEND_POST",CREATIVE_AWAITING_CONFIRM:"CONFIRM_POST",ADMIN_REVIEW:"ADMIN_APPROVAL",PAYMENT_WINDOW_PENDING:"PAYMENT_WINDOW",PAYMENT_AWAITING:"PAYMENT",FUNDS_PENDING:"PAYMENT_PENDING",FUNDS_CONFIRMED:"SCHEDULED",APPROVED_SCHEDULED:"SCHEDULED",POSTED_VERIFYING:"VERIFYING",COMPLETED:"DONE",CANCELED:"DONE",REFUNDED:"DONE",DISPUTED:"DONE"},F=t=>oe[t]??"SCHEDULE",L=(t,s)=>s(`deals.timeline.stage.${t}`),ae=(t,s)=>s(`deals.escrowStatus.${t}`),de=(t,s)=>{const n=F(s);return I.indexOf(t)<=I.indexOf(n)};function le({stages:t,selectedStage:s,escrowStatus:n,onSelect:o}){const{t:r}=h(),a=t.indexOf(s),l=a>0?t[a-1]:null,i=a>=0&&a<t.length-1?t[a+1]:null,u=!!o;return e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:r("deals.timeline.title")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r("deals.timeline.steps",{count:t.length})})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[u?e.jsx("button",{type:"button",onClick:()=>l&&o?.(l),disabled:!l,className:p("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",l?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":r("deals.timeline.previousStage"),children:e.jsx($,{className:"h-4 w-4"})}):null,e.jsx("div",{className:"flex flex-1 flex-wrap gap-2",children:t.map(x=>{const d=x===s,c=!de(x,n),P=p("rounded-full border px-3 py-1 text-xs font-semibold transition",d?"border-primary/50 bg-primary/15 text-primary-foreground":"border-border/60 bg-background/50 text-muted-foreground",u&&!c?"hover:border-primary/40 hover:text-foreground":"opacity-70");return u?e.jsx("button",{type:"button",onClick:()=>o?.(x),disabled:c,className:p(P,c?"cursor-not-allowed opacity-40":"hover:border-primary/40 hover:text-foreground"),children:L(x,r)},x):e.jsx("div",{className:P,children:L(x,r)},x)})}),u?e.jsx("button",{type:"button",onClick:()=>i&&o?.(i),disabled:!i,className:p("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",i?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":r("deals.timeline.nextStage"),children:e.jsx(se,{className:"h-4 w-4"})}):null]})]})}function f({title:t,children:s}){return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t})}),e.jsx("div",{className:"mt-3 space-y-2 text-xs text-muted-foreground",children:s})]})}const _=t=>{if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":new Date(s.getTime()-s.getTimezoneOffset()*6e4).toISOString().slice(0,16)};function ie({deal:t,readonly:s,onAction:n}){const o=D(),{t:r,language:a}=h(),[l,i]=y.useState(_(t.scheduledAt));y.useEffect(()=>{i(_(t.scheduledAt))},[t.scheduledAt]);const u=E({mutationFn:async()=>{if(!l)throw new Error(r("deals.stage.scheduleTime.selectDateError"));const d=k(l);if(!d.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",d),new Error("Invalid datetime format");return console.log("Schedule payload UTC:",d),v("/deals/schedule",{dealId:t.id,scheduledAt:d})},onSuccess:()=>{g.success(r("deals.stage.scheduleTime.updatedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:d=>{g.error(N(d,r("deals.stage.scheduleTime.saveError")))}});if(s)return e.jsxs(f,{title:r("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduleTime.readonly")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("deals.scheduledAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:t.scheduledAt?w(t.scheduledAt,a):r("deals.stage.scheduleTime.notScheduled")})]})]});const x=()=>{if(!l){g.error(r("deals.stage.scheduleTime.selectDateError"));return}if(n?.onConfirmSchedule){const d=k(l);if(!d.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",d),new Error("Invalid datetime format");n.onConfirmSchedule(d);return}u.mutate()};return e.jsxs(f,{title:r("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduleTime.description")}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx("input",{type:"datetime-local",value:l,onChange:d=>i(d.target.value),className:"w-full rounded-lg border border-border/60 bg-background/60 px-3 py-2 text-xs text-foreground"}),e.jsx("button",{type:"button",onClick:x,disabled:u.isPending,className:p("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",u.isPending?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("deals.stage.scheduleTime.confirm")})]})]})}const ce="postgramx_bot";function ue({deal:t,readonly:s,onAction:n}){const o=D(),{t:r}=h(),a=`https://t.me/${ce}?start=deal_${t.id}`,l=!!t.creativeText,i=E({mutationFn:async()=>v("/deals/creative/submit",{dealId:t.id}),onSuccess:()=>{g.success(r("deals.stage.sendPost.submittedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:d=>{g.error(N(d,r("deals.stage.sendPost.submitError")))}});if(s)return e.jsxs(f,{title:r("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.readonly")}),l?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:r("deals.stage.sendPost.creativeSubmitted")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.noCreative")})]});const u=()=>{if(n?.onOpenBot){n.onOpenBot();return}U(a)},x=()=>{if(n?.onConfirmSent){n.onConfirmSent();return}i.mutate()};return e.jsxs(f,{title:r("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.description")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:u,className:"rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition hover:bg-primary/90",children:r("deals.stage.sendPost.openBot")}),e.jsx("button",{type:"button",onClick:x,disabled:i.isPending,className:p("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",i.isPending&&"cursor-not-allowed opacity-60"),children:r("deals.stage.sendPost.confirmSent")})]}),l?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.waitingReview")}):null]})}function me({deal:t,readonly:s,onAction:n}){const o=D(),{t:r}=h(),a=t.creativeText,l=E({mutationFn:async()=>v("/deals/creative/confirm",{dealId:t.id}),onSuccess:()=>{g.success(r("deals.stage.confirmPost.confirmedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:d=>{g.error(N(d,r("deals.stage.confirmPost.confirmError")))}}),i=E({mutationFn:async()=>v("/deals/creative/reject",{dealId:t.id}),onSuccess:()=>{g.success(r("deals.stage.confirmPost.requestedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:d=>{g.error(N(d,r("deals.stage.confirmPost.requestError")))}});if(s)return e.jsxs(f,{title:r("deals.stage.confirmPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.confirmPost.readonly")}),a?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:a}):e.jsx("div",{className:"rounded-lg border border-dashed border-border/60 bg-background/40 p-3 text-xs text-muted-foreground",children:r("deals.stage.confirmPost.waitingCreative")})]});const u=()=>{if(n?.onConfirm){n.onConfirm();return}l.mutate()},x=()=>{if(n?.onRequestChanges){n.onRequestChanges();return}i.mutate()};return e.jsxs(f,{title:r("deals.stage.confirmPost.title"),children:[a?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:a}):e.jsx("div",{className:"rounded-lg border border-dashed border-border/60 bg-background/40 p-3 text-xs text-muted-foreground",children:r("deals.stage.confirmPost.waitingCreative")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:u,disabled:!a||l.isPending,className:p("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",!a||l.isPending?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("common.confirm")}),e.jsx("button",{type:"button",onClick:x,disabled:!a||i.isPending,className:p("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",!a||i.isPending?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r("common.requestChanges")})]})]})}function xe({deal:t,readonly:s,onAction:n}){const o=D(),{t:r}=h(),a=E({mutationFn:async()=>v("/deals/creative/approve",{dealId:t.id}),onSuccess:()=>{g.success(r("deals.stage.adminApproval.approvedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:c=>{g.error(N(c,r("deals.stage.adminApproval.approveError")))}}),l=E({mutationFn:async()=>v("/deals/creative/edits",{dealId:t.id}),onSuccess:()=>{g.success(r("deals.stage.adminApproval.requestedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:c=>{g.error(N(c,r("deals.stage.adminApproval.requestError")))}}),i=E({mutationFn:async()=>v("/deals/creative/reject",{dealId:t.id}),onSuccess:()=>{g.success(r("deals.stage.adminApproval.rejectedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:c=>{g.error(N(c,r("deals.stage.adminApproval.rejectError")))}});if(s)return e.jsx(f,{title:r("deals.stage.adminApproval.title"),children:e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.readonly")})});const u=()=>{if(n?.onApprove){n.onApprove();return}a.mutate()},x=()=>{if(n?.onRequestChanges){n.onRequestChanges();return}l.mutate()},d=()=>{if(n?.onReject){n.onReject();return}i.mutate()};return e.jsxs(f,{title:r("deals.stage.adminApproval.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.description")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:u,disabled:a.isPending,className:p("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",a.isPending&&"cursor-not-allowed opacity-60"),children:r("common.approve")}),e.jsx("button",{type:"button",onClick:x,disabled:l.isPending,className:p("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",l.isPending&&"cursor-not-allowed opacity-60"),children:r("common.requestChanges")}),e.jsx("button",{type:"button",onClick:d,disabled:i.isPending,className:p("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",i.isPending&&"cursor-not-allowed opacity-60"),children:r("common.reject")})]})]})}const R=[1,2,24],ge=(t,s)=>{if(!t)return null;const n=new Date(t).getTime();if(Number.isNaN(n))return null;const o=Math.max(0,n-Date.now()),r=Math.floor(o/36e5),a=Math.floor(o%36e5/6e4);return`${r}${s("common.hoursShort")} ${a}${s("common.minutesShort")}`};function pe({deal:t,readonly:s,onAction:n}){const o=D(),{t:r}=h(),[a,l]=y.useState(R[0]),i=E({mutationFn:async()=>v("/deals/payment-window",{dealId:t.id,hours:a}),onSuccess:()=>{g.success(r("deals.stage.paymentWindow.updatedToast")),o.invalidateQueries({queryKey:["deal",t.id]})},onError:d=>{g.error(N(d,r("deals.stage.paymentWindow.saveError")))}}),u=y.useMemo(()=>ge(t.escrowExpiresAt,r),[t.escrowExpiresAt,r]),x=()=>{if(n?.onSetWindow){n.onSetWindow(a);return}i.mutate()};return e.jsxs(f,{title:r("deals.stage.paymentWindow.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.paymentWindow.description")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.map(d=>e.jsx("button",{type:"button",onClick:()=>l(d),disabled:s,className:p("rounded-full border px-3 py-1 text-xs font-semibold",d===a?"border-primary/50 bg-primary/15 text-primary-foreground":"border-border/60 bg-background/50 text-muted-foreground",s&&"cursor-not-allowed opacity-60"),children:r("deals.stage.paymentWindow.option",{hours:d})},d))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:x,disabled:s||i.isPending,className:p("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",s||i.isPending?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("deals.stage.paymentWindow.confirm")}),u?e.jsx("span",{className:"text-xs text-muted-foreground",children:r("deals.stage.paymentWindow.expiresIn",{time:u})}):null]})]})}function fe({deal:t,readonly:s,onAction:n}){const{t:o,language:r}=h(),[a,l]=y.useState(!1),i=()=>{if(!s){if(n?.onPay){n.onPay();return}l(!0),setTimeout(()=>l(!1),1200)}};return e.jsxs(f,{title:o("deals.stage.payment.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:o("deals.stage.payment.description")}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"rounded-full bg-secondary/60 px-3 py-1 text-xs font-semibold text-foreground",children:[o("deals.stage.payment.amount"),": ",M(t.listing.priceNano,r)," ",o("common.ton")]}),e.jsx("span",{className:"rounded-full border border-border/60 bg-background/50 px-3 py-1 text-xs font-semibold text-muted-foreground",children:o("deals.stage.payment.walletHint")})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",disabled:s||a,onClick:i,className:p("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",s||a?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:o(a?"common.sending":"common.pay")})})]})}function he({onAction:t,isRefreshing:s}){const{t:n}=h();return e.jsxs(f,{title:n("deals.stage.paymentPending.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:n("deals.stage.paymentPending.description")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",onClick:t?.onRefresh,disabled:s||!t?.onRefresh,className:p("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",s||!t?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:n(s?"common.refreshing":"common.refresh")})})]})}function O({deal:t}){const{t:s,language:n}=h(),o=t.scheduledAt?w(t.scheduledAt,n):s("deals.stage.scheduled.notScheduled");return e.jsxs(f,{title:s("deals.stage.scheduled.title"),children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.stage.scheduled.time"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:o})]}),t.scheduledAt?e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduled.waiting")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduled.noSchedule")})]})}function be({deal:t}){const{t:s}=h(),n=()=>{t.postUrl&&U(t.postUrl)};return e.jsxs(f,{title:s("deals.stage.verifyingPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.verifyingPost.description")}),t.postUrl?e.jsx("button",{type:"button",onClick:n,className:p("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground","hover:border-primary/40"),children:s("deals.stage.verifyingPost.open")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.verifyingPost.pendingLink")})]})}function S({deal:t}){const{t:s,language:n}=h();return e.jsxs(f,{title:s("deals.stage.done.title"),children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.statusLabel"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:ae(t.escrowStatus,s)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("common.lastUpdate"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:w(t.lastActivityAt,n)||s("common.emptyValue")})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("common.createdAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:w(t.createdAt,n)||s("common.emptyValue")})]})]})}function _e(){const{dealId:t}=H(),s=Y(),n=D(),o=s.state?.deal,r=t?n.getQueryData(["deal",t]):void 0,a=o?.id===t?o:r,{data:l,isLoading:i,error:u,refetch:x,isFetching:d}=T({queryKey:["deal",t],queryFn:async()=>{if(!t)throw new Error("Missing deal id");return Z(t)},enabled:!!t,initialData:a,refetchInterval:j=>j&&["PAYMENT_AWAITING","FUNDS_PENDING","POSTED_VERIFYING"].includes(j.escrowStatus)?5e3:!1}),c=T({queryKey:["deals","list","detail-fallback",t],queryFn:()=>z({role:"all",pendingLimit:20,activeLimit:20,completedLimit:20}),enabled:!!t&&!l,staleTime:2e4}),P=y.useMemo(()=>!c.data||!t?null:[...c.data.pending.items,...c.data.active.items,...c.data.completed.items].find(C=>C.id===t)??null,[t,c.data]),m=l??P;y.useEffect(()=>{(u||c.error)&&g.error(N(u??c.error,"Unable to load deal"))},[u,c.error]);const W=m?F(m.escrowStatus):"SCHEDULE",q=m?ne:[],G=y.useMemo(()=>{if(!m)return null;const j=m.userRoleInDeal==="advertiser",C=m.userRoleInDeal==="publisher"||m.userRoleInDeal==="publisher_manager",b=!j;return{SCHEDULING_PENDING:e.jsx(ie,{deal:m,readonly:!j}),CREATIVE_AWAITING_SUBMIT:e.jsx(ue,{deal:m,readonly:!j}),CREATIVE_AWAITING_CONFIRM:e.jsx(me,{deal:m,readonly:!j}),ADMIN_REVIEW:e.jsx(xe,{deal:m,readonly:!C}),PAYMENT_WINDOW_PENDING:e.jsx(pe,{deal:m,readonly:b}),PAYMENT_AWAITING:e.jsx(fe,{deal:m,readonly:b}),FUNDS_PENDING:e.jsx(he,{deal:m,readonly:b,onAction:b?void 0:{onRefresh:()=>x()},isRefreshing:d}),FUNDS_CONFIRMED:e.jsx(O,{deal:m,readonly:b}),APPROVED_SCHEDULED:e.jsx(O,{deal:m,readonly:b}),POSTED_VERIFYING:e.jsx(be,{deal:m,readonly:b}),COMPLETED:e.jsx(S,{deal:m,readonly:b}),CANCELED:e.jsx(S,{deal:m,readonly:b}),REFUNDED:e.jsx(S,{deal:m,readonly:b}),DISPUTED:e.jsx(S,{deal:m,readonly:b})}[m.escrowStatus]},[d,x,m]);return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(ee,{className:"py-6 space-y-4",children:i?e.jsx(J,{items:3}):u||c.error||!m?e.jsx(X,{message:N(u??c.error,"Deal not found"),description:"We couldn't load this deal right now.",onRetry:()=>x()}):e.jsxs(e.Fragment,{children:[e.jsx(re,{deal:m}),e.jsx(le,{stages:q,selectedStage:W,escrowStatus:m.escrowStatus}),G]})})})}export{_e as default};
