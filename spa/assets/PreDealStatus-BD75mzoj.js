import{d as w,u as I,r as u,b as x,j as e,h as y}from"./index-Cfu7q30y.js";import{u as R}from"./useQuery-DL3FZPFS.js";import{u as v}from"./useMutation-XCtXv_zX.js";import{a as T,b as P}from"./predealsApi-CKiLD_v-.js";import{E as h}from"./ErrorState-C3TGwbAb.js";import{P as c}from"./PageContainer-C5zOM9D4.js";import{S as l}from"./skeleton-D9Pc3ngM.js";import{g as N}from"./errors-3kY4UU5q.js";import{o as C}from"./telegramLinks-DFMIlj7w.js";const S={AWAITING_CREATIVE:"Awaiting creative",AWAITING_CONFIRMATION:"Awaiting confirmation",AWAITING_ADMIN_APPROVAL:"Awaiting admin approval",READY_FOR_PAYMENT:"Ready for payment",REJECTED:"Rejected",EXPIRED:"Expired",CANCELED:"Canceled"},D={AWAITING_CREATIVE:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_CONFIRMATION:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_ADMIN_APPROVAL:"border-border/60 bg-secondary/40 text-muted-foreground",READY_FOR_PAYMENT:"border-emerald-500/30 bg-emerald-500/15 text-emerald-200",REJECTED:"border-rose-500/30 bg-rose-500/15 text-rose-200",EXPIRED:"border-rose-500/30 bg-rose-500/15 text-rose-200",CANCELED:"border-rose-500/30 bg-rose-500/15 text-rose-200"},_=new Set(["READY_FOR_PAYMENT","REJECTED","EXPIRED","CANCELED"]),M=s=>{const o=Math.max(0,Math.floor(s)),a=Math.floor(o/3600),n=Math.floor(o%3600/60),t=o%60;return a>0?`${a}h ${n}m`:n>0?`${n}m ${t}s`:`${t}s`},L=s=>s?S[s]??s.replace(/_/g," ").toLowerCase():"Awaiting update",p=({title:s,children:o,className:a})=>e.jsxs("div",{className:y("rounded-2xl border border-border/60 bg-card/80 p-4 space-y-3",a),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground",children:"Step"}),e.jsx("h2",{className:"text-sm font-semibold text-foreground",children:s})]}),o]});function J(){const{id:s}=w(),o=I(),[a,n]=u.useState(Date.now()),t=R({queryKey:["predeal",s],queryFn:()=>P({id:s??""}),enabled:!!s,refetchInterval:d=>{const g=d.state.data?.status;return g&&_.has(g)?!1:4e3}}),i=v({mutationFn:T,onSuccess:()=>{x.success("Pre-deal canceled"),o("/marketplace",{replace:!0})},onError:d=>{x.error(N(d,"Unable to cancel pre-deal"))}});if(u.useEffect(()=>{t.error&&x.error(N(t.error,"Unable to load pre-deal"))},[t.error]),u.useEffect(()=>{if(!t.data?.paymentExpiresAt)return;const d=window.setInterval(()=>n(Date.now()),1e3);return()=>window.clearInterval(d)},[t.data?.paymentExpiresAt]),!s)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(c,{className:"py-6",children:e.jsx(h,{message:"Pre-deal not found",description:"Return to the marketplace to choose a listing.",onRetry:()=>o("/marketplace")})})});if(t.isLoading)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(c,{className:"py-6 space-y-4",children:[e.jsx(l,{className:"h-6 w-40"}),e.jsx(l,{className:"h-4 w-64"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(l,{className:"h-36 w-full"}),e.jsx(l,{className:"h-36 w-full"}),e.jsx(l,{className:"h-36 w-full"})]})]})});if(t.isError||!t.data)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(c,{className:"py-6",children:e.jsx(h,{message:"Unable to load pre-deal",description:"We could not fetch the latest status.",onRetry:()=>t.refetch()})})});const r=t.data,A=L(r.status),E=D[r.status]??"border-border/60 bg-secondary/40 text-muted-foreground",j=r.status==="READY_FOR_PAYMENT",b=r.paymentExpiresAt?new Date(r.paymentExpiresAt):null,m=b?(b.getTime()-a)/1e3:null,f=m!=null?m>0?M(m):"Payment window expired":null;return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(c,{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Pre-deal status"}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Send your post to the bot"})]}),e.jsxs(p,{title:"Send post to bot",children:[e.jsx("p",{className:"text-sm text-foreground",children:r.botInstructions?.message??"Open the bot and send your post for review."}),r.botInstructions?.startUrl?e.jsx("button",{type:"button",onClick:()=>C(r.botInstructions?.startUrl??""),className:"w-full rounded-lg border border-border/60 bg-secondary/40 px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border",children:"Open bot"}):null]}),e.jsxs(p,{title:"Wait for approvals",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("span",{className:y("inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold",E),children:A}),e.jsx("button",{type:"button",onClick:()=>t.refetch(),className:"rounded-lg border border-border/60 bg-secondary/40 px-3 py-1.5 text-xs font-semibold text-foreground transition hover:border-border",children:"Refresh"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will keep checking for status updates every few seconds."})]}),e.jsx(p,{title:"Payment",children:j?e.jsxs("div",{className:"space-y-3",children:[f?e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Payment window: ",e.jsx("span",{className:"font-semibold text-foreground",children:f})]}):null,r.payment?.escrowAddress?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Escrow address"}),e.jsx("p",{className:"text-xs font-semibold text-foreground break-all",children:r.payment.escrowAddress})]}):null,r.payment?.expectedAmountNano?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Amount (nano)"}),e.jsx("p",{className:"text-xs font-semibold text-foreground",children:r.payment.expectedAmountNano})]}):null,e.jsx("button",{type:"button",onClick:()=>o(`/escrow/${r.id}`),className:"w-full rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground",children:"Open Mini App Payment"})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Payment details will appear once the post is approved."})}),e.jsx("button",{type:"button",onClick:()=>i.mutate({id:r.id}),disabled:i.isPending,className:"w-full rounded-lg border border-border/60 bg-background px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border disabled:opacity-60",children:i.isPending?"Canceling...":"Cancel pre-deal"})]})})}export{J as default};
