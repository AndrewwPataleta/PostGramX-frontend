import{b as j,u as I,r as u,a as x,j as e,f as A}from"./index-DJvvUNQ4.js";import{u as T}from"./useQuery-x36h40NO.js";import{u as R}from"./useMutation-BZwFb2HR.js";import{a as P,b as v}from"./predealsApi-B55tyV8y.js";import{E as N}from"./ErrorState-B3Bb-_Of.js";import{P as i}from"./PageContainer-B7AZLHYb.js";import{S as l}from"./skeleton-Dz3-cZCB.js";import{g as h}from"./errors-3kY4UU5q.js";function C(r){const o=window.Telegram?.WebApp;o?.openTelegramLink?o.openTelegramLink(r):window.open(r,"_blank","noopener,noreferrer")}const _={AWAITING_CREATIVE:"Awaiting creative",AWAITING_CONFIRMATION:"Awaiting confirmation",AWAITING_ADMIN_APPROVAL:"Awaiting admin approval",AWAITING_PAYMENT_WINDOW:"Awaiting payment window",READY_FOR_PAYMENT:"Ready for payment",REJECTED:"Rejected",EXPIRED:"Expired",CANCELED:"Canceled"},S={AWAITING_CREATIVE:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_CONFIRMATION:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_ADMIN_APPROVAL:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_PAYMENT_WINDOW:"border-border/60 bg-secondary/40 text-muted-foreground",READY_FOR_PAYMENT:"border-emerald-500/30 bg-emerald-500/15 text-emerald-200",REJECTED:"border-rose-500/30 bg-rose-500/15 text-rose-200",EXPIRED:"border-rose-500/30 bg-rose-500/15 text-rose-200",CANCELED:"border-rose-500/30 bg-rose-500/15 text-rose-200"},D=new Set(["READY_FOR_PAYMENT","REJECTED","EXPIRED","CANCELED"]),M=r=>{const o=Math.max(0,Math.floor(r)),a=Math.floor(o/3600),n=Math.floor(o%3600/60),t=o%60;return a>0?`${a}h ${n}m`:n>0?`${n}m ${t}s`:`${t}s`},k=r=>r?_[r]??r.replace(/_/g," ").toLowerCase():"Awaiting update",p=({title:r,children:o,className:a})=>e.jsxs("div",{className:A("rounded-2xl border border-border/60 bg-card/80 p-4 space-y-3",a),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground",children:"Step"}),e.jsx("h2",{className:"text-sm font-semibold text-foreground",children:r})]}),o]});function V(){const{id:r}=j(),o=I(),[a,n]=u.useState(Date.now()),t=T({queryKey:["predeal",r],queryFn:()=>v({id:r??""}),enabled:!!r,refetchInterval:d=>{const g=d.state.data?.status;return g&&D.has(g)?!1:4e3}}),c=R({mutationFn:P,onSuccess:()=>{x.success("Pre-deal canceled"),o("/marketplace",{replace:!0})},onError:d=>{x.error(h(d,"Unable to cancel pre-deal"))}});if(u.useEffect(()=>{t.error&&x.error(h(t.error,"Unable to load pre-deal"))},[t.error]),u.useEffect(()=>{if(!t.data?.paymentExpiresAt)return;const d=window.setInterval(()=>n(Date.now()),1e3);return()=>window.clearInterval(d)},[t.data?.paymentExpiresAt]),!r)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(i,{className:"py-6",children:e.jsx(N,{message:"Pre-deal not found",description:"Return to the marketplace to choose a listing.",onRetry:()=>o("/marketplace")})})});if(t.isLoading)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(i,{className:"py-6 space-y-4",children:[e.jsx(l,{className:"h-6 w-40"}),e.jsx(l,{className:"h-4 w-64"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(l,{className:"h-36 w-full"}),e.jsx(l,{className:"h-36 w-full"}),e.jsx(l,{className:"h-36 w-full"})]})]})});if(t.isError||!t.data)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(i,{className:"py-6",children:e.jsx(N,{message:"Unable to load pre-deal",description:"We could not fetch the latest status.",onRetry:()=>t.refetch()})})});const s=t.data,y=k(s.status),E=S[s.status]??"border-border/60 bg-secondary/40 text-muted-foreground",w=s.status==="READY_FOR_PAYMENT",b=s.paymentExpiresAt?new Date(s.paymentExpiresAt):null,m=b?(b.getTime()-a)/1e3:null,f=m!=null?m>0?M(m):"Payment window expired":null;return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(i,{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Pre-deal status"}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Send your post to the bot"})]}),e.jsxs(p,{title:"Send post to bot",children:[e.jsx("p",{className:"text-sm text-foreground",children:s.botInstructions?.message??"Open the bot and send your post for review."}),s.botInstructions?.startUrl?e.jsx("button",{type:"button",onClick:()=>C(s.botInstructions?.startUrl??""),className:"w-full rounded-lg border border-border/60 bg-secondary/40 px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border",children:"Open bot"}):null]}),e.jsxs(p,{title:"Wait for approvals",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("span",{className:A("inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold",E),children:y}),e.jsx("button",{type:"button",onClick:()=>t.refetch(),className:"rounded-lg border border-border/60 bg-secondary/40 px-3 py-1.5 text-xs font-semibold text-foreground transition hover:border-border",children:"Refresh"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will keep checking for status updates every few seconds."})]}),e.jsx(p,{title:"Payment",children:w?e.jsxs("div",{className:"space-y-3",children:[f?e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Payment window: ",e.jsx("span",{className:"font-semibold text-foreground",children:f})]}):null,s.payment?.escrowAddress?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Escrow address"}),e.jsx("p",{className:"text-xs font-semibold text-foreground break-all",children:s.payment.escrowAddress})]}):null,s.payment?.expectedAmountNano?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Amount (nano)"}),e.jsx("p",{className:"text-xs font-semibold text-foreground",children:s.payment.expectedAmountNano})]}):null,e.jsx("button",{type:"button",onClick:()=>o(`/escrow/${s.id}`),className:"w-full rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground",children:"Open Mini App Payment"})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Payment details will appear once the post is approved."})}),e.jsx("button",{type:"button",onClick:()=>c.mutate({id:s.id}),disabled:c.isPending,className:"w-full rounded-lg border border-border/60 bg-background px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border disabled:opacity-60",children:c.isPending?"Canceling...":"Cancel pre-deal"})]})})}export{V as default};
