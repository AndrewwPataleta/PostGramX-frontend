import{a as w,r as o,j as e,E as R,X as J,u as W,b as y,R as m,L as Z}from"./index-hL3AzeaV.js";import{C as ee,a as te}from"./ChannelListingsPreview-BQHaWymZ.js";import{u as se}from"./useInfiniteQuery-pAJdBLvE.js";import{p as ne,u as re}from"./channelsApi-CU2Ijv_1.js";import{E as ae}from"./ErrorState-CWOptztJ.js";import{R as oe,P as ie,O as le,C as de,T as ce,a as me}from"./index-BQHW44u3.js";import{S as j}from"./skeleton-DaPwmbOO.js";import{P as ue}from"./PageContainer-Cm-a9C2U.js";import{g as A}from"./errors-3kY4UU5q.js";import{C as g}from"./channels-CCH0-4EZ.js";import{P as xe}from"./plus-CEIbE5nk.js";import"./formatters-DrHNNfko.js";import"./labels-EEWNt0UM.js";import"./tagOptions-DHtvjoWf.js";import"./chevron-down-CELqZ4uK.js";import"./useQuery-84lU0rAQ.js";import"./listingsApi-CwEfaA4O.js";import"./Combination-BTwFOyC8.js";function pe({channel:t,placementsCount:r,minPriceNano:n,tags:a,onClick:l,onToggleExpand:d,isExpanded:b,expandedContent:h,onUnlink:N,createListingTo:C,createListingState:E}){const{t:u}=w(),v=o.useMemo(()=>({id:t.id,name:t.title||u("channels.untitled"),username:t.username,avatarUrl:t.avatarUrl??null,subscribers:t.memberCount??null,placementsCount:r??t.placementsCount??null,minPriceNano:n??null,tags:a??[],isMine:!0}),[t,r,n,a,u]);return e.jsx(ee,{channel:v,onClick:l,isExpanded:b,onToggleExpand:d,expandedContent:h,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[N?e.jsx("button",{type:"button",onClick:x=>{x.stopPropagation(),N()},className:"inline-flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground","aria-label":u("channels.unlinkAction"),children:u("common.closeSymbol")}):null,e.jsx(R,{to:C,state:E,onClick:x=>x.stopPropagation(),className:"rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-primary-foreground",children:u("listings.createAction")})]})})}const ge=t=>["channelsList",t],fe=(t,r=10)=>se({queryKey:ge(t),queryFn:({pageParam:n=1})=>ne({...t,page:Number(n),limit:r}),getNextPageParam:n=>n.hasNext?n.page+1:void 0,initialPageParam:1});function be({open:t,onOpenChange:r,title:n,children:a}){return e.jsx(oe,{open:t,onOpenChange:r,children:e.jsxs(ie,{children:[e.jsx(le,{className:"fixed inset-0 z-40 bg-black/60"}),e.jsxs(de,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx(ce,{className:"text-sm font-semibold text-foreground",children:n}),e.jsx(me,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:e.jsx(J,{size:16})})]}),e.jsx("div",{className:"pt-2",children:a})]})]})})}const he="recent",Ne="desc",ye=[g.DRAFT,g.PENDING_VERIFY,g.FAILED,g.REVOKED],je=()=>e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"h-4 w-32"}),e.jsx(j,{className:"h-3 w-20"})]}),e.jsx(j,{className:"h-5 w-24 rounded-full"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(j,{className:"h-16 rounded-xl"})})]}),Ce=t=>{if(!t)return null;const r=t.filter(a=>a.isActive!==!1),n=r.reduce((a,l)=>{try{const d=BigInt(l.priceNano);return a===null||d<a?d:a}catch{return a}},null);return{placementsCount:r.length,minPriceNano:n?n.toString():null}},Ee=t=>{if(!t?.length)return[];const r=t.flatMap(n=>n.tags??[]);return Array.from(new Set(r.map(n=>n.trim()).filter(Boolean)))};function Oe(){const{t}=w(),[r,n]=o.useState("verified"),[a,l]=o.useState(null),[d,b]=o.useState(!1),[h,N]=o.useState(()=>new Set),[C,E]=o.useState(()=>new Set),[u,v]=o.useState({}),x=W(),_=o.useMemo(()=>({sort:he,order:Ne,includeListings:!0}),[]),{data:S,isLoading:D,isFetchingNextPage:k,fetchNextPage:M,hasNextPage:F,refetch:U,error:f}=fe(_,10),L=o.useMemo(()=>S?.pages.flatMap(s=>s.items)??[],[S]),p=o.useMemo(()=>L.filter(s=>!h.has(s.id)),[L,h]),H=S?.pages?.[0]?.total??0;o.useEffect(()=>{f&&y.error(A(f,t("channels.loadError")))},[f,t]);const B=o.useMemo(()=>p.filter(s=>s.status===g.VERIFIED),[p]),G=o.useMemo(()=>p.filter(s=>ye.includes(s.status)),[p]),P=r==="verified"?B:G,O=t(r==="pending"?"channels.emptyPending":"channels.emptyVerified"),z=s=>{if(s.status===g.PENDING_VERIFY){x(m.CHANNEL_PENDING(s.id),{state:{channel:s,rootBackTo:m.CHANNELS}});return}x(m.CHANNEL_MANAGE_LISTINGS(s.id),{state:{channel:s,rootBackTo:m.CHANNELS}})},V=o.useCallback(s=>{E(c=>{const i=new Set(c);return i.has(s)?i.delete(s):i.add(s),i})},[]),K=async()=>{if(a){b(!0);try{const s=await re({channelId:a.id});s.unlinked?(N(c=>{const i=new Set(c);return i.add(s.channelId),i}),y.success(t("channels.unlinkSuccess"))):y.error(t("channels.unlinkError")),l(null)}catch(s){y.error(A(s,t("channels.unlinkError")))}finally{b(!1)}}};return e.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col",children:[e.jsxs(ue,{className:"pt-4 space-y-6",children:[D?e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,c)=>e.jsx(je,{},`channel-skeleton-${c}`))}):f?e.jsx(ae,{message:A(f,t("channels.loadError")),description:t("errors.genericSubtitle"),onRetry:()=>U()}):p.length===0?e.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:t("channels.emptyIcon")}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t("channels.emptyTitle")}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t("channels.emptySubtitle")}),e.jsx(R,{to:m.ADD_CHANNEL_STEP("step-1"),className:"mt-4 inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:t("channels.addAction")})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border-t border-border/50",children:e.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(s=>e.jsx("button",{onClick:()=>n(s),className:`py-3 text-sm font-medium border-b-2 transition-colors ${r===s?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:t(s==="verified"?"channels.tabs.verified":"channels.tabs.pending")},s))})}),P.length>0?e.jsx("div",{className:"space-y-3",children:P.map(s=>{const c=C.has(s.id),i=s.status===g.VERIFIED,T=Ce(s.listings),I=u[s.id],q=T?.placementsCount??I?.placementsCount??null,Y=T?.minPriceNano??I?.minPriceNano??null,$=Ee(s.listings);return e.jsx(pe,{channel:s,placementsCount:q,minPriceNano:Y,tags:$,onClick:()=>z(s),onUnlink:r==="pending"?()=>{l(s)}:void 0,isExpanded:c,onToggleExpand:i?()=>V(s.id):void 0,expandedContent:i?e.jsx(te,{channelId:s.id,isExpanded:c,onSummaryChange:Q=>{v(X=>({...X,[s.id]:Q}))}}):null,createListingTo:m.CHANNEL_MANAGE_LISTINGS_CREATE(s.id),createListingState:{channel:s,rootBackTo:m.CHANNELS}},s.id)})}):e.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:O})]}),p.length>0?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:t("channels.showingCount",{visible:p.length,total:H})}),F?e.jsxs("button",{type:"button",onClick:()=>M(),disabled:k,className:"inline-flex items-center gap-2 rounded-lg border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[k?e.jsx(Z,{size:14,className:"animate-spin"}):null,t(k?"common.loading":"common.loadMore")]}):null]}):null]}),e.jsx("button",{type:"button",onClick:()=>x(m.ADD_CHANNEL_STEP("step-1")),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":t("channels.addAction"),children:e.jsx(xe,{size:18})}),e.jsxs(be,{open:!!a,onOpenChange:s=>{s||l(null)},title:t("channels.unlinkTitle"),children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t("channels.unlinkPrompt")," ",e.jsxs("span",{className:"font-semibold text-foreground",children:["@",a?.username]}),"?"]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>l(null),className:"flex-1 rounded-lg border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:d,children:t("common.cancel")}),e.jsx("button",{type:"button",onClick:K,className:"flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:d,children:t(d?"channels.unlinking":"channels.unlinkAction")})]})]})]})}export{Oe as default};
