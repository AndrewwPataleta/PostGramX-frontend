import{a as L,r as o,j as e,B as T,X,u as H,b,L as J}from"./index-B45srucX.js";import{C as W,a as Z}from"./ChannelListingsPreview-Db3XIZET.js";import{u as ee}from"./useInfiniteQuery-DS1OEUAO.js";import{p as te,u as se}from"./channelsApi-CL4tbAVD.js";import{E as ne}from"./ErrorState-UzKZVMk-.js";import{R as re,P as ae,O as oe,C as ie,T as le,a as de}from"./index-CEzqM8RR.js";import{S as y}from"./skeleton-CCwIBs6D.js";import{P as ce}from"./PageContainer-D0X7YvfC.js";import{g as E}from"./errors-3kY4UU5q.js";import{P as me}from"./plus-CWzhQf6i.js";import"./formatters-DrHNNfko.js";import"./labels-EEWNt0UM.js";import"./tagOptions-DHtvjoWf.js";import"./chevron-down-Bt3UPbR-.js";import"./useQuery-C1-N9N0A.js";import"./listingsApi-BCDpDDiw.js";import"./Combination-Bjt3g5VO.js";function ue({channel:t,placementsCount:r,minPriceNano:n,tags:a,onClick:l,onToggleExpand:d,isExpanded:g,expandedContent:h,onUnlink:f,createListingTo:j,createListingState:N}){const{t:m}=L(),C=o.useMemo(()=>({id:t.id,name:t.title||m("channels.untitled"),username:t.username,avatarUrl:t.avatarUrl??null,subscribers:t.memberCount??null,placementsCount:r??t.placementsCount??null,minPriceNano:n??null,tags:a??[],isMine:!0}),[t,r,n,a,m]);return e.jsx(W,{channel:C,onClick:l,isExpanded:g,onToggleExpand:d,expandedContent:h,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[f?e.jsx("button",{type:"button",onClick:u=>{u.stopPropagation(),f()},className:"inline-flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground","aria-label":m("channels.unlinkAction"),children:m("common.closeSymbol")}):null,e.jsx(T,{to:j,state:N,onClick:u=>u.stopPropagation(),className:"rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-primary-foreground",children:m("listings.createAction")})]})})}const xe=t=>["channelsList",t],pe=(t,r=10)=>ee({queryKey:xe(t),queryFn:({pageParam:n=1})=>te({...t,page:Number(n),limit:r}),getNextPageParam:n=>n.hasNext?n.page+1:void 0,initialPageParam:1});function ge({open:t,onOpenChange:r,title:n,children:a}){return e.jsx(re,{open:t,onOpenChange:r,children:e.jsxs(ae,{children:[e.jsx(oe,{className:"fixed inset-0 z-40 bg-black/60"}),e.jsxs(ie,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx(le,{className:"text-sm font-semibold text-foreground",children:n}),e.jsx(de,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:e.jsx(X,{size:16})})]}),e.jsx("div",{className:"pt-2",children:a})]})]})})}const he="recent",fe="desc",be=["DRAFT","PENDING_VERIFY","FAILED","REVOKED"],ye=()=>e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"h-4 w-32"}),e.jsx(y,{className:"h-3 w-20"})]}),e.jsx(y,{className:"h-5 w-24 rounded-full"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(y,{className:"h-16 rounded-xl"})})]}),je=t=>{if(!t)return null;const r=t.filter(a=>a.isActive!==!1),n=r.reduce((a,l)=>{try{const d=BigInt(l.priceNano);return a===null||d<a?d:a}catch{return a}},null);return{placementsCount:r.length,minPriceNano:n?n.toString():null}},Ne=t=>{if(!t?.length)return[];const r=t.flatMap(n=>n.tags??[]);return Array.from(new Set(r.map(n=>n.trim()).filter(Boolean)))};function ze(){const{t}=L(),[r,n]=o.useState("verified"),[a,l]=o.useState(null),[d,g]=o.useState(!1),[h,f]=o.useState(()=>new Set),[j,N]=o.useState(()=>new Set),[m,C]=o.useState({}),u=H(),A=o.useMemo(()=>({sort:he,order:fe,includeListings:!0}),[]),{data:v,isLoading:R,isFetchingNextPage:k,fetchNextPage:D,hasNextPage:F,refetch:M,error:p}=pe(A,10),S=o.useMemo(()=>v?.pages.flatMap(s=>s.items)??[],[v]),x=o.useMemo(()=>S.filter(s=>!h.has(s.id)),[S,h]),B=v?.pages?.[0]?.total??0;o.useEffect(()=>{p&&b.error(E(p,t("channels.loadError")))},[p,t]);const U=o.useMemo(()=>x.filter(s=>s.status==="VERIFIED"),[x]),z=o.useMemo(()=>x.filter(s=>be.includes(s.status)),[x]),P=r==="verified"?U:z,O=t(r==="pending"?"channels.emptyPending":"channels.emptyVerified"),V=s=>{if(s.status==="PENDING_VERIFY"){u(`/channels/pending/${s.id}`,{state:{channel:s,rootBackTo:"/channels"}});return}u(`/channel-manage/${s.id}/listings`,{state:{channel:s,rootBackTo:"/channels"}})},_=o.useCallback(s=>{N(c=>{const i=new Set(c);return i.has(s)?i.delete(s):i.add(s),i})},[]),$=async()=>{if(a){g(!0);try{const s=await se({channelId:a.id});s.unlinked?(f(c=>{const i=new Set(c);return i.add(s.channelId),i}),b.success(t("channels.unlinkSuccess"))):b.error(t("channels.unlinkError")),l(null)}catch(s){b.error(E(s,t("channels.unlinkError")))}finally{g(!1)}}};return e.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col",children:[e.jsxs(ce,{className:"pt-4 space-y-6",children:[R?e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,c)=>e.jsx(ye,{},`channel-skeleton-${c}`))}):p?e.jsx(ne,{message:E(p,t("channels.loadError")),description:t("errors.genericSubtitle"),onRetry:()=>M()}):x.length===0?e.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:t("channels.emptyIcon")}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t("channels.emptyTitle")}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t("channels.emptySubtitle")}),e.jsx(T,{to:"/add-channel/step-1",className:"mt-4 inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:t("channels.addAction")})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border-t border-border/50",children:e.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(s=>e.jsx("button",{onClick:()=>n(s),className:`py-3 text-sm font-medium border-b-2 transition-colors ${r===s?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:t(s==="verified"?"channels.tabs.verified":"channels.tabs.pending")},s))})}),P.length>0?e.jsx("div",{className:"space-y-3",children:P.map(s=>{const c=j.has(s.id),i=s.status==="VERIFIED",w=je(s.listings),I=m[s.id],K=w?.placementsCount??I?.placementsCount??null,q=w?.minPriceNano??I?.minPriceNano??null,G=Ne(s.listings);return e.jsx(ue,{channel:s,placementsCount:K,minPriceNano:q,tags:G,onClick:()=>V(s),onUnlink:r==="pending"?()=>{l(s)}:void 0,isExpanded:c,onToggleExpand:i?()=>_(s.id):void 0,expandedContent:i?e.jsx(Z,{channelId:s.id,isExpanded:c,onSummaryChange:Y=>{C(Q=>({...Q,[s.id]:Y}))}}):null,createListingTo:`/channel-manage/${s.id}/listings/create`,createListingState:{channel:s,rootBackTo:"/channels"}},s.id)})}):e.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:O})]}),x.length>0?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:t("channels.showingCount",{visible:x.length,total:B})}),F?e.jsxs("button",{type:"button",onClick:()=>D(),disabled:k,className:"inline-flex items-center gap-2 rounded-lg border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[k?e.jsx(J,{size:14,className:"animate-spin"}):null,t(k?"common.loading":"common.loadMore")]}):null]}):null]}),e.jsx("button",{type:"button",onClick:()=>u("/add-channel/step-1"),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":t("channels.addAction"),children:e.jsx(me,{size:18})}),e.jsxs(ge,{open:!!a,onOpenChange:s=>{s||l(null)},title:t("channels.unlinkTitle"),children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t("channels.unlinkPrompt")," ",e.jsxs("span",{className:"font-semibold text-foreground",children:["@",a?.username]}),"?"]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>l(null),className:"flex-1 rounded-lg border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:d,children:t("common.cancel")}),e.jsx("button",{type:"button",onClick:$,className:"flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:d,children:t(d?"channels.unlinking":"channels.unlinkAction")})]})]})]})}export{ze as default};
