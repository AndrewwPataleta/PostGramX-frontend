import{i as T,k as J,l as Z,c as M,r as i,j as e,h as k,d as ee,f as te,X as se,u as re,a as v,L as ne}from"./index-Dr4_lYQJ.js";import{C as ae}from"./ChannelCard-DT2RE6xk.js";import{Q as oe,a as ie,u as de}from"./useQuery-BMJBMXFl.js";import{l as le}from"./listingsApi-mpkPTBZA.js";import{S as N}from"./skeleton-2bL8VXrV.js";import{g as j}from"./errors-3kY4UU5q.js";import{p as ce,u as ue}from"./channelsApi-C2QDPJ_j.js";import{E as me}from"./ErrorState-DYOCWQkA.js";import{R as xe,P as ge,O as he,C as pe,T as fe,a as be}from"./index-DBjWLfad.js";import{P as Ne}from"./PageContainer-Ce9-XKt_.js";import{P as ye}from"./plus-fjvXOqIT.js";import"./ton-ClBVV2oW.js";import"./chevron-down-D7ZVjZnw.js";var ve=class extends oe{constructor(t,r){super(t,r)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t){super.setOptions({...t,behavior:T()})}getOptimisticResult(t){return t.behavior=T(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,r){const{state:n}=t,o=super.createResult(t,r),{isFetching:l,isRefetching:a,isError:d,isRefetchError:h}=o,x=n.fetchMeta?.fetchMore?.direction,c=d&&x==="forward",u=l&&x==="forward",p=d&&x==="backward",m=l&&x==="backward";return{...o,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:Z(r,n.data),hasPreviousPage:J(r,n.data),isFetchNextPageError:c,isFetchingNextPage:u,isFetchPreviousPageError:p,isFetchingPreviousPage:m,isRefetchError:h&&!c&&!p,isRefetching:a&&!u&&!m}}};function je(t,r){return ie(t,ve)}/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],Pe=M("pencil-line",Ce);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]],we=M("refresh-ccw",ke);function Ee({channel:t,placementsCount:r,minPriceNano:n,tags:o,onClick:l,onToggleExpand:a,isExpanded:d,expandedContent:h,onUnlink:x,createListingTo:c,createListingState:u}){const p=i.useMemo(()=>({id:t.id,name:t.title||"Untitled channel",username:t.username,avatarUrl:t.avatarUrl??null,subscribers:t.memberCount??null,placementsCount:r??t.placementsCount??null,minPriceNano:n??null,tags:o??[],isMine:!0}),[t,r,n,o]);return e.jsx(ae,{channel:p,onClick:l,isExpanded:d,onToggleExpand:a,expandedContent:h,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[x?e.jsx("button",{type:"button",onClick:m=>{m.stopPropagation(),x()},className:"inline-flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground","aria-label":"Unlink channel",children:"√ó"}):null,e.jsx(k,{to:c,state:u,onClick:m=>m.stopPropagation(),className:"rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-primary-foreground",children:"Create listing"})]})})}const Le=5,Se=3,I=1000000000n,Re=t=>{try{const r=BigInt(t),n=r/I,o=r%I;if(o===0n)return`${n.toString()} TON`;const a=o.toString().padStart(9,"0").slice(0,2).replace(/0+$/,"");return`${a?`${n.toString()}.${a}`:n.toString()} TON`}catch{return`${t} TON`}},Te=t=>{const r=t.slice(0,2),n=t.length-r.length;return{shown:r,remaining:n}},A=i.memo(({channelId:t,listing:r,rootBackTo:n})=>{const o=r.pinDurationHours?`Pinned ${r.pinDurationHours}h`:"No pin",l=`Visible ${r.visibilityDurationHours}h`,a=Te(r.tags??[]);return e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsxs("div",{className:"flex flex-col items-start gap-1",children:[e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5 text-[10px] font-semibold text-muted-foreground",children:r.format}),e.jsx("span",{className:te("rounded-full border px-2 py-0.5 text-[10px] font-semibold",r.isActive?"border-emerald-500/40 bg-emerald-500/15 text-emerald-200":"border-muted-foreground/30 bg-muted/40 text-muted-foreground"),children:r.isActive?"Active":"Inactive"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:Re(r.priceNano)}),e.jsxs("div",{className:"mt-1 text-[11px] text-muted-foreground",children:[o," ‚Ä¢ ",l]}),a.shown.length>0?e.jsxs("div",{className:"mt-2 flex flex-wrap gap-1",children:[a.shown.map(d=>e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/30 px-2 py-0.5 text-[10px] text-muted-foreground",children:d},d)),a.remaining>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-muted/30 px-2 py-0.5 text-[10px] text-muted-foreground",children:["+",a.remaining]}):null]}):null]}),e.jsx(k,{to:`/channel-manage/${t}/listings/${r.id}/edit`,state:n?{rootBackTo:n}:void 0,className:"flex h-9 w-9 items-center justify-center rounded-lg border border-border/60 bg-background text-muted-foreground transition hover:text-foreground","aria-label":"Edit listing",children:e.jsx(Pe,{size:14})})]})});A.displayName="ListingPreviewRow";const O=i.memo(({channelId:t,isExpanded:r,onSummaryChange:n})=>{const l=ee().state?.rootBackTo,a=de({queryKey:["channelListingsPreview",t],queryFn:()=>le({channelId:t,page:1,limit:Le,onlyActive:!0,sort:"recent"}),enabled:r,staleTime:1e3*60*5}),d=a.data?.items??[],h=a.data?.total??d.length;i.useEffect(()=>{if(!a.data)return;const c=d.reduce((u,p)=>{try{const m=BigInt(p.priceNano);return u===null||m<u?m:u}catch{return u}},null);n?.({placementsCount:h,minPriceNano:c?c.toString():null})},[d,n,a.data,h]);const x=i.useMemo(()=>d.slice(0,Se),[d]);return e.jsx("div",{className:"space-y-3",children:a.isLoading?e.jsx("div",{className:"space-y-2",children:Array.from({length:2}).map((c,u)=>e.jsxs("div",{className:"rounded-xl border border-border/50 bg-background/60 px-3 py-3",children:[e.jsx(N,{className:"h-4 w-24"}),e.jsx(N,{className:"mt-2 h-3 w-40"}),e.jsx(N,{className:"mt-2 h-3 w-28"})]},`listing-skeleton-${u}`))}):a.isError?e.jsxs("div",{className:"rounded-xl border border-border/60 bg-red-500/5 px-4 py-3 text-xs text-red-200",children:[e.jsx("p",{children:j(a.error,"Unable to load placements.")}),e.jsxs("button",{type:"button",onClick:()=>a.refetch(),className:"mt-2 inline-flex items-center gap-2 rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-1 text-[11px] font-semibold text-red-200",children:[e.jsx(we,{size:12}),"Retry"]})]}):x.length>0?e.jsx("div",{className:"rounded-xl border border-border/60 bg-background/60 px-3 divide-y divide-border/40",children:x.map(c=>e.jsx(A,{channelId:t,listing:c,rootBackTo:l},c.id))}):e.jsxs("div",{className:"rounded-xl border border-dashed border-border/60 bg-background/50 px-4 py-4 text-center",children:[e.jsx("p",{className:"text-xs font-semibold text-foreground",children:"No placements yet"}),e.jsx("p",{className:"mt-1 text-[11px] text-muted-foreground",children:"Create your first listing to start earning."})]})})});O.displayName="ChannelListingsPreview";const Ie=t=>["channelsList",t],Me=(t,r=10)=>je({queryKey:Ie(t),queryFn:({pageParam:n=1})=>ce({...t,page:Number(n),limit:r}),getNextPageParam:n=>n.hasNext?n.page+1:void 0,initialPageParam:1});function Ae({open:t,onOpenChange:r,title:n,children:o}){return e.jsx(xe,{open:t,onOpenChange:r,children:e.jsxs(ge,{children:[e.jsx(he,{className:"fixed inset-0 z-40 bg-black/60"}),e.jsxs(pe,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx(fe,{className:"text-sm font-semibold text-foreground",children:n}),e.jsx(be,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:e.jsx(se,{size:16})})]}),e.jsx("div",{className:"pt-2",children:o})]})]})})}const Oe="recent",Ue="desc",$e=["DRAFT","PENDING_VERIFY","FAILED","REVOKED"],Fe=()=>e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"h-4 w-32"}),e.jsx(N,{className:"h-3 w-20"})]}),e.jsx(N,{className:"h-5 w-24 rounded-full"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(N,{className:"h-16 rounded-xl"})})]}),De=t=>{if(!t)return null;const r=t.filter(o=>o.isActive!==!1),n=r.reduce((o,l)=>{try{const a=BigInt(l.priceNano);return o===null||a<o?a:o}catch{return o}},null);return{placementsCount:r.length,minPriceNano:n?n.toString():null}},Be=t=>{if(!t?.length)return[];const r=t.flatMap(n=>n.tags??[]);return Array.from(new Set(r.map(n=>n.trim()).filter(Boolean)))};function et(){const[t,r]=i.useState("verified"),[n,o]=i.useState(null),[l,a]=i.useState(!1),[d,h]=i.useState(()=>new Set),[x,c]=i.useState(()=>new Set),[u,p]=i.useState({}),m=re(),w=i.useMemo(()=>({sort:Oe,order:Ue,includeListings:!0}),[]),{data:C,isLoading:U,isFetchingNextPage:P,fetchNextPage:$,hasNextPage:F,refetch:D,error:y}=Me(w,10),E=i.useMemo(()=>C?.pages.flatMap(s=>s.items)??[],[C]),b=i.useMemo(()=>E.filter(s=>!d.has(s.id)),[E,d]),B=C?.pages?.[0]?.total??0;i.useEffect(()=>{y&&v.error(j(y,"Unable to load channels."))},[y]);const _=i.useMemo(()=>b.filter(s=>s.status==="VERIFIED"),[b]),z=i.useMemo(()=>b.filter(s=>$e.includes(s.status)),[b]),L=t==="verified"?_:z,V=t==="pending"?"No pending channels right now.":"No verified channels yet.",Q=s=>{if(s.status==="PENDING_VERIFY"){m(`/channels/pending/${s.id}`,{state:{channel:s,rootBackTo:"/channels"}});return}m(`/channel-manage/${s.id}/listings`,{state:{channel:s,rootBackTo:"/channels"}})},q=i.useCallback(s=>{c(f=>{const g=new Set(f);return g.has(s)?g.delete(s):g.add(s),g})},[]),K=async()=>{if(n){a(!0);try{const s=await ue({channelId:n.id});s.unlinked?(h(f=>{const g=new Set(f);return g.add(s.channelId),g}),v.success("Channel unlinked.")):v.error("Unable to unlink channel."),o(null)}catch(s){v.error(j(s,"Unable to unlink channel."))}finally{a(!1)}}};return e.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col",children:[e.jsxs(Ne,{className:"pt-4 space-y-6",children:[U?e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,f)=>e.jsx(Fe,{},`channel-skeleton-${f}`))}):y?e.jsx(me,{message:j(y,"Unable to load channels"),description:"Please try again in a moment.",onRetry:()=>D()}):b.length===0?e.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:"üì°"}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"No channels yet"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Connect your first Telegram channel to get started."}),e.jsx(k,{to:"/add-channel/step-1",className:"mt-4 inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:"Add Channel"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border-t border-border/50",children:e.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(s=>e.jsxs("button",{onClick:()=>r(s),className:`py-3 text-sm font-medium border-b-2 transition-colors ${t===s?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:[s.charAt(0).toUpperCase()+s.slice(1)," "]},s))})}),L.length>0?e.jsx("div",{className:"space-y-3",children:L.map(s=>{const f=x.has(s.id),g=s.status==="VERIFIED",S=De(s.listings),R=u[s.id],H=S?.placementsCount??R?.placementsCount??null,G=S?.minPriceNano??R?.minPriceNano??null,W=Be(s.listings);return e.jsx(Ee,{channel:s,placementsCount:H,minPriceNano:G,tags:W,onClick:()=>Q(s),onUnlink:t==="pending"?()=>{o(s)}:void 0,isExpanded:f,onToggleExpand:g?()=>q(s.id):void 0,expandedContent:g?e.jsx(O,{channelId:s.id,isExpanded:f,onSummaryChange:Y=>{p(X=>({...X,[s.id]:Y}))}}):null,createListingTo:`/channel-manage/${s.id}/listings/create`,createListingState:{channel:s,rootBackTo:"/channels"}},s.id)})}):e.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:V})]}),b.length>0?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Showing ",b.length," of ",B]}),F?e.jsxs("button",{type:"button",onClick:()=>$(),disabled:P,className:"inline-flex items-center gap-2 rounded-lg border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[P?e.jsx(ne,{size:14,className:"animate-spin"}):null,P?"Loading":"Load more"]}):null]}):null]}),e.jsx("button",{type:"button",onClick:()=>m("/add-channel/step-1"),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":"Add channel",children:e.jsx(ye,{size:18})}),e.jsxs(Ae,{open:!!n,onOpenChange:s=>{s||o(null)},title:"–û—Ç–∫—Ä–µ–ø–∏—Ç—å –∫–∞–Ω–∞–ª?",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["–í—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä–µ–ø–∏—Ç—å –∫–∞–Ω–∞–ª"," ",e.jsxs("span",{className:"font-semibold text-foreground",children:["@",n?.username]}),"?"]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>o(null),className:"flex-1 rounded-lg border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:l,children:"–û—Ç–º–µ–Ω–∞"}),e.jsx("button",{type:"button",onClick:K,className:"flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:l,children:l?"–û—Ç–∫—Ä–µ–ø–ª—è–µ–º...":"–û—Ç–∫—Ä–µ–ø–∏—Ç—å"})]})]})]})}export{et as default};
