import{i as L,k as Y,l as X,r as i,j as e,h as I,X as H,u as J,a as y,L as W}from"./index-Bdaoqcb2.js";import{C as Z,a as ee}from"./ChannelListingsPreview-DfbL1B9R.js";import{Q as te,a as se}from"./useQuery-2L_VsJWv.js";import{p as ne,u as re}from"./channelsApi-DZ-26NzA.js";import{E as ae}from"./ErrorState-CNKN_qb3.js";import{R as ie,P as oe,O as le,C as de,T as ce,a as ue}from"./index-Du07o9oi.js";import{S as v}from"./skeleton-DJrZWN2d.js";import{P as me}from"./PageContainer-DKM49Rqo.js";import{g as P}from"./errors-3kY4UU5q.js";import{P as xe}from"./plus-BtnPTBvr.js";import"./ton-ClBVV2oW.js";import"./chevron-down-BKx8j01m.js";import"./listingsApi-DpecpDDp.js";var ge=class extends te{constructor(s,r){super(s,r)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(s){super.setOptions({...s,behavior:L()})}getOptimisticResult(s){return s.behavior=L(),super.getOptimisticResult(s)}fetchNextPage(s){return this.fetch({...s,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(s){return this.fetch({...s,meta:{fetchMore:{direction:"backward"}}})}createResult(s,r){const{state:n}=s,a=super.createResult(s,r),{isFetching:o,isRefetching:c,isError:x,isRefetchError:b}=a,u=n.fetchMeta?.fetchMore?.direction,h=x&&u==="forward",f=o&&u==="forward",p=x&&u==="backward",l=o&&u==="backward";return{...a,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:X(r,n.data),hasPreviousPage:Y(r,n.data),isFetchNextPageError:h,isFetchingNextPage:f,isFetchPreviousPageError:p,isFetchingPreviousPage:l,isRefetchError:b&&!h&&!p,isRefetching:c&&!f&&!l}}};function he(s,r){return se(s,ge)}function fe({channel:s,placementsCount:r,minPriceNano:n,tags:a,onClick:o,onToggleExpand:c,isExpanded:x,expandedContent:b,onUnlink:u,createListingTo:h,createListingState:f}){const p=i.useMemo(()=>({id:s.id,name:s.title||"Untitled channel",username:s.username,avatarUrl:s.avatarUrl??null,subscribers:s.memberCount??null,placementsCount:r??s.placementsCount??null,minPriceNano:n??null,tags:a??[],isMine:!0}),[s,r,n,a]);return e.jsx(Z,{channel:p,onClick:o,isExpanded:x,onToggleExpand:c,expandedContent:b,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[u?e.jsx("button",{type:"button",onClick:l=>{l.stopPropagation(),u()},className:"inline-flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground","aria-label":"Unlink channel",children:"√ó"}):null,e.jsx(I,{to:h,state:f,onClick:l=>l.stopPropagation(),className:"rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-primary-foreground",children:"Create listing"})]})})}const pe=s=>["channelsList",s],be=(s,r=10)=>he({queryKey:pe(s),queryFn:({pageParam:n=1})=>ne({...s,page:Number(n),limit:r}),getNextPageParam:n=>n.hasNext?n.page+1:void 0,initialPageParam:1});function Ne({open:s,onOpenChange:r,title:n,children:a}){return e.jsx(ie,{open:s,onOpenChange:r,children:e.jsxs(oe,{children:[e.jsx(le,{className:"fixed inset-0 z-40 bg-black/60"}),e.jsxs(de,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx(ce,{className:"text-sm font-semibold text-foreground",children:n}),e.jsx(ue,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:e.jsx(H,{size:16})})]}),e.jsx("div",{className:"pt-2",children:a})]})]})})}const ye="recent",ve="desc",je=["DRAFT","PENDING_VERIFY","FAILED","REVOKED"],Ce=()=>e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"h-4 w-32"}),e.jsx(v,{className:"h-3 w-20"})]}),e.jsx(v,{className:"h-5 w-24 rounded-full"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(v,{className:"h-16 rounded-xl"})})]}),Pe=s=>{if(!s)return null;const r=s.filter(a=>a.isActive!==!1),n=r.reduce((a,o)=>{try{const c=BigInt(o.priceNano);return a===null||c<a?c:a}catch{return a}},null);return{placementsCount:r.length,minPriceNano:n?n.toString():null}},ke=s=>{if(!s?.length)return[];const r=s.flatMap(n=>n.tags??[]);return Array.from(new Set(r.map(n=>n.trim()).filter(Boolean)))};function Be(){const[s,r]=i.useState("verified"),[n,a]=i.useState(null),[o,c]=i.useState(!1),[x,b]=i.useState(()=>new Set),[u,h]=i.useState(()=>new Set),[f,p]=i.useState({}),l=J(),k=i.useMemo(()=>({sort:ye,order:ve,includeListings:!0}),[]),{data:j,isLoading:T,isFetchingNextPage:C,fetchNextPage:F,hasNextPage:M,refetch:U,error:N}=be(k,10),E=i.useMemo(()=>j?.pages.flatMap(t=>t.items)??[],[j]),g=i.useMemo(()=>E.filter(t=>!x.has(t.id)),[E,x]),A=j?.pages?.[0]?.total??0;i.useEffect(()=>{N&&y.error(P(N,"Unable to load channels."))},[N]);const O=i.useMemo(()=>g.filter(t=>t.status==="VERIFIED"),[g]),D=i.useMemo(()=>g.filter(t=>je.includes(t.status)),[g]),w=s==="verified"?O:D,B=s==="pending"?"No pending channels right now.":"No verified channels yet.",z=t=>{if(t.status==="PENDING_VERIFY"){l(`/channels/pending/${t.id}`,{state:{channel:t,rootBackTo:"/channels"}});return}l(`/channel-manage/${t.id}/listings`,{state:{channel:t,rootBackTo:"/channels"}})},Q=i.useCallback(t=>{h(m=>{const d=new Set(m);return d.has(t)?d.delete(t):d.add(t),d})},[]),V=async()=>{if(n){c(!0);try{const t=await re({channelId:n.id});t.unlinked?(b(m=>{const d=new Set(m);return d.add(t.channelId),d}),y.success("Channel unlinked.")):y.error("Unable to unlink channel."),a(null)}catch(t){y.error(P(t,"Unable to unlink channel."))}finally{c(!1)}}};return e.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col",children:[e.jsxs(me,{className:"pt-4 space-y-6",children:[T?e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((t,m)=>e.jsx(Ce,{},`channel-skeleton-${m}`))}):N?e.jsx(ae,{message:P(N,"Unable to load channels"),description:"Please try again in a moment.",onRetry:()=>U()}):g.length===0?e.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:"üì°"}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"No channels yet"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Connect your first Telegram channel to get started."}),e.jsx(I,{to:"/add-channel/step-1",className:"mt-4 inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:"Add Channel"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border-t border-border/50",children:e.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(t=>e.jsxs("button",{onClick:()=>r(t),className:`py-3 text-sm font-medium border-b-2 transition-colors ${s===t?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:[t.charAt(0).toUpperCase()+t.slice(1)," "]},t))})}),w.length>0?e.jsx("div",{className:"space-y-3",children:w.map(t=>{const m=u.has(t.id),d=t.status==="VERIFIED",S=Pe(t.listings),R=f[t.id],_=S?.placementsCount??R?.placementsCount??null,$=S?.minPriceNano??R?.minPriceNano??null,K=ke(t.listings);return e.jsx(fe,{channel:t,placementsCount:_,minPriceNano:$,tags:K,onClick:()=>z(t),onUnlink:s==="pending"?()=>{a(t)}:void 0,isExpanded:m,onToggleExpand:d?()=>Q(t.id):void 0,expandedContent:d?e.jsx(ee,{channelId:t.id,isExpanded:m,onSummaryChange:q=>{p(G=>({...G,[t.id]:q}))}}):null,createListingTo:`/channel-manage/${t.id}/listings/create`,createListingState:{channel:t,rootBackTo:"/channels"}},t.id)})}):e.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:B})]}),g.length>0?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Showing ",g.length," of ",A]}),M?e.jsxs("button",{type:"button",onClick:()=>F(),disabled:C,className:"inline-flex items-center gap-2 rounded-lg border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[C?e.jsx(W,{size:14,className:"animate-spin"}):null,C?"Loading":"Load more"]}):null]}):null]}),e.jsx("button",{type:"button",onClick:()=>l("/add-channel/step-1"),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":"Add channel",children:e.jsx(xe,{size:18})}),e.jsxs(Ne,{open:!!n,onOpenChange:t=>{t||a(null)},title:"–û—Ç–∫—Ä–µ–ø–∏—Ç—å –∫–∞–Ω–∞–ª?",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["–í—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä–µ–ø–∏—Ç—å –∫–∞–Ω–∞–ª"," ",e.jsxs("span",{className:"font-semibold text-foreground",children:["@",n?.username]}),"?"]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>a(null),className:"flex-1 rounded-lg border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:o,children:"–û—Ç–º–µ–Ω–∞"}),e.jsx("button",{type:"button",onClick:V,className:"flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:o,children:o?"–û—Ç–∫—Ä–µ–ø–ª—è–µ–º...":"–û—Ç–∫—Ä–µ–ø–∏—Ç—å"})]})]})]})}export{Be as default};
