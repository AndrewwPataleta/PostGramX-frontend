import{j as e,f as V,x as A,a as M,r as b,o as S,d as i}from"./index-CUXtzWzq.js";import{u as v}from"./useMutation-BH6Tq1UL.js";import{A as L,a as U,b as F}from"./avatar-x6IQ0aYH.js";import{B as j}from"./button-Dzbjkk6a.js";import{C as N,a as y}from"./card-DCKESwIw.js";import{l as B,v as P}from"./channelsApi-M9Gp1oJ7.js";import{g as C}from"./errorMapping-Dh11CgGc.js";import{u as R}from"./useAddChannelFlow-C7QKvmuy.js";const G=A("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function O({className:a,variant:t,...d}){return e.jsx("div",{className:V(G({variant:t}),a),...d})}const k=a=>a==null?null:new Intl.NumberFormat("en",{notation:"compact"}).format(a),W=a=>{const t=String(a.status??"").toUpperCase();return["VERIFIED","SUCCESS","OK"].includes(t)},Q=()=>{const a=M(),{state:t,setLinkedChannelId:d,setLinkStatus:c,setVerifyStatus:l,setLastError:o}=R(),s=t.preview;b.useEffect(()=>{s||a("/add-channel/step-1",{replace:!0})},[a,s]);const w=b.useMemo(()=>s?.username?s.username.startsWith("@")?s.username:`@${s.username}`:"â€”",[s?.username]),h=v({mutationFn:r=>B({username:r}),onMutate:()=>{c("loading"),o(null)},onSuccess:r=>{const n=r.channelId??r.id;if(!n){const p="Channel link response is missing an id.";c("error"),o(p),i.error(p);return}c("success"),d(n),l("idle"),i.success("Channel linked"),m.mutate(n)},onError:r=>{const n=C(r);c("error"),o(n),i.error(n)}}),m=v({mutationFn:r=>P({id:r}),onMutate:()=>{l("loading"),o(null)},onSuccess:r=>{if(W(r)){l("success"),o(null),a("/add-channel/step-3");return}const n=typeof r.error=="string"?r.error:r.error?.message||"Verification failed. Please try again.";l("error"),o(n),i.error(n)},onError:r=>{const n=C(r);l("error"),o(n),i.error(n)}}),E=()=>{if(!s)return;const r=(s.normalizedUsername||s.username||"").replace(/^@/,"");if(!t.linkedChannelId){if(!r){i.error("Missing channel username.");return}h.mutate(r);return}m.mutate(t.linkedChannelId)},u=h.isPending||m.isPending,x=!!t.linkedChannelId,I=x?"Verify channel":"Connect channel",f=k(s?.memberCount),g=k(s?.avgViews);return s?e.jsxs("div",{className:"flex flex-1 flex-col gap-4",children:[e.jsx(N,{className:"border-border/60 bg-card/80 shadow-sm",children:e.jsxs(y,{className:"space-y-4 p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(L,{className:"h-12 w-12",children:[s.photoUrl||s.avatarUrl?e.jsx(U,{src:s.photoUrl??s.avatarUrl??""}):null,e.jsx(F,{className:"bg-secondary text-sm font-semibold text-foreground",children:(s.title||"C").charAt(0)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:w})]}),e.jsx(O,{variant:"secondary",className:"text-[10px] uppercase",children:x?"Linked":"Not connected yet"})]}),(f||g)&&e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[f?e.jsxs("span",{children:[f," subscribers"]}):null,g?e.jsxs("span",{children:[g," avg views"]}):null]})]})}),e.jsx(N,{className:"border-border/60 bg-card/80 shadow-sm",children:e.jsxs(y,{className:"space-y-3 p-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Grant bot access"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will verify admin rights before money operations."})]}),e.jsxs("ol",{className:"space-y-2 text-xs text-muted-foreground",children:[e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"1."}),"Open channel settings"]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"2."}),"Add @PostGramXBot as admin"]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"3."}),'Enable "Post messages" permission']})]})]})}),e.jsxs("div",{className:"mt-auto flex flex-col gap-3",children:[e.jsx(j,{onClick:E,disabled:u,className:"w-full text-sm font-semibold",children:u?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"h-4 w-4 animate-spin"}),x?"Verifying":"Connecting"]}):I}),e.jsx(j,{variant:"secondary",onClick:()=>a("/add-channel/step-1"),disabled:u,className:"w-full text-sm font-semibold",children:"Back"})]})]}):null};export{Q as default};
