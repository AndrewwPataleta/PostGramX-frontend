const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D6n6QaD9.js","assets/index-BW2Snbvp.js","assets/index-CDV1_DH_.css","assets/index-CQrtTZH8.js"])))=>i.map(i=>d[i]);
import{c as X,a as v,r as b,j as e,h as g,f as L,b as h,p as T,i as ee,k as te,l as se,_ as W,u as re,R as ne,d as oe,e as ae}from"./index-BW2Snbvp.js";import{u as F}from"./useQuery-DyOj3TZg.js";import{a as Y,b as _}from"./formatters-CG109iVp.js";import{f as le,h as V,b as de,c as ie}from"./labels-EEWNt0UM.js";import{D as i}from"./deals-gDsdDI1w.js";import{C as ce}from"./chevron-left-BEk7tngC.js";import{a as ue,f as me}from"./dealsApi-CWxYew0x.js";import{L as xe}from"./LoadingSkeleton-CRU15B_E.js";import{E as pe}from"./ErrorState-wor5FcZJ.js";import{P as ge}from"./PageContainer-_fsxklaj.js";import{g as S}from"./errors-3kY4UU5q.js";import{U as M}from"./roles-CjDqvnis.js";import{u as P}from"./useMutation-UnYB113s.js";import{S as fe}from"./ScheduleDatePicker-BOOuT4W1.js";import{t as G}from"./date-DTgQQEB1.js";import{o as Q}from"./telegramLinks-DFMIlj7w.js";import"./ton-ClBVV2oW.js";import"./skeleton-OvYVp1BO.js";import"./input-B_SHVbde.js";import"./Combination-Dqbgnx9E.js";/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],be=X("chevron-right",he);function ye({deal:t}){const{t:s,language:n}=v(),[a,r]=b.useState(!1),m=`${Y(t.listing.priceNano,n)} ${s("common.ton")}`,d=le(s,t.listing.format),x=t.listing.tags??[],c=t.listing.pinDurationHours??t.listing.placementHours,u=t.listing.visibilityDurationHours??t.listing.lifetimeHours,p=b.useMemo(()=>[{label:s("listings.pinDuration"),value:c?V(c,s):s("common.none")},{label:s("listings.lifetimeDuration"),value:u?V(u,s):s("common.emptyValue")},{label:s("listings.allowEdits.label"),value:t.listing.allowEdits===void 0?s("common.emptyValue"):de(s,t.listing.allowEdits)},{label:s("listings.allowLinkTracking.label"),value:t.listing.allowLinkTracking===void 0?s("common.emptyValue"):ie(s,t.listing.allowLinkTracking)}],[t.listing.allowEdits,t.listing.allowLinkTracking,c,u,s]);return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center overflow-hidden rounded-full bg-secondary/60 text-lg font-semibold text-muted-foreground",children:t.channel.avatarUrl?e.jsx("img",{src:t.channel.avatarUrl,alt:t.channel.name,className:"h-full w-full object-cover"}):t.channel.name.slice(0,1)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm font-semibold text-foreground",children:e.jsx("span",{className:"truncate",children:t.channel.name})}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",t.channel.username]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:m}),e.jsx("p",{className:"text-xs text-muted-foreground",children:d})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"button",onClick:()=>r(o=>!o),className:"flex w-full items-center justify-between rounded-lg border border-border/60 bg-background/60 px-3 py-2 text-xs font-semibold text-muted-foreground transition hover:text-foreground",children:[e.jsx("span",{children:s(a?"common.hideDetails":"common.more")}),e.jsx("span",{className:g("text-xs",a?"text-foreground":"text-muted-foreground"),children:s(a?"common.collapseSymbol":"common.expandSymbol")})]})}),a?e.jsxs("div",{className:"mt-4 space-y-3 text-xs text-muted-foreground",children:[x.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:x.map(o=>e.jsxs("span",{className:"rounded-full bg-secondary/60 px-3 py-1 text-xs font-medium text-foreground",children:["#",o]},o))}):null,e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:p.map(o=>e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-[11px] font-semibold text-muted-foreground",children:o.label}),e.jsx("span",{className:"font-semibold text-foreground",children:o.value})]},o.label))}),t.listing.contentRulesText?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-muted-foreground",children:[e.jsx("p",{className:"text-[11px] font-semibold text-foreground/80",children:s("listings.rulesTitle")}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t.listing.contentRulesText})]}):null]}):null]})}const U=["SCHEDULE","SEND_POST","CONFIRM_POST","CREATIVE_AWAITING_ADMIN_REVIEW","PAYMENT_WINDOW","PAYMENT","PAYMENT_PENDING","SCHEDULED","VERIFYING","DONE"],Ne=[...U],je={[i.DRAFT]:"SCHEDULE",[i.CREATIVE_AWAITING_SUBMIT]:"SEND_POST",[i.CREATIVE_AWAITING_ADMIN_REVIEW]:"CREATIVE_AWAITING_ADMIN_REVIEW",[i.PAYMENT_AWAITING]:"PAYMENT",[i.FUNDS_PENDING]:"PAYMENT_PENDING",[i.FUNDS_CONFIRMED]:"SCHEDULED",[i.APPROVED_SCHEDULED]:"SCHEDULED",[i.POSTED_VERIFYING]:"VERIFYING",[i.COMPLETED]:"DONE",[i.CANCELED]:"DONE",[i.REFUNDED]:"DONE",[i.DISPUTED]:"DONE"},K=t=>je[t]??"SCHEDULE",q=(t,s)=>s(`deals.timeline.stage.${t}`),Ee=(t,s)=>s(`deals.escrowStatus.${t}`),ve=(t,s)=>{const n=K(s);return U.indexOf(t)<=U.indexOf(n)};function we({stages:t,selectedStage:s,escrowStatus:n,onSelect:a}){const{t:r}=v(),m=t.indexOf(s),d=m>0?t[m-1]:null,x=m>=0&&m<t.length-1?t[m+1]:null,c=!!a;return e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:r("deals.timeline.title")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r("deals.timeline.steps",{count:t.length})})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[c?e.jsx("button",{type:"button",onClick:()=>d&&a?.(d),disabled:!d,className:g("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",d?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":r("deals.timeline.previousStage"),children:e.jsx(ce,{className:"h-4 w-4"})}):null,e.jsx("div",{className:"flex flex-1 flex-wrap gap-2",children:t.map(u=>{const p=u===s,o=!ve(u,n),E=g("rounded-full border px-3 py-1 text-xs font-semibold transition",p?"bg-primary text-white":"border-border/60 bg-background/50 text-muted-foreground",c&&!o?"hover:border-primary/40 hover:text-foreground":"opacity-70");return c?e.jsx("button",{type:"button",onClick:()=>a?.(u),disabled:o,className:g(E,o?"cursor-not-allowed opacity-40":"hover:border-primary/40 hover:text-foreground"),children:q(u,r)},u):e.jsx("div",{className:E,children:q(u,r)},u)})}),c?e.jsx("button",{type:"button",onClick:()=>x&&a?.(x),disabled:!x,className:g("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",x?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":r("deals.timeline.nextStage"),children:e.jsx(be,{className:"h-4 w-4"})}):null]})]})}function j({title:t,children:s}){return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t})}),e.jsx("div",{className:"mt-3 space-y-2 text-xs text-muted-foreground",children:s})]})}const $=t=>{if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s};function Se({deal:t,readonly:s,onAction:n}){const a=L(),{t:r,language:m}=v(),[d,x]=b.useState($(t.scheduledAt)),c=b.useMemo(()=>d?d.getTime()>Date.now()+3600*1e3:!1,[d]);b.useEffect(()=>{x($(t.scheduledAt))},[t.scheduledAt]);const u=P({mutationFn:async()=>{if(!d||!c)throw new Error(r("deals.stage.scheduleTime.selectDateError"));const o=G(d);if(!o.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",o),new Error("Invalid datetime format");return console.log("Schedule payload UTC:",o),T("/deals/schedule",{dealId:t.id,scheduledAt:o})},onSuccess:()=>{h.success(r("deals.stage.scheduleTime.updatedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:o=>{h.error(S(o,r("deals.stage.scheduleTime.saveError")))}});if(s)return e.jsxs(j,{title:r("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduleTime.readonly")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("deals.scheduledAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:t.scheduledAt?_(t.scheduledAt,m):r("deals.stage.scheduleTime.notScheduled")})]})]});const p=()=>{if(!d||!c){h.error(r("deals.stage.scheduleTime.selectDateError"));return}if(n?.onConfirmSchedule){const o=G(d);if(!o.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",o),new Error("Invalid datetime format");n.onConfirmSchedule(o);return}u.mutate()};return e.jsxs(j,{title:r("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduleTime.description")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"pb-safe-bottom rounded-2xl border border-border/60 bg-card/80 p-3",children:e.jsx(fe,{value:d,onChange:x})}),e.jsx("button",{type:"button",onClick:p,disabled:u.isPending||!c,className:g("w-full rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",u.isPending||!c?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("deals.stage.scheduleTime.confirm")})]})]})}const De="postgramx_bot";function Ae({deal:t,readonly:s,onAction:n}){const a=L(),{t:r}=v(),m=`https://t.me/${De}?start=deal_${t.id}`,d=!!t.creativeText,x=P({mutationFn:async()=>T("/deals/creative/submit",{dealId:t.id}),onSuccess:()=>{h.success(r("deals.stage.sendPost.submittedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:p=>{h.error(S(p,r("deals.stage.sendPost.submitError")))}});if(s)return e.jsxs(j,{title:r("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.readonly")}),d?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:r("deals.stage.sendPost.creativeSubmitted")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.noCreative")})]});const c=()=>{if(n?.onOpenBot){n.onOpenBot();return}Q(m)},u=()=>{if(n?.onConfirmSent){n.onConfirmSent();return}x.mutate()};return e.jsxs(j,{title:r("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.description")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:c,className:"rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition hover:bg-primary/90",children:r("deals.stage.sendPost.openBot")}),e.jsx("button",{type:"button",onClick:u,disabled:x.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",x.isPending&&"cursor-not-allowed opacity-60"),children:r("deals.stage.sendPost.confirmSent")})]}),d?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.waitingReview")}):null]})}const B=t=>{if(!t)return null;const s=new Date(t).getTime();if(Number.isNaN(s))return null;const n=Math.max(0,s-Date.now()),a=Math.floor(n/36e5),r=Math.floor(n%36e5/6e4),m=Math.floor(n%6e4/1e3),d=x=>x.toString().padStart(2,"0");return`${d(a)}:${d(r)}:${d(m)}`};function Ce({deal:t,readonly:s,onAction:n}){const a=L(),{t:r}=v(),[m,d]=b.useState(()=>B(t.adminReviewDeadlineAt));b.useEffect(()=>{if(!t.adminReviewDeadlineAt){d(null);return}const l=()=>{d(B(t.adminReviewDeadlineAt))};l();const w=window.setInterval(l,1e3);return()=>window.clearInterval(w)},[t.adminReviewDeadlineAt]);const x=P({mutationFn:async()=>T("/deals/creative/approve",{dealId:t.id}),onSuccess:()=>{h.success(r("deals.stage.adminApproval.approvedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:l=>{h.error(S(l,r("deals.stage.adminApproval.approveError")))}}),c=P({mutationFn:async()=>T("/deals/creative/edits",{dealId:t.id}),onSuccess:()=>{h.success(r("deals.stage.adminApproval.requestedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:l=>{h.error(S(l,r("deals.stage.adminApproval.requestError")))}}),u=P({mutationFn:async()=>T("/deals/creative/reject",{dealId:t.id}),onSuccess:()=>{h.success(r("deals.stage.adminApproval.rejectedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:l=>{h.error(S(l,r("deals.stage.adminApproval.rejectError")))}});if(s)return e.jsxs(j,{title:r("deals.stage.adminApproval.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.readonly")}),m?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.timeLeft",{time:m})}):null]});const p=()=>{if(n?.onApprove){n.onApprove();return}x.mutate()},o=()=>{if(n?.onRequestChanges){n.onRequestChanges();return}c.mutate()},E=()=>{if(n?.onReject){n.onReject();return}u.mutate()};return e.jsxs(j,{title:r("deals.stage.adminApproval.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.description")}),m?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.timeLeft",{time:m})}):null,e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:p,disabled:x.isPending,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",x.isPending&&"cursor-not-allowed opacity-60"),children:r("common.approve")}),e.jsx("button",{type:"button",onClick:o,disabled:c.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",c.isPending&&"cursor-not-allowed opacity-60"),children:r("common.requestChanges")}),e.jsx("button",{type:"button",onClick:E,disabled:u.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",u.isPending&&"cursor-not-allowed opacity-60"),children:r("common.reject")})]})]})}const Ie=t=>{const s=Math.max(0,Math.floor(t/1e3)),n=Math.floor(s/60).toString().padStart(2,"0"),a=(s%60).toString().padStart(2,"0");return`${n}:${a}`},Te=t=>t.length<=10?t:`${t.slice(0,3)}...${t.slice(-3)}`,Pe=t=>typeof t=="bigint"?t.toString():t;function Re(t){let s="";for(let a=0;a<t.length;a+=32768)s+=String.fromCharCode(...t.subarray(a,a+32768));return btoa(s)}async function _e(t){const s=window;if(!s.Buffer){const m=await W(()=>import("./index-D6n6QaD9.js").then(d=>d.i),__vite__mapDeps([0,1,2]));s.Buffer=m.Buffer}const r=(await W(()=>import("./index-CQrtTZH8.js").then(m=>m.i),__vite__mapDeps([3,1,2]))).beginCell().storeUint(0,32).storeStringTail(t).endCell().toBoc({idx:!1});return Re(r)}function Le({deal:t,readonly:s,onAction:n,isRefreshing:a}){const{t:r,language:m}=v(),{open:d}=ee(),[x]=te(),{isConnected:c,walletAppName:u,network:p}=se(),[o,E]=b.useState(!1),[l,w]=b.useState(null),C=t.paymentDeadlineAt??t.paymentExpiresAt,D=t.escrowAmountNano??t.listing.priceNano,f=t.escrowPaymentAddress??"",I=D?`${Y(D,m)} ${r("common.ton")}`:r("common.emptyValue"),y=b.useMemo(()=>{if(!c)return r("deals.stage.payment.walletDisconnected");const N=p?` • ${p}`:"";return`${r("deals.stage.payment.walletConnected")}${u?` • ${u}`:""}${N}`},[c,p,r,u]);if(b.useEffect(()=>{if(!C){w(null);return}const N=new Date(C).getTime();if(Number.isNaN(N)){w(null);return}const A=()=>{const J=Math.max(0,N-Date.now());w(Ie(J))};A();const k=window.setInterval(A,1e3);return()=>window.clearInterval(k)},[C]),b.useEffect(()=>{E(!1)},[t.id,t.escrowStatus]),t.escrowStatus!==i.PAYMENT_AWAITING)return null;const O=()=>{s||d()},z=async()=>{if(!(s||!f||!D))try{if(!x.connected){d();return}E(!0);const N=Math.floor(Date.now()/1e3)+300,A=`Deal:${t.id}`,k=await _e(A);await x.sendTransaction({validUntil:N,messages:[{address:f,amount:Pe(D),payload:k}]}),h.success(r("deals.stage.payment.paymentSent")??"Transaction sent. Waiting for confirmation...")}catch(N){const A=typeof N?.message=="string"?N.message:r("deals.stage.payment.paymentCanceled")??"Payment canceled";h.error(A),E(!1)}},Z=async()=>{if(f)try{await navigator.clipboard.writeText(f),h.success(r("deals.stage.payment.addressCopied"))}catch(N){h.error(N instanceof Error?N.message:r("deals.stage.payment.copyFailed"))}};return e.jsxs(j,{title:r("deals.stage.payment.title"),children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",c?"bg-emerald-400":"bg-muted-foreground/50")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:y})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"rounded-xl border border-border/60 bg-background/40 p-3",children:e.jsxs("div",{className:"space-y-2 text-xs text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:r("deals.stage.payment.amountToPay")}),": ",I]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:r("deals.stage.payment.receiver")}),":"," ",f?Te(f):r("common.emptyValue")]}),l?e.jsx("p",{children:e.jsx("span",{className:"font-semibold text-foreground",children:r("deals.stage.payment.expiresIn",{time:l})})}):null]})}),o?e.jsxs("div",{className:"flex flex-wrap items-center gap-3 rounded-xl border border-border/60 bg-secondary/30 px-3 py-2",children:[e.jsx("span",{className:"inline-flex h-4 w-4 items-center justify-center rounded-full border border-border/60",children:e.jsx("span",{className:"h-2 w-2 animate-spin rounded-full border-2 border-muted-foreground border-t-transparent"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r("deals.stage.payment.waiting")})]}):null,e.jsx("div",{className:"flex flex-wrap gap-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:z,disabled:s||o,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",s||o?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("deals.stage.payment.payWithWallet")}),e.jsx("button",{type:"button",onClick:Z,disabled:s,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition",s?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r("deals.stage.payment.copyAddress")})]}):e.jsx("button",{type:"button",onClick:O,disabled:s,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition",s?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r("deals.stage.payment.connectWallet")})}),o?e.jsx("button",{type:"button",onClick:n?.onRefresh,disabled:a||!n?.onRefresh,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",a||!n?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r(a?"common.refreshing":"deals.stage.payment.checkStatus")}):null]})]})}function ke({onAction:t,isRefreshing:s}){const{t:n}=v();return e.jsxs(j,{title:n("deals.stage.paymentPending.title"),children:[e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"rounded-full border border-emerald-400/40 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-300",children:n("deals.stage.payment.paymentDetected")})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n("deals.stage.paymentPending.description")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",onClick:t?.onRefresh,disabled:s||!t?.onRefresh,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",s||!t?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:n(s?"common.refreshing":"common.refresh")})})]})}function H({deal:t}){const{t:s,language:n}=v(),a=t.scheduledAt?_(t.scheduledAt,n):s("deals.stage.scheduled.notScheduled");return e.jsxs(j,{title:s("deals.stage.scheduled.title"),children:[t.escrowStatus===i.FUNDS_CONFIRMED?e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"rounded-full border border-emerald-400/40 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-300",children:s("deals.stage.payment.paymentDetected")})}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.stage.scheduled.time"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:a})]}),t.scheduledAt?e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduled.waiting")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduled.noSchedule")})]})}function Me({deal:t}){const{t:s}=v(),n=()=>{t.postUrl&&Q(t.postUrl)};return e.jsxs(j,{title:s("deals.stage.verifyingPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.verifyingPost.description")}),t.postUrl?e.jsx("button",{type:"button",onClick:n,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground","hover:border-primary/40"),children:s("deals.stage.verifyingPost.open")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.verifyingPost.pendingLink")})]})}function R({deal:t}){const{t:s,language:n}=v(),a=re(),r=t.escrowStatus===i.CANCELED,m=()=>{a(ne.DEAL_CREATE(t.listing.id))};return e.jsxs(j,{title:s("deals.stage.done.title"),children:[r?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.payment.windowExpired")}),e.jsx("button",{type:"button",onClick:m,className:"rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition hover:border-primary/40",children:s("deals.stage.payment.createNewDeal")})]}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.statusLabel"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:Ee(t.escrowStatus,s)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("common.lastUpdate"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:_(t.lastActivityAt,n)||s("common.emptyValue")})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("common.createdAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:_(t.createdAt,n)||s("common.emptyValue")})]})]})}function rt(){const{dealId:t}=oe(),s=ae(),n=L(),a=s.state?.deal,r=t?n.getQueryData(["deal",t]):void 0,m=a?.id===t?a:r,{data:d,isLoading:x,error:c,refetch:u,isFetching:p}=F({queryKey:["deal",t],queryFn:async()=>{if(!t)throw new Error("Missing deal id");return ue(t)},enabled:!!t,initialData:m,refetchInterval:f=>f?f.escrowStatus===i.CREATIVE_AWAITING_ADMIN_REVIEW?1e4:f.escrowStatus===i.PAYMENT_AWAITING?12e3:[i.FUNDS_PENDING,i.POSTED_VERIFYING].includes(f.escrowStatus)?5e3:!1:!1}),o=F({queryKey:["deals","list","detail-fallback",t],queryFn:()=>me({role:"all",pendingLimit:20,activeLimit:20,completedLimit:20}),enabled:!!t&&!d,staleTime:2e4}),E=b.useMemo(()=>!o.data||!t?null:[...o.data.pending.items,...o.data.active.items,...o.data.completed.items].find(I=>I.id===t)??null,[t,o.data]),l=d??E;b.useEffect(()=>{(c||o.error)&&h.error(S(c??o.error,"Unable to load deal"))},[c,o.error]);const w=l?K(l.escrowStatus):"SCHEDULE",C=l?Ne:[],D=b.useMemo(()=>{if(!l)return null;const f=l.userRoleInDeal===M.ADVERTISER,I=l.userRoleInDeal===M.PUBLISHER||l.userRoleInDeal===M.PUBLISHER_MANAGER,y=!f;return{[i.SCHEDULING_PENDING]:e.jsx(Se,{deal:l,readonly:!f}),[i.CREATIVE_AWAITING_SUBMIT]:e.jsx(Ae,{deal:l,readonly:!f}),[i.CREATIVE_AWAITING_ADMIN_REVIEW]:e.jsx(Ce,{deal:l,readonly:!I}),[i.PAYMENT_AWAITING]:e.jsx(Le,{deal:l,readonly:y,onAction:y?void 0:{onRefresh:()=>u()},isRefreshing:p}),[i.FUNDS_PENDING]:e.jsx(ke,{deal:l,readonly:y,onAction:y?void 0:{onRefresh:()=>u()},isRefreshing:p}),[i.FUNDS_CONFIRMED]:e.jsx(H,{deal:l,readonly:y}),[i.APPROVED_SCHEDULED]:e.jsx(H,{deal:l,readonly:y}),[i.POSTED_VERIFYING]:e.jsx(Me,{deal:l,readonly:y}),[i.COMPLETED]:e.jsx(R,{deal:l,readonly:y}),[i.CANCELED]:e.jsx(R,{deal:l,readonly:y}),[i.REFUNDED]:e.jsx(R,{deal:l,readonly:y}),[i.DISPUTED]:e.jsx(R,{deal:l,readonly:y})}[l.escrowStatus]},[p,u,l]);return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(ge,{className:"py-6 space-y-4",children:x?e.jsx(xe,{items:3}):c||o.error||!l?e.jsx(pe,{message:S(c??o.error,"Deal not found"),description:"We couldn't load this deal right now.",onRetry:()=>u()}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{deal:l}),e.jsx(we,{stages:C,selectedStage:w,escrowStatus:l.escrowStatus}),D]})})})}export{rt as default};
