import{i as U,k as J,l as ee,c as R,r as l,j as e,a as j,X as _,h as $,e as te,u as se,b as E,L as re}from"./index-K2Jj1BK-.js";import{f as ne,n as ae}from"./ton-ClBVV2oW.js";import{C as oe}from"./chevron-down-DbEslXwk.js";import{Q as ie,a as le,u as de}from"./useQuery-BnM_P3Iz.js";import{l as ce}from"./listingsApi-DvYXUwcq.js";import{S as v}from"./skeleton-DmOSyBhX.js";import{g as S}from"./errors-3kY4UU5q.js";import{p as ue,u as me}from"./channelsApi-B3KNuCdD.js";import{E as xe}from"./ErrorState-CZl5nE2W.js";import{R as pe,P as fe,O as he,C as ge,T as be,a as Ne}from"./index-CC0Tl3hY.js";import{P as ye}from"./plus-kmFcGFo9.js";var je=class extends ie{constructor(t,r){super(t,r)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t){super.setOptions({...t,behavior:U()})}getOptimisticResult(t){return t.behavior=U(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,r){const{state:n}=t,a=super.createResult(t,r),{isFetching:d,isRefetching:o,isError:i,isRefetchError:h}=a,u=n.fetchMeta?.fetchMore?.direction,m=i&&u==="forward",c=d&&u==="forward",g=i&&u==="backward",p=d&&u==="backward";return{...a,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:ee(r,n.data),hasPreviousPage:J(r,n.data),isFetchNextPageError:m,isFetchingNextPage:c,isFetchPreviousPageError:g,isFetchingPreviousPage:p,isRefetchError:h&&!m&&!g,isRefetching:o&&!c&&!p}}};function ve(t,r){return le(t,je)}/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ke=R("badge-check",we);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],Ce=R("pencil-line",Pe);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]],Se=R("refresh-ccw",Ee);/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M18 21a8 8 0 0 0-16 0",key:"3ypg7q"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3",key:"10s06x"}]],Ie=R("users-round",Re),Le={DRAFT:{label:"Draft",className:"bg-muted/40 text-muted-foreground border-border/60"},PENDING_VERIFY:{label:"Pending verification",className:"bg-yellow-500/20 text-yellow-300 border-yellow-500/40"},VERIFIED:{label:"Verified",className:"bg-emerald-500/15 text-emerald-300 border-emerald-500/30",icon:e.jsx(ke,{size:12,className:"text-emerald-300"})},FAILED:{label:"Verification failed",className:"bg-red-500/20 text-red-300 border-red-500/40"},REVOKED:{label:"Revoked",className:"bg-orange-500/20 text-orange-300 border-orange-500/40"}},Te=t=>t==null?"‚Äì":t>=1e6?`${(t/1e6).toFixed(1)}M`:t>=1e3?`${(t/1e3).toFixed(1)}K`:t.toString(),Fe=t=>t||"Untitled channel",$e=({channel:t,placementsCount:r,minPriceNano:n,onClick:a,onVerify:d,onUnlink:o,isExpanded:i=!1,onToggleExpand:h,expandDisabled:u=!1,expandTooltip:m,expandedContent:c,createListingTo:g,createListingState:p})=>{const w=Le[t.status],k=t.status==="PENDING_VERIFY"&&d,I=!!o,P=!!h,[L,T]=l.useState(!1),F=t.title?.[0]?.toUpperCase()??t.username?.[0]?.toUpperCase(),N=!L&&t.avatarUrl?t.avatarUrl:null,C=Te(t.memberCount),b=l.useMemo(()=>{if(!n)return"‚Äî";try{return ne(ae(n))}catch{return n}},[n]);return e.jsxs("div",{className:j("w-full rounded-2xl border border-border/50 bg-card/80 p-4 text-left shadow-sm transition",a&&"cursor-pointer hover:border-border/80 hover:bg-card"),role:a?"button":void 0,tabIndex:a?0:void 0,onClick:a,onKeyDown:x=>{a&&(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),a())},children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center overflow-hidden rounded-full bg-muted/40 text-base text-foreground",children:N?e.jsx("img",{src:N,alt:t.title,className:"h-12 w-12 rounded-full object-cover",onError:()=>T(!0)}):e.jsx("span",{children:F??"?"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-foreground",children:Fe(t.title)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",t.username]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[I?e.jsx("button",{type:"button",onClick:x=>{x.stopPropagation(),o?.()},className:"rounded-full border border-border/60 bg-background/70 p-1.5 text-muted-foreground transition hover:text-foreground","aria-label":"Unlink channel",children:e.jsx(_,{size:14})}):null,e.jsxs("span",{className:j("inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] font-medium",w.className),children:[w.icon,w.label]}),P?e.jsx("button",{type:"button",onClick:x=>{x.stopPropagation(),h?.()},disabled:u,title:m,"aria-label":i?"Collapse placements":"Expand placements","aria-expanded":i,className:j("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 bg-background/70 text-muted-foreground transition",!u&&"hover:text-foreground",u&&"cursor-not-allowed opacity-60"),children:e.jsx(oe,{size:16,className:j("transition-transform duration-300",i&&"rotate-180")})}):null]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ie,{size:12}),C]}),e.jsx("span",{children:"¬∑"}),e.jsx("span",{children:typeof r=="number"?`${r} placements`:"‚Äî placements"})]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:e.jsxs("span",{children:["From ",e.jsxs("span",{className:"font-semibold text-primary",children:[b," TON"]})]})})]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between gap-3 text-xs text-muted-foreground",children:[e.jsx("div",{className:"flex items-center gap-2",children:k?e.jsx("button",{type:"button",onClick:x=>{x.stopPropagation(),d()},className:"rounded-full border border-yellow-500/40 bg-yellow-500/15 px-2 py-0.5 text-[11px] font-semibold text-yellow-200 transition hover:bg-yellow-500/25",children:"Verify"}):null}),g?e.jsx($,{to:g,state:p,onClick:x=>x.stopPropagation(),className:"rounded-full bg-primary px-4 py-1.5 text-[11px] font-semibold text-primary-foreground",children:"Create listing"}):null]}),c?e.jsx("div",{className:j("mt-4 grid transition-[grid-template-rows] duration-300 ease-out",i?"grid-rows-[1fr]":"grid-rows-[0fr]"),children:e.jsx("div",{className:j("overflow-hidden transition-all duration-300 ease-out",i?"opacity-100 translate-y-0":"opacity-0 -translate-y-1"),children:e.jsx("div",{className:"rounded-xl border border-border/50 bg-background/60 p-3",children:c})})}):null]})},De=l.memo($e),Ae=5,Me=3,O=1000000000n,Ue=t=>{try{const r=BigInt(t),n=r/O,a=r%O;if(a===0n)return`${n.toString()} TON`;const o=a.toString().padStart(9,"0").slice(0,2).replace(/0+$/,"");return`${o?`${n.toString()}.${o}`:n.toString()} TON`}catch{return`${t} TON`}},Oe=t=>{const r=t.slice(0,2),n=t.length-r.length;return{shown:r,remaining:n}},V=l.memo(({channelId:t,listing:r,rootBackTo:n})=>{const a=r.pinDurationHours?`Pinned ${r.pinDurationHours}h`:"No pin",d=`Visible ${r.visibilityDurationHours}h`,o=Oe(r.tags??[]);return e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsxs("div",{className:"flex flex-col items-start gap-1",children:[e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5 text-[10px] font-semibold text-muted-foreground",children:r.format}),e.jsx("span",{className:j("rounded-full border px-2 py-0.5 text-[10px] font-semibold",r.isActive?"border-emerald-500/40 bg-emerald-500/15 text-emerald-200":"border-muted-foreground/30 bg-muted/40 text-muted-foreground"),children:r.isActive?"Active":"Inactive"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:Ue(r.priceNano)}),e.jsxs("div",{className:"mt-1 text-[11px] text-muted-foreground",children:[a," ‚Ä¢ ",d]}),o.shown.length>0?e.jsxs("div",{className:"mt-2 flex flex-wrap gap-1",children:[o.shown.map(i=>e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/30 px-2 py-0.5 text-[10px] text-muted-foreground",children:i},i)),o.remaining>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-muted/30 px-2 py-0.5 text-[10px] text-muted-foreground",children:["+",o.remaining]}):null]}):null]}),e.jsx($,{to:`/channel-manage/${t}/listings/${r.id}/edit`,state:n?{rootBackTo:n}:void 0,className:"flex h-9 w-9 items-center justify-center rounded-full border border-border/60 bg-background text-muted-foreground transition hover:text-foreground","aria-label":"Edit listing",children:e.jsx(Ce,{size:14})})]})});V.displayName="ListingPreviewRow";const B=l.memo(({channelId:t,isExpanded:r,onSummaryChange:n})=>{const d=te().state?.rootBackTo,o=de({queryKey:["channelListingsPreview",t],queryFn:()=>ce({channelId:t,page:1,limit:Ae,onlyActive:!0,sort:"recent"}),enabled:r,staleTime:1e3*60*5}),i=o.data?.items??[],h=o.data?.total??i.length;l.useEffect(()=>{if(!o.data)return;const m=i.reduce((c,g)=>{try{const p=BigInt(g.priceNano);return c===null||p<c?p:c}catch{return c}},null);n?.({placementsCount:h,minPriceNano:m?m.toString():null})},[i,n,o.data,h]);const u=l.useMemo(()=>i.slice(0,Me),[i]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:"Placements"})}),o.isLoading?e.jsx("div",{className:"space-y-2",children:Array.from({length:2}).map((m,c)=>e.jsxs("div",{className:"rounded-xl border border-border/50 bg-background/60 px-3 py-3",children:[e.jsx(v,{className:"h-4 w-24"}),e.jsx(v,{className:"mt-2 h-3 w-40"}),e.jsx(v,{className:"mt-2 h-3 w-28"})]},`listing-skeleton-${c}`))}):o.isError?e.jsxs("div",{className:"rounded-xl border border-border/60 bg-red-500/5 px-4 py-3 text-xs text-red-200",children:[e.jsx("p",{children:S(o.error,"Unable to load placements.")}),e.jsxs("button",{type:"button",onClick:()=>o.refetch(),className:"mt-2 inline-flex items-center gap-2 rounded-full border border-red-500/40 bg-red-500/10 px-3 py-1 text-[11px] font-semibold text-red-200",children:[e.jsx(Se,{size:12}),"Retry"]})]}):u.length>0?e.jsx("div",{className:"rounded-xl border border-border/60 bg-background/60 px-3 divide-y divide-border/40",children:u.map(m=>e.jsx(V,{channelId:t,listing:m,rootBackTo:d},m.id))}):e.jsxs("div",{className:"rounded-xl border border-dashed border-border/60 bg-background/50 px-4 py-4 text-center",children:[e.jsx("p",{className:"text-xs font-semibold text-foreground",children:"No placements yet"}),e.jsx("p",{className:"mt-1 text-[11px] text-muted-foreground",children:"Create your first listing to start earning."})]})]})});B.displayName="ChannelListingsPreview";const _e=t=>["channelsList",t],Ve=(t,r=10)=>ve({queryKey:_e(t),queryFn:({pageParam:n=1})=>ue({...t,page:Number(n),limit:r}),getNextPageParam:n=>n.hasNext?n.page+1:void 0,initialPageParam:1});function Be({open:t,onOpenChange:r,title:n,children:a}){return e.jsx(pe,{open:t,onOpenChange:r,children:e.jsxs(fe,{children:[e.jsx(he,{className:"fixed inset-0 z-40 bg-black/60"}),e.jsxs(ge,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx(be,{className:"text-sm font-semibold text-foreground",children:n}),e.jsx(Ne,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:e.jsx(_,{size:16})})]}),e.jsx("div",{className:"pt-2",children:a})]})]})})}const ze="recent",qe="desc",Ke=["DRAFT","PENDING_VERIFY","FAILED","REVOKED"],Qe=()=>e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"h-4 w-32"}),e.jsx(v,{className:"h-3 w-20"})]}),e.jsx(v,{className:"h-5 w-24 rounded-full"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(v,{className:"h-16 rounded-xl"})})]}),Ge=t=>{if(!t)return null;const r=t.filter(a=>a.isActive!==!1),n=r.reduce((a,d)=>{try{const o=BigInt(d.priceNano);return a===null||o<a?o:a}catch{return a}},null);return{placementsCount:r.length,minPriceNano:n?n.toString():null}};function at(){const[t,r]=l.useState("verified"),[n,a]=l.useState(null),[d,o]=l.useState(!1),[i,h]=l.useState(()=>new Set),[u,m]=l.useState(()=>new Set),[c,g]=l.useState({}),p=se(),w=l.useMemo(()=>({sort:ze,order:qe,includeListings:!0}),[]),{data:k,isLoading:I,isFetchingNextPage:P,fetchNextPage:L,hasNextPage:T,refetch:F,error:N}=Ve(w,10),C=l.useMemo(()=>k?.pages.flatMap(s=>s.items)??[],[k]),b=l.useMemo(()=>C.filter(s=>!i.has(s.id)),[C,i]),x=k?.pages?.[0]?.total??0;l.useEffect(()=>{N&&E.error(S(N,"Unable to load channels."))},[N]);const z=l.useMemo(()=>b.filter(s=>s.status==="VERIFIED"),[b]),q=l.useMemo(()=>b.filter(s=>Ke.includes(s.status)),[b]),D=t==="verified"?z:q,K=t==="pending"?"No pending channels right now.":"No verified channels yet.",Q=s=>{if(s.status==="PENDING_VERIFY"){p(`/channels/pending/${s.id}`,{state:{channel:s,rootBackTo:"/channels"}});return}p(`/channel-manage/${s.id}/listings`,{state:{channel:s,rootBackTo:"/channels"}})},G=l.useCallback(s=>{m(y=>{const f=new Set(y);return f.has(s)?f.delete(s):f.add(s),f})},[]),Y=async()=>{if(n){o(!0);try{const s=await me({channelId:n.id});s.unlinked?(h(y=>{const f=new Set(y);return f.add(s.channelId),f}),E.success("Channel unlinked.")):E.error("Unable to unlink channel."),a(null)}catch(s){E.error(S(s,"Unable to unlink channel."))}finally{o(!1)}}};return e.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col gap-6 px-4 pb-16 pt-4",children:[I?e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,y)=>e.jsx(Qe,{},`channel-skeleton-${y}`))}):N?e.jsx(xe,{message:S(N,"Unable to load channels"),description:"Please try again in a moment.",onRetry:()=>F()}):b.length===0?e.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:"üì°"}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"No channels yet"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Connect your first Telegram channel to get started."}),e.jsx($,{to:"/add-channel/step-1",className:"mt-4 inline-flex items-center justify-center rounded-full bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:"Add Channel"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border-t border-border/50",children:e.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(s=>e.jsxs("button",{onClick:()=>r(s),className:`py-3 text-sm font-medium border-b-2 transition-colors ${t===s?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:[s.charAt(0).toUpperCase()+s.slice(1)," "]},s))})}),D.length>0?e.jsx("div",{className:"space-y-3",children:D.map(s=>{const y=u.has(s.id),f=s.status==="VERIFIED",A=Ge(s.listings),M=c[s.id],H=A?.placementsCount??M?.placementsCount??null,W=A?.minPriceNano??M?.minPriceNano??null;return e.jsx(De,{channel:s,placementsCount:H,minPriceNano:W,onClick:()=>Q(s),onVerify:()=>p(`/channels/pending/${s.id}`,{state:{channel:s,rootBackTo:"/channels"}}),onUnlink:t==="pending"?()=>{a(s)}:void 0,isExpanded:y,onToggleExpand:f?()=>G(s.id):void 0,expandDisabled:!f,expandTooltip:f?void 0:"Verify channel to add placements",expandedContent:f?e.jsx(B,{channelId:s.id,isExpanded:y,onSummaryChange:X=>{g(Z=>({...Z,[s.id]:X}))}}):null,createListingTo:`/channel-manage/${s.id}/listings/create`,createListingState:{channel:s,rootBackTo:"/channels"}},s.id)})}):e.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:K})]}),b.length>0?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Showing ",b.length," of ",x]}),T?e.jsxs("button",{type:"button",onClick:()=>L(),disabled:P,className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[P?e.jsx(re,{size:14,className:"animate-spin"}):null,P?"Loading":"Load more"]}):null]}):null,e.jsx("button",{type:"button",onClick:()=>p("/add-channel/step-1"),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":"Add channel",children:e.jsx(ye,{size:18})}),e.jsxs(Be,{open:!!n,onOpenChange:s=>{s||a(null)},title:"–û—Ç–∫—Ä–µ–ø–∏—Ç—å –∫–∞–Ω–∞–ª?",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["–í—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä–µ–ø–∏—Ç—å –∫–∞–Ω–∞–ª"," ",e.jsxs("span",{className:"font-semibold text-foreground",children:["@",n?.username]}),"?"]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>a(null),className:"flex-1 rounded-full border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:d,children:"–û—Ç–º–µ–Ω–∞"}),e.jsx("button",{type:"button",onClick:Y,className:"flex-1 rounded-full bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:d,children:d?"–û—Ç–∫—Ä–µ–ø–ª—è–µ–º...":"–û—Ç–∫—Ä–µ–ø–∏—Ç—å"})]})]})]})}export{at as default};
