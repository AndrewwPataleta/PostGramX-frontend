import{b as I,d as q,r as d,j as e,L as D}from"./index-53kr_7Yp.js";import{u as H}from"./useQuery-BxgdRvsh.js";import{l as M}from"./listingsApi-v_TUNH-b.js";import{E as O}from"./ErrorState-DhCSaa25.js";import{P as V}from"./PageContainer-D81Z1MR9.js";import{S as u}from"./skeleton-kSUtZSp3.js";import{u as z}from"./use-deals-BzUDoKJu.js";import{f as E,n as k}from"./ton-ClBVV2oW.js";import"./useMutation-CT_GQqdm.js";import"./dealsApi-DVosJBv0.js";const A=t=>t>=168&&t%24===0?`${t/24}d`:`${t}h`;function te(){const{channelId:t}=I(),o=q().state,x=o?.channel??null,h=d.useRef(null),[N,j]=d.useState(null),[$,F]=d.useState(!1),v=z(),p=d.useMemo(()=>{if(!x)return null;const s=x;return{id:s.id,name:s.name,username:s.username??null,about:s.about??s.description??null,description:s.description??null,avatarUrl:s.avatarUrl??null,subscribers:s.subscribers??null,placementsCount:o?.placementsCount??s.placementsCount??null,minPriceNano:o?.minPriceNano??s.minPriceNano??null,tags:o?.tags??s.tags??[],listingsPreview:o?.listingsPreview??s.listingsPreview??s.listings??null}},[o,x]),r=d.useMemo(()=>p||(t?{id:t,name:"Channel",username:null,about:null,description:null,avatarUrl:null,subscribers:null,placementsCount:null,minPriceNano:null,tags:[],listingsPreview:null}:null),[p,t]),b=r?.listingsPreview?.filter(s=>s.isActive!==!1)??[],y=!!t&&b.length===0,g=H({queryKey:["listingsByChannel","details",t],queryFn:()=>M({channelId:t??"",page:1,limit:10,onlyActive:!0,sort:"price_asc"}),enabled:y,staleTime:1e3*60*5}),l=b.length>0?b:g.data?.items.filter(s=>s.isActive!==!1)??[],w=l.reduce((s,n)=>{try{const a=BigInt(n.priceNano);return s===null||a<s?a:s}catch{return s}},null),C=r?.minPriceNano??(w?w.toString():null),f=C?E(k(C)):null,c=l[0],i=v.isPending,P=r?.about??r?.description,T=r?.username?`@${r.username}`:null,L=async s=>{if(!i){j(s);try{await v.mutateAsync({listingId:s})}finally{j(null)}}},S=d.useMemo(()=>l.map(s=>({...s,priceTon:`${E(k(s.priceNano))} TON`,tags:s.tags.map(n=>n.trim()).filter(Boolean)})),[l]),B=typeof r?.subscribers=="number"?r.subscribers.toLocaleString():"—",m=(s=>{const n=s.map(U=>U.trim()).filter(Boolean),a=Array.from(new Set(n));return{visible:a.slice(0,3),hiddenCount:Math.max(a.length-3,0)}})(r?.tags??[]),R=()=>{c&&(l.length===1?L(c.id):h.current?.scrollIntoView({behavior:"smooth",block:"start"}))};return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(V,{className:"py-6 space-y-4",children:!r||t&&r.id!==t?e.jsx(O,{message:"Channel not found",description:"We couldn't load this channel."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start",children:[e.jsx("div",{className:"flex h-16 w-16 shrink-0 items-center justify-center rounded-2xl bg-primary/10 text-2xl",children:!$&&r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:r.name,className:"h-16 w-16 rounded-2xl object-cover",onError:()=>F(!0)}):r.name?.[0]?.toUpperCase()}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:r.name})}),T?e.jsx("p",{className:"text-xs text-muted-foreground",children:T}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.placementsCount??l.length??"—"," placements •"," ",B," subscribers"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["From"," ",e.jsxs("span",{className:"font-semibold text-primary",children:[f??"--"," TON"]})]}),m.visible.length>0?e.jsxs("div",{className:"flex flex-wrap gap-2 text-[11px] text-muted-foreground",children:[m.visible.map(s=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1 text-foreground",children:s},`${r.id}-${s}`)),m.hiddenCount>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1 text-muted-foreground",children:["+",m.hiddenCount]}):null]}):null,P?e.jsx("p",{className:"text-sm text-muted-foreground",children:P}):null]})]})}),e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-6",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pricing"}),e.jsxs("div",{className:"mt-2 flex items-baseline gap-2",children:[e.jsx("span",{className:"text-3xl font-semibold text-foreground",children:f??"--"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"TON per post"})]}),e.jsx("p",{className:"mt-3 text-sm text-muted-foreground",children:"Pricing includes escrow protection and bot-assisted messaging."}),e.jsxs("button",{type:"button",onClick:R,disabled:!c||i,className:"mt-5 inline-flex w-full items-center justify-center gap-2 rounded-lg bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground disabled:opacity-60",children:[i&&N===c?.id?e.jsx(D,{size:16,className:"animate-spin"}):null,"Create Deal"]})]}),e.jsxs("div",{ref:h,className:"rounded-2xl border border-border/60 bg-card/80 p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Available placements"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.placementsCount??l.length," placements available"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"From"}),e.jsxs("p",{className:"text-lg font-semibold text-primary",children:[f??"--"," TON"]})]})]}),g.isLoading&&y?e.jsx("div",{className:"space-y-3",children:Array.from({length:2}).map((s,n)=>e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/70 p-4 space-y-3",children:[e.jsx(u,{className:"h-4 w-32"}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsx(u,{className:"h-14 rounded-lg"}),e.jsx(u,{className:"h-14 rounded-lg"}),e.jsx(u,{className:"h-14 rounded-lg"})]})]},`listing-skeleton-${n}`))}):g.isError?e.jsx("div",{className:"rounded-xl border border-border/60 bg-red-500/5 p-4 text-sm text-red-200",children:"Failed to load placements."}):S.length>0?e.jsx("div",{className:"space-y-3",children:S.map(s=>{const n=i&&N===s.id;return e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/70 p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Price"}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-foreground",children:s.priceTon})]}),e.jsxs("button",{type:"button",onClick:()=>L(s.id),disabled:i,className:"inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground disabled:opacity-60",children:[n?e.jsx(D,{size:14,className:"animate-spin"}):null,"Create Deal"]})]}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-border/60 bg-card/60 p-3",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Placement"}),e.jsx("p",{className:"mt-1 text-xs font-semibold text-foreground",children:s.format})]}),e.jsxs("div",{className:"rounded-lg border border-border/60 bg-card/60 p-3",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Pinned"}),e.jsx("p",{className:"mt-1 text-xs font-semibold text-foreground",children:s.pinDurationHours?A(s.pinDurationHours):"Not pinned"})]}),e.jsxs("div",{className:"rounded-lg border border-border/60 bg-card/60 p-3",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Visible"}),e.jsx("p",{className:"mt-1 text-xs font-semibold text-foreground",children:A(s.visibilityDurationHours??24)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-[11px] text-muted-foreground",children:[s.allowEdits?e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:"Edits allowed"}):null,s.allowLinkTracking?e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:"Tracking allowed"}):null,s.allowPinnedPlacement||s.pinDurationHours?e.jsx("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:"Pinned available"}):null]}),s.tags.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2 text-[11px] text-foreground",children:s.tags.map(a=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1",children:a},`${s.id}-${a}`))})]}):null,s.contentRulesText?e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[e.jsx("p",{className:"font-semibold text-muted-foreground",children:"Requirements"}),e.jsx("p",{className:"line-clamp-2",children:s.contentRulesText})]}):null]},s.id)})}):e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-6 text-center",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"No listings yet"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This channel has no active placements available right now."})]})]})]})})})}export{te as default};
