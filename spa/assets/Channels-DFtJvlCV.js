import{a1 as I,a2 as H,a3 as J,a as L,r as i,j as t,a0 as T,X as W,u as Z,b as v,L as ee}from"./index-C_Plwl7D.js";import{C as te,a as se}from"./ChannelListingsPreview-BUjJTIy7.js";import{Q as ne,a as re}from"./useQuery-Co5A-_5_.js";import{p as ae,u as ie}from"./channelsApi-BrAHnYqp.js";import{E as oe}from"./ErrorState-BfVcETec.js";import{R as le,P as ce,O as de,C as ue,T as me,a as xe}from"./index-BDx6o4EU.js";import{S as j}from"./skeleton-I-DYYF30.js";import{P as ge}from"./PageContainer-CTCI8bAZ.js";import{g as k}from"./errors-3kY4UU5q.js";import{P as he}from"./plus-CtCBb-jE.js";import"./formatters-B6oyEeL1.js";import"./labels-EEWNt0UM.js";import"./tagOptions-DHtvjoWf.js";import"./chevron-down-TZQlVsK3.js";import"./listingsApi-cW52J8B4.js";var pe=class extends ne{constructor(e,n){super(e,n)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:I()})}getOptimisticResult(e){return e.behavior=I(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,n){const{state:r}=e,a=super.createResult(e,n),{isFetching:o,isRefetching:l,isError:g,isRefetchError:p}=a,u=r.fetchMeta?.fetchMore?.direction,f=g&&u==="forward",b=o&&u==="forward",c=g&&u==="backward",N=o&&u==="backward";return{...a,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:J(n,r.data),hasPreviousPage:H(n,r.data),isFetchNextPageError:f,isFetchingNextPage:b,isFetchPreviousPageError:c,isFetchingPreviousPage:N,isRefetchError:p&&!f&&!c,isRefetching:l&&!b&&!N}}};function fe(e,n){return re(e,pe)}function be({channel:e,placementsCount:n,minPriceNano:r,tags:a,onClick:o,onToggleExpand:l,isExpanded:g,expandedContent:p,onUnlink:u,createListingTo:f,createListingState:b}){const{t:c}=L(),N=i.useMemo(()=>({id:e.id,name:e.title||c("channels.untitled"),username:e.username,avatarUrl:e.avatarUrl??null,subscribers:e.memberCount??null,placementsCount:n??e.placementsCount??null,minPriceNano:r??null,tags:a??[],isMine:!0}),[e,n,r,a,c]);return t.jsx(te,{channel:N,onClick:o,isExpanded:g,onToggleExpand:l,expandedContent:p,actions:t.jsxs("div",{className:"flex items-center gap-2",children:[u?t.jsx("button",{type:"button",onClick:m=>{m.stopPropagation(),u()},className:"inline-flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground","aria-label":c("channels.unlinkAction"),children:c("common.closeSymbol")}):null,t.jsx(T,{to:f,state:b,onClick:m=>m.stopPropagation(),className:"rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-primary-foreground",children:c("listings.createAction")})]})})}const Ne=e=>["channelsList",e],ye=(e,n=10)=>fe({queryKey:Ne(e),queryFn:({pageParam:r=1})=>ae({...e,page:Number(r),limit:n}),getNextPageParam:r=>r.hasNext?r.page+1:void 0,initialPageParam:1});function ve({open:e,onOpenChange:n,title:r,children:a}){return t.jsx(le,{open:e,onOpenChange:n,children:t.jsxs(ce,{children:[t.jsx(de,{className:"fixed inset-0 z-40 bg-black/60"}),t.jsxs(ue,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(me,{className:"text-sm font-semibold text-foreground",children:r}),t.jsx(xe,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:t.jsx(W,{size:16})})]}),t.jsx("div",{className:"pt-2",children:a})]})]})})}const je="recent",Pe="desc",Ce=["DRAFT","PENDING_VERIFY","FAILED","REVOKED"],ke=()=>t.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(j,{className:"h-4 w-32"}),t.jsx(j,{className:"h-3 w-20"})]}),t.jsx(j,{className:"h-5 w-24 rounded-full"})]}),t.jsx("div",{className:"mt-4",children:t.jsx(j,{className:"h-16 rounded-xl"})})]}),Ee=e=>{if(!e)return null;const n=e.filter(a=>a.isActive!==!1),r=n.reduce((a,o)=>{try{const l=BigInt(o.priceNano);return a===null||l<a?l:a}catch{return a}},null);return{placementsCount:n.length,minPriceNano:r?r.toString():null}},Se=e=>{if(!e?.length)return[];const n=e.flatMap(r=>r.tags??[]);return Array.from(new Set(n.map(r=>r.trim()).filter(Boolean)))};function _e(){const{t:e}=L(),[n,r]=i.useState("verified"),[a,o]=i.useState(null),[l,g]=i.useState(!1),[p,u]=i.useState(()=>new Set),[f,b]=i.useState(()=>new Set),[c,N]=i.useState({}),m=Z(),M=i.useMemo(()=>({sort:je,order:Pe,includeListings:!0}),[]),{data:P,isLoading:F,isFetchingNextPage:C,fetchNextPage:A,hasNextPage:O,refetch:D,error:y}=ye(M,10),E=i.useMemo(()=>P?.pages.flatMap(s=>s.items)??[],[P]),h=i.useMemo(()=>E.filter(s=>!p.has(s.id)),[E,p]),B=P?.pages?.[0]?.total??0;i.useEffect(()=>{y&&v.error(k(y,e("channels.loadError")))},[y,e]);const U=i.useMemo(()=>h.filter(s=>s.status==="VERIFIED"),[h]),z=i.useMemo(()=>h.filter(s=>Ce.includes(s.status)),[h]),S=n==="verified"?U:z,Q=e(n==="pending"?"channels.emptyPending":"channels.emptyVerified"),V=s=>{if(s.status==="PENDING_VERIFY"){m(`/channels/pending/${s.id}`,{state:{channel:s,rootBackTo:"/channels"}});return}m(`/channel-manage/${s.id}/listings`,{state:{channel:s,rootBackTo:"/channels"}})},_=i.useCallback(s=>{b(x=>{const d=new Set(x);return d.has(s)?d.delete(s):d.add(s),d})},[]),$=async()=>{if(a){g(!0);try{const s=await ie({channelId:a.id});s.unlinked?(u(x=>{const d=new Set(x);return d.add(s.channelId),d}),v.success(e("channels.unlinkSuccess"))):v.error(e("channels.unlinkError")),o(null)}catch(s){v.error(k(s,e("channels.unlinkError")))}finally{g(!1)}}};return t.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col",children:[t.jsxs(ge,{className:"pt-4 space-y-6",children:[F?t.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,x)=>t.jsx(ke,{},`channel-skeleton-${x}`))}):y?t.jsx(oe,{message:k(y,e("channels.loadError")),description:e("errors.genericSubtitle"),onRetry:()=>D()}):h.length===0?t.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[t.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:e("channels.emptyIcon")}),t.jsx("p",{className:"text-sm font-semibold text-foreground",children:e("channels.emptyTitle")}),t.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:e("channels.emptySubtitle")}),t.jsx(T,{to:"/add-channel/step-1",className:"mt-4 inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:e("channels.addAction")})]}):t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"border-t border-border/50",children:t.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(s=>t.jsx("button",{onClick:()=>r(s),className:`py-3 text-sm font-medium border-b-2 transition-colors ${n===s?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:e(s==="verified"?"channels.tabs.verified":"channels.tabs.pending")},s))})}),S.length>0?t.jsx("div",{className:"space-y-3",children:S.map(s=>{const x=f.has(s.id),d=s.status==="VERIFIED",w=Ee(s.listings),R=c[s.id],K=w?.placementsCount??R?.placementsCount??null,q=w?.minPriceNano??R?.minPriceNano??null,G=Se(s.listings);return t.jsx(be,{channel:s,placementsCount:K,minPriceNano:q,tags:G,onClick:()=>V(s),onUnlink:n==="pending"?()=>{o(s)}:void 0,isExpanded:x,onToggleExpand:d?()=>_(s.id):void 0,expandedContent:d?t.jsx(se,{channelId:s.id,isExpanded:x,onSummaryChange:Y=>{N(X=>({...X,[s.id]:Y}))}}):null,createListingTo:`/channel-manage/${s.id}/listings/create`,createListingState:{channel:s,rootBackTo:"/channels"}},s.id)})}):t.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:Q})]}),h.length>0?t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:e("channels.showingCount",{visible:h.length,total:B})}),O?t.jsxs("button",{type:"button",onClick:()=>A(),disabled:C,className:"inline-flex items-center gap-2 rounded-lg border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[C?t.jsx(ee,{size:14,className:"animate-spin"}):null,e(C?"common.loading":"common.loadMore")]}):null]}):null]}),t.jsx("button",{type:"button",onClick:()=>m("/add-channel/step-1"),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":e("channels.addAction"),children:t.jsx(he,{size:18})}),t.jsxs(ve,{open:!!a,onOpenChange:s=>{s||o(null)},title:e("channels.unlinkTitle"),children:[t.jsxs("p",{className:"text-sm text-muted-foreground",children:[e("channels.unlinkPrompt")," ",t.jsxs("span",{className:"font-semibold text-foreground",children:["@",a?.username]}),"?"]}),t.jsxs("div",{className:"mt-4 flex gap-3",children:[t.jsx("button",{type:"button",onClick:()=>o(null),className:"flex-1 rounded-lg border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:l,children:e("common.cancel")}),t.jsx("button",{type:"button",onClick:$,className:"flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:l,children:e(l?"channels.unlinking":"channels.unlinkAction")})]})]})]})}export{_e as default};
