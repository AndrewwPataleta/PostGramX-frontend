import{j as e,a as V,B as A,n as M,r as h,y as S,o as l}from"./index-BICIeX_d.js";import{u as b}from"./useMutation-CujHxW8G.js";import{A as I,a as L,b as U}from"./avatar-B0tIxYLi.js";import{B as v}from"./button-CRVBlF_l.js";import{C as j,a as N}from"./card-D1zu4Ijo.js";import{l as B,v as F}from"./channels-DiHcPzdx.js";import{g as y}from"./errorMapping-Duqv1rhn.js";import{u as P}from"./useAddChannelFlow-DQP9y5Ax.js";const R=A("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function G({className:n,variant:a,...c}){return e.jsx("div",{className:V(R({variant:a}),n),...c})}const C=n=>n==null?null:new Intl.NumberFormat("en",{notation:"compact"}).format(n),O=n=>{const a=String(n.status??"").toUpperCase();return["VERIFIED","SUCCESS","OK"].includes(a)},J=()=>{const n=M(),{state:a,setLinkedChannelId:c,setLinkStatus:d,setVerifyStatus:i,setLastError:o}=P(),s=a.preview;h.useEffect(()=>{s||n("/add-channel/step-1",{replace:!0})},[n,s]);const w=h.useMemo(()=>s?.username?s.username.startsWith("@")?s.username:`@${s.username}`:"â€”",[s?.username]),g=b({mutationFn:r=>B({username:r}),onMutate:()=>{d("loading"),o(null)},onSuccess:r=>{d("success"),c(r.id),i("idle"),l.success("Channel linked")},onError:r=>{const t=y(r);d("error"),o(t),l.error(t)}}),p=b({mutationFn:r=>F({id:r}),onMutate:()=>{i("loading"),o(null)},onSuccess:r=>{if(O(r)){i("success"),o(null),n("/add-channel/step-3");return}const t=typeof r.error=="string"?r.error:r.error?.message||"Verification failed. Please try again.";i("error"),o(t),l.error(t),n("/add-channel/step-3")},onError:r=>{const t=y(r);i("error"),o(t),l.error(t),n("/add-channel/step-3")}}),k=()=>{if(!s)return;const r=(s.normalizedUsername||s.username||"").replace(/^@/,"");if(!a.linkedChannelId){if(!r){l.error("Missing channel username.");return}g.mutate(r);return}p.mutate(a.linkedChannelId)},m=g.isPending||p.isPending,u=!!a.linkedChannelId,E=u?"Verify channel":"Connect channel",x=C(s?.memberCount),f=C(s?.avgViews);return s?e.jsxs("div",{className:"flex flex-1 flex-col gap-4",children:[e.jsx(j,{className:"border-border/60 bg-card/80 shadow-sm",children:e.jsxs(N,{className:"space-y-4 p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(I,{className:"h-12 w-12",children:[s.photoUrl||s.avatarUrl?e.jsx(L,{src:s.photoUrl??s.avatarUrl??""}):null,e.jsx(U,{className:"bg-secondary text-sm font-semibold text-foreground",children:(s.title||"C").charAt(0)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:w})]}),e.jsx(G,{variant:"secondary",className:"text-[10px] uppercase",children:u?"Linked":"Not connected yet"})]}),(x||f)&&e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[x?e.jsxs("span",{children:[x," subscribers"]}):null,f?e.jsxs("span",{children:[f," avg views"]}):null]})]})}),e.jsx(j,{className:"border-border/60 bg-card/80 shadow-sm",children:e.jsxs(N,{className:"space-y-3 p-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Grant bot access"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will verify admin rights before money operations."})]}),e.jsxs("ol",{className:"space-y-2 text-xs text-muted-foreground",children:[e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"1."}),"Open channel settings"]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"2."}),"Add @PostGramXBot as admin"]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"3."}),'Enable "Post messages" permission']})]})]})}),e.jsxs("div",{className:"mt-auto flex flex-col gap-3",children:[e.jsx(v,{onClick:k,disabled:m,className:"w-full text-sm font-semibold",children:m?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"h-4 w-4 animate-spin"}),u?"Verifying":"Connecting"]}):E}),e.jsx(v,{variant:"secondary",onClick:()=>n("/add-channel/step-1"),disabled:m,className:"w-full text-sm font-semibold",children:"Back"})]})]}):null};export{J as default};
