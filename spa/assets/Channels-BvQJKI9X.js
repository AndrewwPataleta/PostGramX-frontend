import{F as R,G as W,H as Z,a as I,r as i,j as t,E as M,X as ee,u as te,b as j,R as g,L as se}from"./index-DlDxQsQy.js";import{C as re,a as ne}from"./ChannelListingsPreview-0wbPwGYA.js";import{Q as ae,a as ie}from"./useQuery-Cn0tRff1.js";import{p as oe,u as le}from"./channelsApi-DkN7auD4.js";import{E as ce}from"./ErrorState-Co1iUZBI.js";import{R as de,P as ue,O as me,C as xe,T as ge,a as he}from"./index-D3vwZw3e.js";import{S as P}from"./skeleton-BigKY-_w.js";import{P as pe}from"./PageContainer-n8aAC0Fj.js";import{g as S}from"./errors-3kY4UU5q.js";import{C as f}from"./channels-CCH0-4EZ.js";import{P as fe}from"./plus-BSTdv3RF.js";import"./formatters-CG109iVp.js";import"./ton-ClBVV2oW.js";import"./labels-EEWNt0UM.js";import"./tagOptions-DHtvjoWf.js";import"./chevron-down-BoQ5C1rB.js";import"./listingsApi-CLtGxVxv.js";import"./refresh-ccw-DzJotPdu.js";import"./Combination-gImN288B.js";var be=class extends ae{constructor(e,r){super(e,r)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:R()})}getOptimisticResult(e){return e.behavior=R(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,r){const{state:n}=e,a=super.createResult(e,r),{isFetching:o,isRefetching:l,isError:h,isRefetchError:b}=a,u=n.fetchMeta?.fetchMore?.direction,N=h&&u==="forward",y=o&&u==="forward",c=h&&u==="backward",v=o&&u==="backward";return{...a,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:Z(r,n.data),hasPreviousPage:W(r,n.data),isFetchNextPageError:N,isFetchingNextPage:y,isFetchPreviousPageError:c,isFetchingPreviousPage:v,isRefetchError:b&&!N&&!c,isRefetching:l&&!y&&!v}}};function Ne(e,r){return ie(e,be)}function ye({channel:e,placementsCount:r,minPriceNano:n,tags:a,onClick:o,onToggleExpand:l,isExpanded:h,expandedContent:b,onUnlink:u,createListingTo:N,createListingState:y}){const{t:c}=I(),v=i.useMemo(()=>({id:e.id,name:e.title||c("channels.untitled"),username:e.username,avatarUrl:e.avatarUrl??null,subscribers:e.memberCount??null,placementsCount:r??e.placementsCount??null,minPriceNano:n??null,tags:a??[],isMine:!0}),[e,r,n,a,c]);return t.jsx(re,{channel:v,onClick:o,isExpanded:h,onToggleExpand:l,expandedContent:b,actions:t.jsxs("div",{className:"flex items-center gap-2",children:[u?t.jsx("button",{type:"button",onClick:m=>{m.stopPropagation(),u()},className:"inline-flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground","aria-label":c("channels.unlinkAction"),children:c("common.closeSymbol")}):null,t.jsx(M,{to:N,state:y,onClick:m=>m.stopPropagation(),className:"rounded-lg bg-primary px-3 py-1.5 text-[11px] font-semibold text-primary-foreground",children:c("listings.createAction")})]})})}const ve=e=>["channelsList",e],Ce=(e,r=10)=>Ne({queryKey:ve(e),queryFn:({pageParam:n=1})=>oe({...e,page:Number(n),limit:r}),getNextPageParam:n=>n.hasNext?n.page+1:void 0,initialPageParam:1});function je({open:e,onOpenChange:r,title:n,children:a}){return t.jsx(de,{open:e,onOpenChange:r,children:t.jsxs(ue,{children:[t.jsx(me,{className:"fixed inset-0 z-40 bg-black/60"}),t.jsxs(xe,{className:"fixed inset-x-0 bottom-0 z-50 rounded-t-3xl border border-border/60 bg-card p-4 pb-[calc(var(--tg-content-safe-area-inset-bottom)+16px)] shadow-lg",children:[t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx(ge,{className:"text-sm font-semibold text-foreground",children:n}),t.jsx(he,{className:"rounded-full p-2 text-muted-foreground hover:text-foreground",children:t.jsx(ee,{size:16})})]}),t.jsx("div",{className:"pt-2",children:a})]})]})})}const Pe="recent",Ee="desc",ke=[f.DRAFT,f.PENDING_VERIFY,f.FAILED,f.REVOKED],Se=()=>t.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(P,{className:"h-4 w-32"}),t.jsx(P,{className:"h-3 w-20"})]}),t.jsx(P,{className:"h-5 w-24 rounded-full"})]}),t.jsx("div",{className:"mt-4",children:t.jsx(P,{className:"h-16 rounded-xl"})})]}),Ae=e=>{if(!e)return null;const r=e.filter(a=>a.isActive!==!1),n=r.reduce((a,o)=>{try{const l=BigInt(o.priceNano);return a===null||l<a?l:a}catch{return a}},null);return{placementsCount:r.length,minPriceNano:n?n.toString():null}},Le=e=>{if(!e?.length)return[];const r=e.flatMap(n=>n.tags??[]);return Array.from(new Set(r.map(n=>n.trim()).filter(Boolean)))};function $e(){const{t:e}=I(),[r,n]=i.useState("verified"),[a,o]=i.useState(null),[l,h]=i.useState(!1),[b,u]=i.useState(()=>new Set),[N,y]=i.useState(()=>new Set),[c,v]=i.useState({}),m=te(),D=i.useMemo(()=>({sort:Pe,order:Ee,includeListings:!0}),[]),{data:E,isLoading:F,isFetchingNextPage:k,fetchNextPage:_,hasNextPage:O,refetch:H,error:C}=Ce(D,10),A=i.useMemo(()=>E?.pages.flatMap(s=>s.items)??[],[E]),p=i.useMemo(()=>A.filter(s=>!b.has(s.id)),[A,b]),U=E?.pages?.[0]?.total??0;i.useEffect(()=>{C&&j.error(S(C,e("channels.loadError")))},[C,e]);const B=i.useMemo(()=>p.filter(s=>s.status===f.VERIFIED),[p]),G=i.useMemo(()=>p.filter(s=>ke.includes(s.status)),[p]),L=r==="verified"?B:G,z=e(r==="pending"?"channels.emptyPending":"channels.emptyVerified"),Q=s=>{if(s.status===f.PENDING_VERIFY){m(g.CHANNEL_PENDING(s.id),{state:{channel:s,rootBackTo:g.CHANNELS}});return}m(g.CHANNEL_MANAGE_LISTINGS(s.id),{state:{channel:s,rootBackTo:g.CHANNELS}})},V=i.useCallback(s=>{y(x=>{const d=new Set(x);return d.has(s)?d.delete(s):d.add(s),d})},[]),K=async()=>{if(a){h(!0);try{const s=await le({channelId:a.id});s.unlinked?(u(x=>{const d=new Set(x);return d.add(s.channelId),d}),j.success(e("channels.unlinkSuccess"))):j.error(e("channels.unlinkError")),o(null)}catch(s){j.error(S(s,e("channels.unlinkError")))}finally{h(!1)}}};return t.jsxs("div",{className:"mx-auto flex w-full max-w-2xl flex-col",children:[t.jsxs(pe,{className:"pt-4 space-y-6",children:[F?t.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,x)=>t.jsx(Se,{},`channel-skeleton-${x}`))}):C?t.jsx(ce,{message:S(C,e("channels.loadError")),description:e("errors.genericSubtitle"),onRetry:()=>H()}):p.length===0?t.jsxs("div",{className:"rounded-2xl border border-dashed border-border/60 bg-card/70 p-8 text-center",children:[t.jsx("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-primary/10 text-2xl",children:e("channels.emptyIcon")}),t.jsx("p",{className:"text-sm font-semibold text-foreground",children:e("channels.emptyTitle")}),t.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:e("channels.emptySubtitle")}),t.jsx(M,{to:g.ADD_CHANNEL_STEP("step-1"),className:"mt-4 inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",children:e("channels.addAction")})]}):t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"border-t border-border/50",children:t.jsx("div",{className:"flex gap-6 bg-background/90 backdrop-blur-glass",children:["verified","pending"].map(s=>t.jsx("button",{onClick:()=>n(s),className:`py-3 text-sm font-medium border-b-2 transition-colors ${r===s?"text-primary border-b-primary":"text-muted-foreground border-b-transparent"}`,children:e(s==="verified"?"channels.tabs.verified":"channels.tabs.pending")},s))})}),L.length>0?t.jsx("div",{className:"space-y-3",children:L.map(s=>{const x=N.has(s.id),d=s.status===f.VERIFIED,w=Ae(s.listings),T=c[s.id],q=w?.placementsCount??T?.placementsCount??null,Y=w?.minPriceNano??T?.minPriceNano??null,$=Le(s.listings);return t.jsx(ye,{channel:s,placementsCount:q,minPriceNano:Y,tags:$,onClick:()=>Q(s),onUnlink:r==="pending"?()=>{o(s)}:void 0,isExpanded:x,onToggleExpand:d?()=>V(s.id):void 0,expandedContent:d?t.jsx(ne,{channelId:s.id,isExpanded:x,onSummaryChange:X=>{v(J=>({...J,[s.id]:X}))}}):null,createListingTo:g.CHANNEL_MANAGE_LISTINGS_CREATE(s.id),createListingState:{channel:s,rootBackTo:g.CHANNELS}},s.id)})}):t.jsx("p",{className:"rounded-xl border border-dashed border-border/60 bg-card/70 px-4 py-3 text-xs text-muted-foreground",children:z})]}),p.length>0?t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:e("channels.showingCount",{visible:p.length,total:U})}),O?t.jsxs("button",{type:"button",onClick:()=>_(),disabled:k,className:"inline-flex items-center gap-2 rounded-lg border border-border/60 bg-card/80 px-4 py-2 text-xs font-semibold text-foreground transition hover:bg-card",children:[k?t.jsx(se,{size:14,className:"animate-spin"}):null,e(k?"common.loading":"common.loadMore")]}):null]}):null]}),t.jsx("button",{type:"button",onClick:()=>m(g.ADD_CHANNEL_STEP("step-1")),className:"fixed bottom-[calc(var(--tg-content-safe-area-inset-bottom)+120px)] right-4 z-40 flex h-12 w-12 items-center justify-center rounded-2xl bg-primary text-primary-foreground shadow-lg shadow-primary/30 transition hover:bg-primary/90","aria-label":e("channels.addAction"),children:t.jsx(fe,{size:18})}),t.jsxs(je,{open:!!a,onOpenChange:s=>{s||o(null)},title:e("channels.unlinkTitle"),children:[t.jsxs("p",{className:"text-sm text-muted-foreground",children:[e("channels.unlinkPrompt")," ",t.jsxs("span",{className:"font-semibold text-foreground",children:["@",a?.username]}),"?"]}),t.jsxs("div",{className:"mt-4 flex gap-3",children:[t.jsx("button",{type:"button",onClick:()=>o(null),className:"flex-1 rounded-lg border border-border/60 bg-background px-4 py-2 text-sm font-semibold text-foreground",disabled:l,children:e("common.cancel")}),t.jsx("button",{type:"button",onClick:K,className:"flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-600 disabled:cursor-not-allowed disabled:opacity-70",disabled:l,children:e(l?"channels.unlinking":"channels.unlinkAction")})]})]})]})}export{$e as default};
