import{a as N,r as f,j as e,h as g,f as P,b as p,p as w,i as Q,k as K,u as Z,d as z,e as J}from"./index-CA2fCERY.js";import{u as _}from"./useQuery-DJpe_K8G.js";import{a as V,b as A}from"./formatters-B6oyEeL1.js";import{f as X,h as W,b as ee,c as te}from"./labels-EEWNt0UM.js";import{C as se}from"./chevron-left-C0wMZNZl.js";import{C as re,S as ne}from"./ScheduleDatePicker-Bijpp0VF.js";import{a as oe,f as ae}from"./dealsApi-BKGKB9gM.js";import{L as de}from"./LoadingSkeleton-PuSq8LgY.js";import{E as le}from"./ErrorState-DkRqng3d.js";import{P as ie}from"./PageContainer-Bu9wny2F.js";import{g as v}from"./errors-3kY4UU5q.js";import{u as S}from"./useMutation-BlOjg5eX.js";import{t as O}from"./date-DTgQQEB1.js";import{o as $}from"./telegramLinks-DFMIlj7w.js";import{b as ce}from"./payment-DrNyEbSw.js";import"./button-PwXQVnKZ.js";import"./skeleton-CTPNRCIb.js";function ue({deal:t}){const{t:r,language:n}=N(),[a,s]=f.useState(!1),d=`${V(t.listing.priceNano,n)} ${r("common.ton")}`,l=X(r,t.listing.format),i=t.listing.tags??[],c=t.listing.pinDurationHours??t.listing.placementHours,u=t.listing.visibilityDurationHours??t.listing.lifetimeHours,x=f.useMemo(()=>[{label:r("listings.pinDuration"),value:c?W(c,r):r("common.none")},{label:r("listings.lifetimeDuration"),value:u?W(u,r):r("common.emptyValue")},{label:r("listings.allowEdits.label"),value:t.listing.allowEdits===void 0?r("common.emptyValue"):ee(r,t.listing.allowEdits)},{label:r("listings.allowLinkTracking.label"),value:t.listing.allowLinkTracking===void 0?r("common.emptyValue"):te(r,t.listing.allowLinkTracking)}],[t.listing.allowEdits,t.listing.allowLinkTracking,c,u,r]);return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center overflow-hidden rounded-full bg-secondary/60 text-lg font-semibold text-muted-foreground",children:t.channel.avatarUrl?e.jsx("img",{src:t.channel.avatarUrl,alt:t.channel.name,className:"h-full w-full object-cover"}):t.channel.name.slice(0,1)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-foreground",children:[e.jsx("span",{className:"truncate",children:t.channel.name}),t.channel.verified?e.jsx("span",{className:"rounded-full bg-emerald-500/10 px-2 py-0.5 text-[10px] font-semibold text-emerald-400",children:r("channels.verifiedBadge")}):null]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",t.channel.username]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:d}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"button",onClick:()=>s(o=>!o),className:"flex w-full items-center justify-between rounded-lg border border-border/60 bg-background/60 px-3 py-2 text-xs font-semibold text-muted-foreground transition hover:text-foreground",children:[e.jsx("span",{children:r(a?"common.hideDetails":"common.more")}),e.jsx("span",{className:g("text-xs",a?"text-foreground":"text-muted-foreground"),children:r(a?"common.collapseSymbol":"common.expandSymbol")})]})}),a?e.jsxs("div",{className:"mt-4 space-y-3 text-xs text-muted-foreground",children:[i.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:i.map(o=>e.jsxs("span",{className:"rounded-full bg-secondary/60 px-3 py-1 text-xs font-medium text-foreground",children:["#",o]},o))}):null,e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:x.map(o=>e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-[11px] uppercase tracking-wide text-muted-foreground",children:o.label}),e.jsx("span",{className:"font-semibold text-foreground",children:o.value})]},o.label))}),t.listing.contentRulesText?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-muted-foreground",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-wide text-foreground/80",children:r("listings.rulesTitle")}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t.listing.contentRulesText})]}):null]}):null]})}const M=["SCHEDULE","SEND_POST","CONFIRM_POST","ADMIN_APPROVAL","PAYMENT_WINDOW","PAYMENT","PAYMENT_PENDING","SCHEDULED","VERIFYING","DONE"],me=[...M],xe={SCHEDULING_PENDING:"SCHEDULE",CREATIVE_AWAITING_SUBMIT:"SEND_POST",CREATIVE_AWAITING_CONFIRM:"CONFIRM_POST",ADMIN_REVIEW:"ADMIN_APPROVAL",PAYMENT_WINDOW_PENDING:"PAYMENT_WINDOW",AWAITING_PAYMENT:"PAYMENT",FUNDS_PENDING:"PAYMENT_PENDING",FUNDS_CONFIRMED:"SCHEDULED",APPROVED_SCHEDULED:"SCHEDULED",POSTED_VERIFYING:"VERIFYING",COMPLETED:"DONE",CANCELED:"DONE",REFUNDED:"DONE",DISPUTED:"DONE"},H=t=>xe[t]??"SCHEDULE",F=(t,r)=>r(`deals.timeline.stage.${t}`),pe=(t,r)=>r(`deals.escrowStatus.${t}`),ge=(t,r)=>{const n=H(r);return M.indexOf(t)<=M.indexOf(n)};function fe({stages:t,selectedStage:r,escrowStatus:n,onSelect:a}){const{t:s}=N(),d=t.indexOf(r),l=d>0?t[d-1]:null,i=d>=0&&d<t.length-1?t[d+1]:null,c=!!a;return e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s("deals.timeline.title")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s("deals.timeline.steps",{count:t.length})})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[c?e.jsx("button",{type:"button",onClick:()=>l&&a?.(l),disabled:!l,className:g("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",l?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":s("deals.timeline.previousStage"),children:e.jsx(se,{className:"h-4 w-4"})}):null,e.jsx("div",{className:"flex flex-1 flex-wrap gap-2",children:t.map(u=>{const x=u===r,o=!ge(u,n),D=g("rounded-full border px-3 py-1 text-xs font-semibold transition",x?"border-blue-500 bg-blue-600 text-white":"border-border/60 bg-background/50 text-muted-foreground",c&&!o?"hover:border-primary/40 hover:text-foreground":"opacity-70");return c?e.jsx("button",{type:"button",onClick:()=>a?.(u),disabled:o,className:g(D,o?"cursor-not-allowed opacity-40":"hover:border-primary/40 hover:text-foreground"),children:F(u,s)},u):e.jsx("div",{className:D,children:F(u,s)},u)})}),c?e.jsx("button",{type:"button",onClick:()=>i&&a?.(i),disabled:!i,className:g("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",i?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":s("deals.timeline.nextStage"),children:e.jsx(re,{className:"h-4 w-4"})}):null]})]})}function h({title:t,children:r}){return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t})}),e.jsx("div",{className:"mt-3 space-y-2 text-xs text-muted-foreground",children:r})]})}const U=t=>{if(!t)return null;const r=new Date(t);return Number.isNaN(r.getTime())?null:r};function be({deal:t,readonly:r,onAction:n}){const a=P(),{t:s,language:d}=N(),[l,i]=f.useState(U(t.scheduledAt)),c=f.useMemo(()=>l?l.getTime()>Date.now()+3600*1e3:!1,[l]);f.useEffect(()=>{i(U(t.scheduledAt))},[t.scheduledAt]);const u=S({mutationFn:async()=>{if(!l||!c)throw new Error(s("deals.stage.scheduleTime.selectDateError"));const o=O(l);if(!o.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",o),new Error("Invalid datetime format");return console.log("Schedule payload UTC:",o),w("/deals/schedule",{dealId:t.id,scheduledAt:o})},onSuccess:()=>{p.success(s("deals.stage.scheduleTime.updatedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:o=>{p.error(v(o,s("deals.stage.scheduleTime.saveError")))}});if(r)return e.jsxs(h,{title:s("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduleTime.readonly")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.scheduledAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:t.scheduledAt?A(t.scheduledAt,d):s("deals.stage.scheduleTime.notScheduled")})]})]});const x=()=>{if(!l||!c){p.error(s("deals.stage.scheduleTime.selectDateError"));return}if(n?.onConfirmSchedule){const o=O(l);if(!o.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",o),new Error("Invalid datetime format");n.onConfirmSchedule(o);return}u.mutate()};return e.jsxs(h,{title:s("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduleTime.description")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"pb-safe-bottom rounded-2xl border border-border/60 bg-card/80 p-3",children:e.jsx(ne,{value:l,onChange:i})}),e.jsx("button",{type:"button",onClick:x,disabled:u.isPending||!c,className:g("w-full rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",u.isPending||!c?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:s("deals.stage.scheduleTime.confirm")})]})]})}const he="postgramx_bot";function ye({deal:t,readonly:r,onAction:n}){const a=P(),{t:s}=N(),d=`https://t.me/${he}?start=deal_${t.id}`,l=!!t.creativeText,i=S({mutationFn:async()=>w("/deals/creative/submit",{dealId:t.id}),onSuccess:()=>{p.success(s("deals.stage.sendPost.submittedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:x=>{p.error(v(x,s("deals.stage.sendPost.submitError")))}});if(r)return e.jsxs(h,{title:s("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.sendPost.readonly")}),l?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:s("deals.stage.sendPost.creativeSubmitted")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.sendPost.noCreative")})]});const c=()=>{if(n?.onOpenBot){n.onOpenBot();return}$(d)},u=()=>{if(n?.onConfirmSent){n.onConfirmSent();return}i.mutate()};return e.jsxs(h,{title:s("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.sendPost.description")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:c,className:"rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition hover:bg-primary/90",children:s("deals.stage.sendPost.openBot")}),e.jsx("button",{type:"button",onClick:u,disabled:i.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",i.isPending&&"cursor-not-allowed opacity-60"),children:s("deals.stage.sendPost.confirmSent")})]}),l?e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.sendPost.waitingReview")}):null]})}function Ne({deal:t,readonly:r,onAction:n}){const a=P(),{t:s}=N(),d=t.creativeText,l=S({mutationFn:async()=>w("/deals/creative/confirm",{dealId:t.id}),onSuccess:()=>{p.success(s("deals.stage.confirmPost.confirmedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:x=>{p.error(v(x,s("deals.stage.confirmPost.confirmError")))}}),i=S({mutationFn:async()=>w("/deals/creative/reject",{dealId:t.id}),onSuccess:()=>{p.success(s("deals.stage.confirmPost.requestedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:x=>{p.error(v(x,s("deals.stage.confirmPost.requestError")))}});if(r)return e.jsxs(h,{title:s("deals.stage.confirmPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.confirmPost.readonly")}),d?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:d}):e.jsx("div",{className:"rounded-lg border border-dashed border-border/60 bg-background/40 p-3 text-xs text-muted-foreground",children:s("deals.stage.confirmPost.waitingCreative")})]});const c=()=>{if(n?.onConfirm){n.onConfirm();return}l.mutate()},u=()=>{if(n?.onRequestChanges){n.onRequestChanges();return}i.mutate()};return e.jsxs(h,{title:s("deals.stage.confirmPost.title"),children:[d?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:d}):e.jsx("div",{className:"rounded-lg border border-dashed border-border/60 bg-background/40 p-3 text-xs text-muted-foreground",children:s("deals.stage.confirmPost.waitingCreative")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:c,disabled:!d||l.isPending,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",!d||l.isPending?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:s("common.confirm")}),e.jsx("button",{type:"button",onClick:u,disabled:!d||i.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",!d||i.isPending?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:s("common.requestChanges")})]})]})}function je({deal:t,readonly:r,onAction:n}){const a=P(),{t:s}=N(),d=S({mutationFn:async()=>w("/deals/creative/approve",{dealId:t.id}),onSuccess:()=>{p.success(s("deals.stage.adminApproval.approvedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:o=>{p.error(v(o,s("deals.stage.adminApproval.approveError")))}}),l=S({mutationFn:async()=>w("/deals/creative/edits",{dealId:t.id}),onSuccess:()=>{p.success(s("deals.stage.adminApproval.requestedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:o=>{p.error(v(o,s("deals.stage.adminApproval.requestError")))}}),i=S({mutationFn:async()=>w("/deals/creative/reject",{dealId:t.id}),onSuccess:()=>{p.success(s("deals.stage.adminApproval.rejectedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:o=>{p.error(v(o,s("deals.stage.adminApproval.rejectError")))}});if(r)return e.jsx(h,{title:s("deals.stage.adminApproval.title"),children:e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.adminApproval.readonly")})});const c=()=>{if(n?.onApprove){n.onApprove();return}d.mutate()},u=()=>{if(n?.onRequestChanges){n.onRequestChanges();return}l.mutate()},x=()=>{if(n?.onReject){n.onReject();return}i.mutate()};return e.jsxs(h,{title:s("deals.stage.adminApproval.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.adminApproval.description")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:c,disabled:d.isPending,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",d.isPending&&"cursor-not-allowed opacity-60"),children:s("common.approve")}),e.jsx("button",{type:"button",onClick:u,disabled:l.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",l.isPending&&"cursor-not-allowed opacity-60"),children:s("common.requestChanges")}),e.jsx("button",{type:"button",onClick:x,disabled:i.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",i.isPending&&"cursor-not-allowed opacity-60"),children:s("common.reject")})]})]})}const q=[1,2,24],ve=(t,r)=>{if(!t)return null;const n=new Date(t).getTime();if(Number.isNaN(n))return null;const a=Math.max(0,n-Date.now()),s=Math.floor(a/36e5),d=Math.floor(a%36e5/6e4);return`${s}${r("common.hoursShort")} ${d}${r("common.minutesShort")}`};function Ee({deal:t,readonly:r,onAction:n}){const a=P(),{t:s}=N(),[d,l]=f.useState(q[0]),i=S({mutationFn:async()=>w("/deals/payment-window",{dealId:t.id,hours:d}),onSuccess:()=>{p.success(s("deals.stage.paymentWindow.updatedToast")),a.invalidateQueries({queryKey:["deal",t.id]})},onError:x=>{p.error(v(x,s("deals.stage.paymentWindow.saveError")))}}),c=f.useMemo(()=>ve(t.escrowExpiresAt,s),[t.escrowExpiresAt,s]),u=()=>{if(n?.onSetWindow){n.onSetWindow(d);return}i.mutate()};return e.jsxs(h,{title:s("deals.stage.paymentWindow.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.paymentWindow.description")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:q.map(x=>e.jsx("button",{type:"button",onClick:()=>l(x),disabled:r,className:g("rounded-full border px-3 py-1 text-xs font-semibold",x===d?"border-primary/50 bg-primary/15 text-primary-foreground":"border-border/60 bg-background/50 text-muted-foreground",r&&"cursor-not-allowed opacity-60"),children:s("deals.stage.paymentWindow.option",{hours:x})},x))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:u,disabled:r||i.isPending,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",r||i.isPending?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:s("deals.stage.paymentWindow.confirm")}),c?e.jsx("span",{className:"text-xs text-muted-foreground",children:s("deals.stage.paymentWindow.expiresIn",{time:c})}):null]})]})}const we=t=>{const r=Math.max(0,Math.floor(t/1e3)),n=Math.floor(r/60).toString().padStart(2,"0"),a=(r%60).toString().padStart(2,"0");return`${n}:${a}`},Se=t=>t.length<=10?t:`${t.slice(0,3)}...${t.slice(-3)}`;function De({deal:t,readonly:r,onAction:n,isRefreshing:a}){const{t:s,language:d}=N(),{open:l}=Q(),{isConnected:i,walletAppName:c,network:u}=K(),[x,o]=f.useState(!1),[D,m]=f.useState(null),C=t.escrowAmountNano??t.listing.priceNano,E=t.paymentAddress??"",k=C?`${V(C,d)} ${s("common.ton")}`:s("common.emptyValue"),j=f.useMemo(()=>{if(!i)return s("deals.stage.payment.walletDisconnected");const y=u?` • ${u}`:"";return`${s("deals.stage.payment.walletConnected")}${c?` • ${c}`:""}${y}`},[i,u,s,c]);if(f.useEffect(()=>{if(!t.paymentExpiresAt){m(null);return}const y=new Date(t.paymentExpiresAt).getTime();if(Number.isNaN(y)){m(null);return}const R=()=>{const B=Math.max(0,y-Date.now());m(we(B))};R();const Y=window.setInterval(R,1e3);return()=>window.clearInterval(Y)},[t.paymentExpiresAt]),f.useEffect(()=>{o(!1)},[t.id,t.escrowStatus]),t.escrowStatus!=="AWAITING_PAYMENT")return null;const I=()=>{r||l()},b=()=>{if(!(r||!E||!C))try{const y=ce({address:E,amountNano:C,memo:`Deal:${t.id}`});if(!window.open(y,"_blank")){p.error(s("deals.stage.payment.paymentCanceled"));return}o(!0)}catch(y){p.error(y instanceof Error?y.message:s("deals.stage.payment.paymentCanceled"))}},L=async()=>{if(E)try{await navigator.clipboard.writeText(E),p.success(s("deals.stage.payment.addressCopied"))}catch(y){p.error(y instanceof Error?y.message:s("deals.stage.payment.copyFailed"))}};return e.jsxs(h,{title:s("deals.stage.payment.title"),children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",i?"bg-emerald-400":"bg-muted-foreground/50")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:j})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"rounded-xl border border-border/60 bg-background/40 p-3",children:e.jsxs("div",{className:"space-y-2 text-xs text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:s("deals.stage.payment.amountToPay")}),": ",k]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:s("deals.stage.payment.receiver")}),": ",E?Se(E):s("common.emptyValue")]}),D?e.jsx("p",{children:e.jsx("span",{className:"font-semibold text-foreground",children:s("deals.stage.payment.expiresIn",{time:D})})}):null]})}),x?e.jsxs("div",{className:"flex flex-wrap items-center gap-3 rounded-xl border border-border/60 bg-secondary/30 px-3 py-2",children:[e.jsx("span",{className:"inline-flex h-4 w-4 items-center justify-center rounded-full border border-border/60",children:e.jsx("span",{className:"h-2 w-2 animate-spin rounded-full border-2 border-muted-foreground border-t-transparent"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s("deals.stage.payment.waiting")})]}):null,e.jsx("div",{className:"flex flex-wrap gap-2",children:i?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:b,disabled:r||x,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",r||x?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:s("deals.stage.payment.payWithWallet")}),e.jsx("button",{type:"button",onClick:L,disabled:r,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition",r?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:s("deals.stage.payment.copyAddress")})]}):e.jsx("button",{type:"button",onClick:I,disabled:r,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition",r?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:s("deals.stage.payment.connectWallet")})}),x?e.jsx("button",{type:"button",onClick:n?.onRefresh,disabled:a||!n?.onRefresh,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",a||!n?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:s(a?"common.refreshing":"deals.stage.payment.checkStatus")}):null]})]})}function Ce({onAction:t,isRefreshing:r}){const{t:n}=N();return e.jsxs(h,{title:n("deals.stage.paymentPending.title"),children:[e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"rounded-full border border-emerald-400/40 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-300",children:n("deals.stage.payment.paymentDetected")})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n("deals.stage.paymentPending.description")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",onClick:t?.onRefresh,disabled:r||!t?.onRefresh,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",r||!t?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:n(r?"common.refreshing":"common.refresh")})})]})}function G({deal:t}){const{t:r,language:n}=N(),a=t.scheduledAt?A(t.scheduledAt,n):r("deals.stage.scheduled.notScheduled");return e.jsxs(h,{title:r("deals.stage.scheduled.title"),children:[t.escrowStatus==="FUNDS_CONFIRMED"?e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"rounded-full border border-emerald-400/40 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-300",children:r("deals.stage.payment.paymentDetected")})}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("deals.stage.scheduled.time"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:a})]}),t.scheduledAt?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduled.waiting")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduled.noSchedule")})]})}function Pe({deal:t}){const{t:r}=N(),n=()=>{t.postUrl&&$(t.postUrl)};return e.jsxs(h,{title:r("deals.stage.verifyingPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.verifyingPost.description")}),t.postUrl?e.jsx("button",{type:"button",onClick:n,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground","hover:border-primary/40"),children:r("deals.stage.verifyingPost.open")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.verifyingPost.pendingLink")})]})}function T({deal:t}){const{t:r,language:n}=N(),a=Z(),s=t.escrowStatus==="CANCELED",d=()=>{a(`/deals/create/${t.listing.id}`)};return e.jsxs(h,{title:r("deals.stage.done.title"),children:[s?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.payment.windowExpired")}),e.jsx("button",{type:"button",onClick:d,className:"rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition hover:border-primary/40",children:r("deals.stage.payment.createNewDeal")})]}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("deals.statusLabel"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:pe(t.escrowStatus,r)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("common.lastUpdate"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:A(t.lastActivityAt,n)||r("common.emptyValue")})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("common.createdAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:A(t.createdAt,n)||r("common.emptyValue")})]})]})}function Ye(){const{dealId:t}=z(),r=J(),n=P(),a=r.state?.deal,s=t?n.getQueryData(["deal",t]):void 0,d=a?.id===t?a:s,{data:l,isLoading:i,error:c,refetch:u,isFetching:x}=_({queryKey:["deal",t],queryFn:async()=>{if(!t)throw new Error("Missing deal id");return oe(t)},enabled:!!t,initialData:d,refetchInterval:j=>j?j.escrowStatus==="AWAITING_PAYMENT"?12e3:["FUNDS_PENDING","POSTED_VERIFYING"].includes(j.escrowStatus)?5e3:!1:!1}),o=_({queryKey:["deals","list","detail-fallback",t],queryFn:()=>ae({role:"all",pendingLimit:20,activeLimit:20,completedLimit:20}),enabled:!!t&&!l,staleTime:2e4}),D=f.useMemo(()=>!o.data||!t?null:[...o.data.pending.items,...o.data.active.items,...o.data.completed.items].find(I=>I.id===t)??null,[t,o.data]),m=l??D;f.useEffect(()=>{(c||o.error)&&p.error(v(c??o.error,"Unable to load deal"))},[c,o.error]);const C=m?H(m.escrowStatus):"SCHEDULE",E=m?me:[],k=f.useMemo(()=>{if(!m)return null;const j=m.userRoleInDeal==="advertiser",I=m.userRoleInDeal==="publisher"||m.userRoleInDeal==="publisher_manager",b=!j;return{SCHEDULING_PENDING:e.jsx(be,{deal:m,readonly:!j}),CREATIVE_AWAITING_SUBMIT:e.jsx(ye,{deal:m,readonly:!j}),CREATIVE_AWAITING_CONFIRM:e.jsx(Ne,{deal:m,readonly:!j}),ADMIN_REVIEW:e.jsx(je,{deal:m,readonly:!I}),PAYMENT_WINDOW_PENDING:e.jsx(Ee,{deal:m,readonly:b}),AWAITING_PAYMENT:e.jsx(De,{deal:m,readonly:b,onAction:b?void 0:{onRefresh:()=>u()},isRefreshing:x}),FUNDS_PENDING:e.jsx(Ce,{deal:m,readonly:b,onAction:b?void 0:{onRefresh:()=>u()},isRefreshing:x}),FUNDS_CONFIRMED:e.jsx(G,{deal:m,readonly:b}),APPROVED_SCHEDULED:e.jsx(G,{deal:m,readonly:b}),POSTED_VERIFYING:e.jsx(Pe,{deal:m,readonly:b}),COMPLETED:e.jsx(T,{deal:m,readonly:b}),CANCELED:e.jsx(T,{deal:m,readonly:b}),REFUNDED:e.jsx(T,{deal:m,readonly:b}),DISPUTED:e.jsx(T,{deal:m,readonly:b})}[m.escrowStatus]},[x,u,m]);return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(ie,{className:"py-6 space-y-4",children:i?e.jsx(de,{items:3}):c||o.error||!m?e.jsx(le,{message:v(c??o.error,"Deal not found"),description:"We couldn't load this deal right now.",onRetry:()=>u()}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{deal:m}),e.jsx(fe,{stages:E,selectedStage:C,escrowStatus:m.escrowStatus}),k]})})})}export{Ye as default};
