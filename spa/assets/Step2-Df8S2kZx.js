import{j as e,f as E,t as I,u as A,r as p,a as i,L}from"./index-4rp1-c6Q.js";import{u as b}from"./useMutation-BbJBB-t3.js";import{A as M,a as S,b as U}from"./avatar-BRurl2_D.js";import{B as j}from"./button-C4PYcfkJ.js";import{C as v,a as N}from"./card-DpDqBCV1.js";import{l as V,v as F}from"./channelsApi-5ZMyg1K1.js";import{g as y}from"./errorMapping-DTG_2VOH.js";import{u as B}from"./useAddChannelFlow-V1CS96DZ.js";const P=I("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function R({className:a,variant:t,...d}){return e.jsx("div",{className:E(P({variant:t}),a),...d})}const G=a=>a==null?null:new Intl.NumberFormat("en",{notation:"compact"}).format(a),O=a=>{const t=String(a.status??"").toUpperCase();return["VERIFIED","SUCCESS","OK"].includes(t)},J=()=>{const a=A(),{state:t,setLinkedChannelId:d,setLinkStatus:c,setVerifyStatus:l,setLastError:o}=B(),s=t.preview;p.useEffect(()=>{s||a("/add-channel/step-1",{replace:!0})},[a,s]);const C=p.useMemo(()=>s?.username?s.username.startsWith("@")?s.username:`@${s.username}`:"â€”",[s?.username]),x=b({mutationFn:r=>V({username:r}),onMutate:()=>{c("loading"),o(null)},onSuccess:r=>{const n=r.channelId??r.id;if(!n){const h="Channel link response is missing an id.";c("error"),o(h),i.error(h);return}c("success"),d(n),l("idle"),i.success("Channel linked"),m.mutate(n)},onError:r=>{const n=y(r);c("error"),o(n),i.error(n)}}),m=b({mutationFn:r=>F({id:r}),onMutate:()=>{l("loading"),o(null)},onSuccess:r=>{if(O(r)){l("success"),o(null),a("/add-channel/step-3");return}const n=typeof r.error=="string"?r.error:r.error?.message||"Verification failed. Please try again.";l("error"),o(n),i.error(n)},onError:r=>{const n=y(r);l("error"),o(n),i.error(n)}}),k=()=>{if(!s)return;const r=(s.normalizedUsername||s.username||"").replace(/^@/,"");if(!t.linkedChannelId){if(!r){i.error("Missing channel username.");return}x.mutate(r);return}m.mutate(t.linkedChannelId)},u=x.isPending||m.isPending,f=!!t.linkedChannelId,w=f?"Verify channel":"Connect channel",g=G(s?.memberCount);return s?e.jsxs("div",{className:"flex flex-1 flex-col gap-4",children:[e.jsx(v,{className:"border-border/60 bg-card/80 shadow-sm",children:e.jsxs(N,{className:"space-y-4 p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(M,{className:"h-12 w-12",children:[s.photoUrl||s.avatarUrl?e.jsx(S,{src:s.photoUrl??s.avatarUrl??""}):null,e.jsx(U,{className:"bg-secondary text-sm font-semibold text-foreground",children:(s.title||"C").charAt(0)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:C})]}),e.jsx(R,{variant:"secondary",className:"text-[10px] uppercase",children:f?"Linked":"Not connected yet"})]}),g?e.jsx("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:e.jsxs("span",{children:[g," subscribers"]})}):null]})}),e.jsx(v,{className:"border-border/60 bg-card/80 shadow-sm",children:e.jsxs(N,{className:"space-y-3 p-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Grant bot access"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will verify admin rights before money operations."})]}),e.jsxs("ol",{className:"space-y-2 text-xs text-muted-foreground",children:[e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"1."}),"Open channel settings"]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"2."}),"Add @PostGramXBot as admin"]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-foreground",children:"3."}),'Enable "Post messages" permission']})]})]})}),e.jsxs("div",{className:"mt-auto flex flex-col gap-3",children:[e.jsx(j,{onClick:k,disabled:u,className:"w-full text-sm font-semibold",children:u?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-4 w-4 animate-spin"}),f?"Verifying":"Connecting"]}):w}),e.jsx(j,{variant:"secondary",onClick:()=>a("/add-channel/step-1"),disabled:u,className:"w-full text-sm font-semibold",children:"Back"})]})]}):null};export{J as default};
