import{b as Q,d as _,r as o,j as e,L as A}from"./index-DJvvUNQ4.js";import{u as K}from"./useQuery-x36h40NO.js";import{l as W}from"./listingsApi-BPIpKeaz.js";import{E as G}from"./ErrorState-B3Bb-_Of.js";import{P as J}from"./PageContainer-B7AZLHYb.js";import{S as p}from"./skeleton-Dz3-cZCB.js";import{u as X}from"./use-deals-ByUhlxck.js";import{f as D,n as B}from"./ton-ClBVV2oW.js";import{C as Y}from"./chevron-down-DIE-bhp1.js";import"./useMutation-BZwFb2HR.js";import"./dealsApi-CxUgn6dD.js";const F=a=>a>=168&&a%24===0?`${a/24}d`:`${a}h`;function ue(){const{channelId:a}=Q(),d=_().state,b=d?.channel??null,j=o.useRef(null),[v,y]=o.useState(null),[R,U]=o.useState([]),[I,M]=o.useState(!1),w=X(),g=o.useMemo(()=>{if(!b)return null;const s=b;return{id:s.id,name:s.name,username:s.username??null,about:s.about??s.description??null,description:s.description??null,avatarUrl:s.avatarUrl??null,subscribers:s.subscribers??null,placementsCount:d?.placementsCount??s.placementsCount??null,minPriceNano:d?.minPriceNano??s.minPriceNano??null,tags:d?.tags??s.tags??[],listingsPreview:d?.listingsPreview??s.listingsPreview??s.listings??null}},[d,b]),r=o.useMemo(()=>g||(a?{id:a,name:"Channel",username:null,about:null,description:null,avatarUrl:null,subscribers:null,placementsCount:null,minPriceNano:null,tags:[],listingsPreview:null}:null),[g,a]),f=r?.listingsPreview?.filter(s=>s.isActive!==!1)??[],C=!!a&&f.length===0,h=K({queryKey:["listingsByChannel","details",a],queryFn:()=>W({channelId:a??"",page:1,limit:10,onlyActive:!0,sort:"price_asc"}),enabled:C,staleTime:1e3*60*5}),i=f.length>0?f:h.data?.items.filter(s=>s.isActive!==!1)??[],L=i.reduce((s,t)=>{try{const n=BigInt(t.priceNano);return s===null||n<s?n:s}catch{return s}},null),P=r?.minPriceNano??(L?L.toString():null),N=P?D(B(P)):null,u=i[0],c=w.isPending,T=r?.about??r?.description,S=r?.username?`@${r.username}`:null,$=async s=>{if(!c){y(s);try{await w.mutateAsync({listingId:s})}finally{y(null)}}},E=o.useMemo(()=>i.map(s=>({...s,priceTon:`${D(B(s.priceNano))} TON`,tags:s.tags.map(t=>t.trim()).filter(Boolean)})),[i]),q=typeof r?.subscribers=="number"?r.subscribers.toLocaleString():"—",H=s=>{const t=s.map(l=>l.trim()).filter(Boolean),n=Array.from(new Set(t));return{visible:n.slice(0,3),hiddenCount:Math.max(n.length-3,0)}},O=s=>{const t=s.map(l=>l.trim()).filter(Boolean),n=Array.from(new Set(t));return{visible:n.slice(0,2),hiddenCount:Math.max(n.length-2,0)}},x=H(r?.tags??[]),z=()=>{u&&(i.length===1?$(u.id):j.current?.scrollIntoView({behavior:"smooth",block:"start"}))},V=s=>{U(t=>t.includes(s)?t.filter(n=>n!==s):[...t,s])};return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(J,{className:"py-6 space-y-4",children:!r||a&&r.id!==a?e.jsx(G,{message:"Channel not found",description:"We couldn't load this channel."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start",children:[e.jsx("div",{className:"flex h-16 w-16 shrink-0 items-center justify-center rounded-2xl bg-primary/10 text-2xl",children:!I&&r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:r.name,className:"h-16 w-16 rounded-2xl object-cover",onError:()=>M(!0)}):r.name?.[0]?.toUpperCase()}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:r.name})}),S?e.jsx("p",{className:"text-xs text-muted-foreground",children:S}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.placementsCount??i.length??"—"," placements •"," ",q," subscribers"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["From"," ",e.jsxs("span",{className:"font-semibold text-primary",children:[N??"--"," TON"]})]}),x.visible.length>0?e.jsxs("div",{className:"flex flex-wrap gap-2 text-[11px] text-muted-foreground",children:[x.visible.map(s=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1 text-foreground",children:s},`${r.id}-${s}`)),x.hiddenCount>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1 text-muted-foreground",children:["+",x.hiddenCount]}):null]}):null,T?e.jsx("p",{className:"text-sm text-muted-foreground",children:T}):null]})]})}),e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-6",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pricing"}),e.jsxs("div",{className:"mt-2 flex items-baseline gap-2",children:[e.jsx("span",{className:"text-3xl font-semibold text-foreground",children:N??"--"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"TON per post"})]}),e.jsx("p",{className:"mt-3 text-sm text-muted-foreground",children:"Pricing includes escrow protection and bot-assisted messaging."}),e.jsxs("button",{type:"button",onClick:z,disabled:!u||c,className:"mt-5 inline-flex w-full items-center justify-center gap-2 rounded-lg bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground disabled:opacity-60",children:[c&&v===u?.id?e.jsx(A,{size:16,className:"animate-spin"}):null,"Create Deal"]})]}),e.jsxs("div",{ref:j,className:"rounded-2xl border border-border/60 bg-card/80 p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Available placements"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.placementsCount??i.length," placements available"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"From"}),e.jsxs("p",{className:"text-lg font-semibold text-primary",children:[N??"--"," TON"]})]})]}),h.isLoading&&C?e.jsx("div",{className:"space-y-3",children:Array.from({length:2}).map((s,t)=>e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/70 p-3 space-y-3",children:[e.jsx(p,{className:"h-4 w-32"}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsx(p,{className:"h-14 rounded-lg"}),e.jsx(p,{className:"h-14 rounded-lg"}),e.jsx(p,{className:"h-14 rounded-lg"})]})]},`listing-skeleton-${t}`))}):h.isError?e.jsx("div",{className:"rounded-xl border border-border/60 bg-red-500/5 p-4 text-sm text-red-200",children:"Failed to load placements."}):E.length>0?e.jsx("div",{className:"space-y-3",children:E.map(s=>{const t=c&&v===s.id,n=R.includes(s.id),l=O(s.tags),k=[s.pinDurationHours?`Pinned ${F(s.pinDurationHours)}`:null,s.visibilityDurationHours?`Visible ${F(s.visibilityDurationHours)}`:null].filter(Boolean).join(" • ");return e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/70 p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.priceTon}),k?e.jsx("p",{className:"text-[11px] text-muted-foreground",children:k}):null]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>$(s.id),disabled:c,className:"inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground disabled:opacity-60",children:[t?e.jsx(A,{size:14,className:"animate-spin"}):null,"Select"]}),e.jsx("button",{type:"button",onClick:()=>V(s.id),"aria-expanded":n,className:"flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground",children:e.jsx(Y,{size:16,className:`transition-transform ${n?"rotate-180":""}`})})]})]}),l.visible.length>0?e.jsxs("div",{className:"flex flex-wrap gap-2 text-[11px] text-muted-foreground",children:[l.visible.map(m=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2 py-0.5 text-foreground",children:m},`${s.id}-${m}`)),l.hiddenCount>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-card px-2 py-0.5",children:["+",l.hiddenCount]}):null]}):null,n?e.jsxs("div",{className:"space-y-2 text-[11px] text-muted-foreground",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:["Edits: ",s.allowEdits?"Allowed":"Not allowed"]}),e.jsxs("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:["Link tracking: ",s.allowLinkTracking?"Allowed":"Not allowed"]})]}),s.tags.length>0?e.jsx("div",{className:"flex flex-wrap gap-2 text-[11px] text-foreground",children:s.tags.map(m=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2 py-0.5",children:m},`${s.id}-expanded-${m}`))}):null,s.contentRulesText?e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-muted-foreground",children:"Rules"}),e.jsx("p",{className:"line-clamp-3",children:s.contentRulesText})]}):null]}):null]},s.id)})}):e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-6 text-center",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"No listings yet"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This channel has no active placements available right now."})]})]})]})})})}export{ue as default};
