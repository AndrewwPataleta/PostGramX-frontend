import{a as E,r as h,j as e,h as g,f as L,b as f,p as I,i as J,k as X,u as ee,R as te,d as se,e as re}from"./index-hL3AzeaV.js";import{u as O}from"./useQuery-84lU0rAQ.js";import{a as Y,b as R}from"./formatters-DrHNNfko.js";import{f as ne,h as W,b as oe,c as ae}from"./labels-EEWNt0UM.js";import{D as d}from"./deals-CwuN94JF.js";import{C as le}from"./chevron-left-BfQy29tv.js";import{C as de,S as ie}from"./ScheduleDatePicker-CSpa0Yxc.js";import{a as ce,f as ue}from"./dealsApi-COpTXnfA.js";import{L as me}from"./LoadingSkeleton-BMNctmzo.js";import{E as xe}from"./ErrorState-CWOptztJ.js";import{P as pe}from"./PageContainer-Cm-a9C2U.js";import{g as S}from"./errors-3kY4UU5q.js";import{U as _}from"./roles-CjDqvnis.js";import{u as T}from"./useMutation-D8gLmmlu.js";import{t as V}from"./date-DTgQQEB1.js";import{o as k}from"./telegramLinks-DFMIlj7w.js";import{b as ge}from"./payment-B8-ZYZHF.js";import"./button-BUfQU0W0.js";import"./input-DG6tBJtM.js";import"./Combination-BTwFOyC8.js";import"./index-DhSgTxf3.js";import"./skeleton-DaPwmbOO.js";function fe({deal:t}){const{t:s,language:n}=E(),[l,r]=h.useState(!1),x=`${Y(t.listing.priceNano,n)} ${s("common.ton")}`,i=ne(s,t.listing.format),m=t.listing.tags??[],u=t.listing.pinDurationHours??t.listing.placementHours,c=t.listing.visibilityDurationHours??t.listing.lifetimeHours,p=h.useMemo(()=>[{label:s("listings.pinDuration"),value:u?W(u,s):s("common.none")},{label:s("listings.lifetimeDuration"),value:c?W(c,s):s("common.emptyValue")},{label:s("listings.allowEdits.label"),value:t.listing.allowEdits===void 0?s("common.emptyValue"):oe(s,t.listing.allowEdits)},{label:s("listings.allowLinkTracking.label"),value:t.listing.allowLinkTracking===void 0?s("common.emptyValue"):ae(s,t.listing.allowLinkTracking)}],[t.listing.allowEdits,t.listing.allowLinkTracking,u,c,s]);return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center overflow-hidden rounded-full bg-secondary/60 text-lg font-semibold text-muted-foreground",children:t.channel.avatarUrl?e.jsx("img",{src:t.channel.avatarUrl,alt:t.channel.name,className:"h-full w-full object-cover"}):t.channel.name.slice(0,1)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-foreground",children:[e.jsx("span",{className:"truncate",children:t.channel.name}),t.channel.verified?e.jsx("span",{className:"rounded-full bg-emerald-500/10 px-2 py-0.5 text-[10px] font-semibold text-emerald-400",children:s("channels.verifiedBadge")}):null]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",t.channel.username]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:x}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"button",onClick:()=>r(o=>!o),className:"flex w-full items-center justify-between rounded-lg border border-border/60 bg-background/60 px-3 py-2 text-xs font-semibold text-muted-foreground transition hover:text-foreground",children:[e.jsx("span",{children:s(l?"common.hideDetails":"common.more")}),e.jsx("span",{className:g("text-xs",l?"text-foreground":"text-muted-foreground"),children:s(l?"common.collapseSymbol":"common.expandSymbol")})]})}),l?e.jsxs("div",{className:"mt-4 space-y-3 text-xs text-muted-foreground",children:[m.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:m.map(o=>e.jsxs("span",{className:"rounded-full bg-secondary/60 px-3 py-1 text-xs font-medium text-foreground",children:["#",o]},o))}):null,e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:p.map(o=>e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-[11px] font-semibold text-muted-foreground",children:o.label}),e.jsx("span",{className:"font-semibold text-foreground",children:o.value})]},o.label))}),t.listing.contentRulesText?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-muted-foreground",children:[e.jsx("p",{className:"text-[11px] font-semibold text-foreground/80",children:s("listings.rulesTitle")}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t.listing.contentRulesText})]}):null]}):null]})}const M=["SCHEDULE","SEND_POST","CONFIRM_POST","CREATIVE_AWAITING_ADMIN_REVIEW","PAYMENT_WINDOW","PAYMENT","PAYMENT_PENDING","SCHEDULED","VERIFYING","DONE"],he=[...M],be={[d.DRAFT]:"SCHEDULE",[d.CREATIVE_AWAITING_SUBMIT]:"SEND_POST",[d.CREATIVE_AWAITING_ADMIN_REVIEW]:"CREATIVE_AWAITING_ADMIN_REVIEW",[d.AWAITING_PAYMENT]:"PAYMENT",[d.FUNDS_PENDING]:"PAYMENT_PENDING",[d.FUNDS_CONFIRMED]:"SCHEDULED",[d.APPROVED_SCHEDULED]:"SCHEDULED",[d.POSTED_VERIFYING]:"VERIFYING",[d.COMPLETED]:"DONE",[d.CANCELED]:"DONE",[d.REFUNDED]:"DONE",[d.DISPUTED]:"DONE"},Q=t=>be[t]??"SCHEDULE",G=(t,s)=>s(`deals.timeline.stage.${t}`),Ne=(t,s)=>s(`deals.escrowStatus.${t}`),ye=(t,s)=>{const n=Q(s);return M.indexOf(t)<=M.indexOf(n)};function je({stages:t,selectedStage:s,escrowStatus:n,onSelect:l}){const{t:r}=E(),x=t.indexOf(s),i=x>0?t[x-1]:null,m=x>=0&&x<t.length-1?t[x+1]:null,u=!!l;return e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-card/80 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:r("deals.timeline.title")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r("deals.timeline.steps",{count:t.length})})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[u?e.jsx("button",{type:"button",onClick:()=>i&&l?.(i),disabled:!i,className:g("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",i?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":r("deals.timeline.previousStage"),children:e.jsx(le,{className:"h-4 w-4"})}):null,e.jsx("div",{className:"flex flex-1 flex-wrap gap-2",children:t.map(c=>{const p=c===s,o=!ye(c,n),v=g("rounded-full border px-3 py-1 text-xs font-semibold transition",p?"border-blue-500 bg-blue-600 text-white":"border-border/60 bg-background/50 text-muted-foreground",u&&!o?"hover:border-primary/40 hover:text-foreground":"opacity-70");return u?e.jsx("button",{type:"button",onClick:()=>l?.(c),disabled:o,className:g(v,o?"cursor-not-allowed opacity-40":"hover:border-primary/40 hover:text-foreground"),children:G(c,r)},c):e.jsx("div",{className:v,children:G(c,r)},c)})}),u?e.jsx("button",{type:"button",onClick:()=>m&&l?.(m),disabled:!m,className:g("flex h-9 w-9 items-center justify-center rounded-full border border-border/60 text-muted-foreground transition",m?"hover:text-foreground":"cursor-not-allowed opacity-40"),"aria-label":r("deals.timeline.nextStage"),children:e.jsx(de,{className:"h-4 w-4"})}):null]})]})}function j({title:t,children:s}){return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t})}),e.jsx("div",{className:"mt-3 space-y-2 text-xs text-muted-foreground",children:s})]})}const $=t=>{if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s};function Ee({deal:t,readonly:s,onAction:n}){const l=L(),{t:r,language:x}=E(),[i,m]=h.useState($(t.scheduledAt)),u=h.useMemo(()=>i?i.getTime()>Date.now()+3600*1e3:!1,[i]);h.useEffect(()=>{m($(t.scheduledAt))},[t.scheduledAt]);const c=T({mutationFn:async()=>{if(!i||!u)throw new Error(r("deals.stage.scheduleTime.selectDateError"));const o=V(i);if(!o.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",o),new Error("Invalid datetime format");return console.log("Schedule payload UTC:",o),I("/deals/schedule",{data:{dealId:t.id,scheduledAt:o}})},onSuccess:()=>{f.success(r("deals.stage.scheduleTime.updatedToast")),l.invalidateQueries({queryKey:["deal",t.id]})},onError:o=>{f.error(S(o,r("deals.stage.scheduleTime.saveError")))}});if(s)return e.jsxs(j,{title:r("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduleTime.readonly")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("deals.scheduledAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:t.scheduledAt?R(t.scheduledAt,x):r("deals.stage.scheduleTime.notScheduled")})]})]});const p=()=>{if(!i||!u){f.error(r("deals.stage.scheduleTime.selectDateError"));return}if(n?.onConfirmSchedule){const o=V(i);if(!o.endsWith("Z"))throw console.error("Scheduled date must be UTC ISO:",o),new Error("Invalid datetime format");n.onConfirmSchedule(o);return}c.mutate()};return e.jsxs(j,{title:r("deals.stage.scheduleTime.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.scheduleTime.description")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"pb-safe-bottom rounded-2xl border border-border/60 bg-card/80 p-3",children:e.jsx(ie,{value:i,onChange:m})}),e.jsx("button",{type:"button",onClick:p,disabled:c.isPending||!u,className:g("w-full rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",c.isPending||!u?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("deals.stage.scheduleTime.confirm")})]})]})}const ve="postgramx_bot";function we({deal:t,readonly:s,onAction:n}){const l=L(),{t:r}=E(),x=`https://t.me/${ve}?start=deal_${t.id}`,i=!!t.creativeText,m=T({mutationFn:async()=>I("/deals/creative/submit",{data:{dealId:t.id}}),onSuccess:()=>{f.success(r("deals.stage.sendPost.submittedToast")),l.invalidateQueries({queryKey:["deal",t.id]})},onError:p=>{f.error(S(p,r("deals.stage.sendPost.submitError")))}});if(s)return e.jsxs(j,{title:r("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.readonly")}),i?e.jsx("div",{className:"rounded-lg border border-border/60 bg-background/50 p-3 text-xs text-foreground",children:r("deals.stage.sendPost.creativeSubmitted")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.noCreative")})]});const u=()=>{if(n?.onOpenBot){n.onOpenBot();return}k(x)},c=()=>{if(n?.onConfirmSent){n.onConfirmSent();return}m.mutate()};return e.jsxs(j,{title:r("deals.stage.sendPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.description")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:u,className:"rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition hover:bg-primary/90",children:r("deals.stage.sendPost.openBot")}),e.jsx("button",{type:"button",onClick:c,disabled:m.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",m.isPending&&"cursor-not-allowed opacity-60"),children:r("deals.stage.sendPost.confirmSent")})]}),i?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.sendPost.waitingReview")}):null]})}const q=t=>{if(!t)return null;const s=new Date(t).getTime();if(Number.isNaN(s))return null;const n=Math.max(0,s-Date.now()),l=Math.floor(n/36e5),r=Math.floor(n%36e5/6e4),x=Math.floor(n%6e4/1e3),i=m=>m.toString().padStart(2,"0");return`${i(l)}:${i(r)}:${i(x)}`};function H({deal:t,readonly:s,onAction:n}){const l=L(),{t:r}=E(),[x,i]=h.useState(()=>q(t.adminReviewDeadlineAt));h.useEffect(()=>{if(!t.adminReviewDeadlineAt){i(null);return}const a=()=>{i(q(t.adminReviewDeadlineAt))};a();const D=window.setInterval(a,1e3);return()=>window.clearInterval(D)},[t.adminReviewDeadlineAt]);const m=T({mutationFn:async()=>I("/deals/creative/approve",{data:{dealId:t.id}}),onSuccess:()=>{f.success(r("deals.stage.adminApproval.approvedToast")),l.invalidateQueries({queryKey:["deal",t.id]})},onError:a=>{f.error(S(a,r("deals.stage.adminApproval.approveError")))}}),u=T({mutationFn:async()=>I("/deals/creative/edits",{data:{dealId:t.id}}),onSuccess:()=>{f.success(r("deals.stage.adminApproval.requestedToast")),l.invalidateQueries({queryKey:["deal",t.id]})},onError:a=>{f.error(S(a,r("deals.stage.adminApproval.requestError")))}}),c=T({mutationFn:async()=>I("/deals/creative/reject",{data:{dealId:t.id}}),onSuccess:()=>{f.success(r("deals.stage.adminApproval.rejectedToast")),l.invalidateQueries({queryKey:["deal",t.id]})},onError:a=>{f.error(S(a,r("deals.stage.adminApproval.rejectError")))}});if(s)return e.jsxs(j,{title:r("deals.stage.adminApproval.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.readonly")}),x?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.timeLeft",{time:x})}):null]});const p=()=>{if(n?.onApprove){n.onApprove();return}m.mutate()},o=()=>{if(n?.onRequestChanges){n.onRequestChanges();return}u.mutate()},v=()=>{if(n?.onReject){n.onReject();return}c.mutate()};return e.jsxs(j,{title:r("deals.stage.adminApproval.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.description")}),x?e.jsx("p",{className:"text-xs text-muted-foreground",children:r("deals.stage.adminApproval.timeLeft",{time:x})}):null,e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:p,disabled:m.isPending,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground",m.isPending&&"cursor-not-allowed opacity-60"),children:r("common.approve")}),e.jsx("button",{type:"button",onClick:o,disabled:u.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",u.isPending&&"cursor-not-allowed opacity-60"),children:r("common.requestChanges")}),e.jsx("button",{type:"button",onClick:v,disabled:c.isPending,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",c.isPending&&"cursor-not-allowed opacity-60"),children:r("common.reject")})]})]})}const De=t=>{const s=Math.max(0,Math.floor(t/1e3)),n=Math.floor(s/60).toString().padStart(2,"0"),l=(s%60).toString().padStart(2,"0");return`${n}:${l}`},Se=t=>t.length<=10?t:`${t.slice(0,3)}...${t.slice(-3)}`;function Ae({deal:t,readonly:s,onAction:n,isRefreshing:l}){const{t:r,language:x}=E(),{open:i}=J(),{isConnected:m,walletAppName:u,network:c}=X(),[p,o]=h.useState(!1),[v,a]=h.useState(null),D=t.paymentDeadlineAt??t.paymentExpiresAt,A=t.escrowAmountNano??t.listing.priceNano,w=t.escrowPaymentAddress??"",N=A?`${Y(A,x)} ${r("common.ton")}`:r("common.emptyValue"),C=h.useMemo(()=>{if(!m)return r("deals.stage.payment.walletDisconnected");const y=c?` • ${c}`:"";return`${r("deals.stage.payment.walletConnected")}${u?` • ${u}`:""}${y}`},[m,c,r,u]);if(h.useEffect(()=>{if(!D){a(null);return}const y=new Date(D).getTime();if(Number.isNaN(y)){a(null);return}const F=()=>{const z=Math.max(0,y-Date.now());a(De(z))};F();const Z=window.setInterval(F,1e3);return()=>window.clearInterval(Z)},[D]),h.useEffect(()=>{o(!1)},[t.id,t.escrowStatus]),t.escrowStatus!==d.AWAITING_PAYMENT)return null;const b=()=>{s||i()},U=()=>{if(!(s||!w||!A))try{const y=ge({address:w,amountNano:A,memo:`Deal:${t.id}`});k(y),o(!0)}catch(y){f.error(y instanceof Error?y.message:r("deals.stage.payment.paymentCanceled"))}},K=async()=>{if(w)try{await navigator.clipboard.writeText(w),f.success(r("deals.stage.payment.addressCopied"))}catch(y){f.error(y instanceof Error?y.message:r("deals.stage.payment.copyFailed"))}};return e.jsxs(j,{title:r("deals.stage.payment.title"),children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",m?"bg-emerald-400":"bg-muted-foreground/50")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:C})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"rounded-xl border border-border/60 bg-background/40 p-3",children:e.jsxs("div",{className:"space-y-2 text-xs text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:r("deals.stage.payment.amountToPay")}),": ",N]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:r("deals.stage.payment.receiver")}),": ",w?Se(w):r("common.emptyValue")]}),v?e.jsx("p",{children:e.jsx("span",{className:"font-semibold text-foreground",children:r("deals.stage.payment.expiresIn",{time:v})})}):null]})}),p?e.jsxs("div",{className:"flex flex-wrap items-center gap-3 rounded-xl border border-border/60 bg-secondary/30 px-3 py-2",children:[e.jsx("span",{className:"inline-flex h-4 w-4 items-center justify-center rounded-full border border-border/60",children:e.jsx("span",{className:"h-2 w-2 animate-spin rounded-full border-2 border-muted-foreground border-t-transparent"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r("deals.stage.payment.waiting")})]}):null,e.jsx("div",{className:"flex flex-wrap gap-2",children:m?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:U,disabled:s||p,className:g("rounded-lg bg-primary px-4 py-2 text-xs font-semibold text-primary-foreground transition",s||p?"cursor-not-allowed opacity-60":"hover:bg-primary/90"),children:r("deals.stage.payment.payWithWallet")}),e.jsx("button",{type:"button",onClick:K,disabled:s,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition",s?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r("deals.stage.payment.copyAddress")})]}):e.jsx("button",{type:"button",onClick:b,disabled:s,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition",s?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r("deals.stage.payment.connectWallet")})}),p?e.jsx("button",{type:"button",onClick:n?.onRefresh,disabled:l||!n?.onRefresh,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",l||!n?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:r(l?"common.refreshing":"deals.stage.payment.checkStatus")}):null]})]})}function Ce({onAction:t,isRefreshing:s}){const{t:n}=E();return e.jsxs(j,{title:n("deals.stage.paymentPending.title"),children:[e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"rounded-full border border-emerald-400/40 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-300",children:n("deals.stage.payment.paymentDetected")})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n("deals.stage.paymentPending.description")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx("button",{type:"button",onClick:t?.onRefresh,disabled:s||!t?.onRefresh,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground",s||!t?.onRefresh?"cursor-not-allowed opacity-60":"hover:border-primary/40"),children:n(s?"common.refreshing":"common.refresh")})})]})}function B({deal:t}){const{t:s,language:n}=E(),l=t.scheduledAt?R(t.scheduledAt,n):s("deals.stage.scheduled.notScheduled");return e.jsxs(j,{title:s("deals.stage.scheduled.title"),children:[t.escrowStatus===d.FUNDS_CONFIRMED?e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"rounded-full border border-emerald-400/40 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-300",children:s("deals.stage.payment.paymentDetected")})}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.stage.scheduled.time"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:l})]}),t.scheduledAt?e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduled.waiting")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.scheduled.noSchedule")})]})}function Ie({deal:t}){const{t:s}=E(),n=()=>{t.postUrl&&k(t.postUrl)};return e.jsxs(j,{title:s("deals.stage.verifyingPost.title"),children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.verifyingPost.description")}),t.postUrl?e.jsx("button",{type:"button",onClick:n,className:g("rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground","hover:border-primary/40"),children:s("deals.stage.verifyingPost.open")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.verifyingPost.pendingLink")})]})}function P({deal:t}){const{t:s,language:n}=E(),l=ee(),r=t.escrowStatus===d.CANCELED,x=()=>{l(te.DEAL_CREATE(t.listing.id))};return e.jsxs(j,{title:s("deals.stage.done.title"),children:[r?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:s("deals.stage.payment.windowExpired")}),e.jsx("button",{type:"button",onClick:x,className:"rounded-lg border border-border/60 px-4 py-2 text-xs font-semibold text-foreground transition hover:border-primary/40",children:s("deals.stage.payment.createNewDeal")})]}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("deals.statusLabel"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:Ne(t.escrowStatus,s)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("common.lastUpdate"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:R(t.lastActivityAt,n)||s("common.emptyValue")})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("common.createdAt"),":"," ",e.jsx("span",{className:"font-semibold text-foreground",children:R(t.createdAt,n)||s("common.emptyValue")})]})]})}function Je(){const{dealId:t}=se(),s=re(),n=L(),l=s.state?.deal,r=t?n.getQueryData(["deal",t]):void 0,x=l?.id===t?l:r,{data:i,isLoading:m,error:u,refetch:c,isFetching:p}=O({queryKey:["deal",t],queryFn:async()=>{if(!t)throw new Error("Missing deal id");return ce(t)},enabled:!!t,initialData:x,refetchInterval:N=>N?N.escrowStatus===d.CREATIVE_AWAITING_ADMIN_REVIEW?1e4:N.escrowStatus===d.AWAITING_PAYMENT?12e3:[d.FUNDS_PENDING,d.POSTED_VERIFYING].includes(N.escrowStatus)?5e3:!1:!1}),o=O({queryKey:["deals","list","detail-fallback",t],queryFn:()=>ue({role:"all",pendingLimit:20,activeLimit:20,completedLimit:20}),enabled:!!t&&!i,staleTime:2e4}),v=h.useMemo(()=>!o.data||!t?null:[...o.data.pending.items,...o.data.active.items,...o.data.completed.items].find(C=>C.id===t)??null,[t,o.data]),a=i??v;h.useEffect(()=>{(u||o.error)&&f.error(S(u??o.error,"Unable to load deal"))},[u,o.error]);const D=a?Q(a.escrowStatus):"SCHEDULE",A=a?he:[],w=h.useMemo(()=>{if(!a)return null;const N=a.userRoleInDeal===_.ADVERTISER,C=a.userRoleInDeal===_.PUBLISHER||a.userRoleInDeal===_.PUBLISHER_MANAGER,b=!N;return{[d.DRAFT]:e.jsx(Ee,{deal:a,readonly:!N}),[d.CREATIVE_AWAITING_SUBMIT]:e.jsx(we,{deal:a,readonly:!N}),[d.CREATIVE_AWAITING_ADMIN_REVIEW]:e.jsx(H,{deal:a,readonly:!C}),ADMIN_REVIEW:e.jsx(H,{deal:a,readonly:!C}),CREATIVE_AWAITING_CONFIRM:e.jsx(StageConfirmPost,{deal:a,readonly:!N}),[d.AWAITING_PAYMENT]:e.jsx(Ae,{deal:a,readonly:b,onAction:b?void 0:{onRefresh:()=>c()},isRefreshing:p}),[d.FUNDS_PENDING]:e.jsx(Ce,{deal:a,readonly:b,onAction:b?void 0:{onRefresh:()=>c()},isRefreshing:p}),[d.FUNDS_CONFIRMED]:e.jsx(B,{deal:a,readonly:b}),[d.APPROVED_SCHEDULED]:e.jsx(B,{deal:a,readonly:b}),[d.POSTED_VERIFYING]:e.jsx(Ie,{deal:a,readonly:b}),[d.COMPLETED]:e.jsx(P,{deal:a,readonly:b}),[d.CANCELED]:e.jsx(P,{deal:a,readonly:b}),[d.REFUNDED]:e.jsx(P,{deal:a,readonly:b}),[d.DISPUTED]:e.jsx(P,{deal:a,readonly:b})}[a.escrowStatus]},[p,c,a]);return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(pe,{className:"py-6 space-y-4",children:m?e.jsx(me,{items:3}):u||o.error||!a?e.jsx(xe,{message:S(u??o.error,"Deal not found"),description:"We couldn't load this deal right now.",onRetry:()=>c()}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{deal:a}),e.jsx(je,{stages:A,selectedStage:D,escrowStatus:a.escrowStatus}),w]})})})}export{Je as default};
