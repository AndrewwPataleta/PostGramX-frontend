import{a as I,d as z,e as Q,r as i,j as e,L as _}from"./index-hL3AzeaV.js";import{u as K}from"./useQuery-84lU0rAQ.js";import{l as G}from"./listingsApi-CwEfaA4O.js";import{E as J}from"./ErrorState-CWOptztJ.js";import{P as O}from"./PageContainer-Cm-a9C2U.js";import{S as p}from"./skeleton-DaPwmbOO.js";import{u as W}from"./use-deals-CTFFoudr.js";import{a as T,f as X}from"./formatters-DrHNNfko.js";import{g as Y,a as Z,b as ee,c as se}from"./labels-EEWNt0UM.js";import{C as re}from"./chevron-down-CELqZ4uK.js";import"./useMutation-D8gLmmlu.js";import"./dealsApi-COpTXnfA.js";function fe(){const{t:r,language:u}=I(),{channelId:l}=z(),d=Q().state,b=d?.channel??null,A=i.useRef(null),[D,N]=i.useState(null),[$,B]=i.useState([]),[F,U]=i.useState(!1),v=W(),g=i.useMemo(()=>{if(!b)return null;const s=b;return{id:s.id,name:s.name,username:s.username??null,about:s.about??s.description??null,description:s.description??null,avatarUrl:s.avatarUrl??null,subscribers:s.subscribers??null,placementsCount:d?.placementsCount??s.placementsCount??null,minPriceNano:d?.minPriceNano??s.minPriceNano??null,tags:d?.tags??s.tags??[],listingsPreview:d?.listingsPreview??s.listingsPreview??s.listings??null}},[d,b]),t=i.useMemo(()=>g||(l?{id:l,name:r("common.channel"),username:null,about:null,description:null,avatarUrl:null,subscribers:null,placementsCount:null,minPriceNano:null,tags:[],listingsPreview:null}:null),[g,l]),f=t?.listingsPreview?.filter(s=>s.isActive!==!1)??[],y=!!l&&f.length===0,h=K({queryKey:["listingsByChannel","details",l],queryFn:()=>G({channelId:l??"",page:1,limit:10,onlyActive:!0,sort:"price_asc"}),enabled:y,staleTime:1e3*60*5}),c=f.length>0?f:h.data?.items.filter(s=>s.isActive!==!1)??[],L=c.reduce((s,n)=>{try{const a=BigInt(n.priceNano);return s===null||a<s?a:s}catch{return s}},null),w=t?.minPriceNano??(L?L.toString():null),C=w?T(w,u):null;c[0];const j=v.isPending,k=t?.about??t?.description,P=t?.username?`@${t.username}`:null,V=async s=>{if(!j){N(s);try{await v.mutateAsync({listingId:s})}finally{N(null)}}},E=i.useMemo(()=>c.map(s=>({...s,priceTon:`${T(s.priceNano,u)} ${r("common.ton")}`,tags:s.tags.map(n=>n.trim()).filter(Boolean)})),[c,u,r]),M=typeof t?.subscribers=="number"?X(t.subscribers,u):r("common.emptyValue"),R=s=>{const n=s.map(o=>o.trim()).filter(Boolean),a=Array.from(new Set(n));return{visible:a.slice(0,3),hiddenCount:Math.max(a.length-3,0)}},q=s=>{const n=s.map(o=>o.trim()).filter(Boolean),a=Array.from(new Set(n));return{visible:a.slice(0,2),hiddenCount:Math.max(a.length-2,0)}},x=R(t?.tags??[]),H=s=>{B(n=>n.includes(s)?n.filter(a=>a!==s):[...n,s])};return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(O,{className:"py-6 space-y-4",children:!t||l&&t.id!==l?e.jsx(J,{message:r("marketplace.channelNotFound.title"),description:r("marketplace.channelNotFound.subtitle")}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-4",children:e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start",children:[e.jsx("div",{className:"flex h-16 w-16 shrink-0 items-center justify-center rounded-2xl bg-primary/10 text-2xl",children:!F&&t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:t.name,className:"h-16 w-16 rounded-2xl object-cover",onError:()=>U(!0)}):t.name?.[0]?.toUpperCase()}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t.name})}),P?e.jsx("p",{className:"text-xs text-muted-foreground",children:P}):null,e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.placementsCount??c.length??r("common.emptyValue")," ",r("marketplace.placements")," • ",M," ",r("marketplace.subscribers")]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("common.from")," ",e.jsxs("span",{className:"font-semibold text-primary",children:[C??r("common.emptyValue")," ",r("common.ton")]})]}),x.visible.length>0?e.jsxs("div",{className:"flex flex-wrap gap-2 text-[11px] text-muted-foreground",children:[x.visible.map(s=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1 text-foreground",children:s},`${t.id}-${s}`)),x.hiddenCount>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-card px-2.5 py-1 text-muted-foreground",children:["+",x.hiddenCount]}):null]}):null,k?e.jsx("p",{className:"text-sm text-muted-foreground",children:k}):null]})]})}),e.jsxs("div",{ref:A,className:"rounded-2xl border border-border/60 bg-card/80 p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:r("marketplace.availablePlacements")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.placementsCount??c.length," ",r("marketplace.placementsAvailable")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r("common.from")}),e.jsxs("p",{className:"text-lg font-semibold text-primary",children:[C??r("common.emptyValue")," ",r("common.ton")]})]})]}),h.isLoading&&y?e.jsx("div",{className:"space-y-3",children:Array.from({length:2}).map((s,n)=>e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/70 p-3 space-y-3",children:[e.jsx(p,{className:"h-4 w-32"}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsx(p,{className:"h-14 rounded-lg"}),e.jsx(p,{className:"h-14 rounded-lg"}),e.jsx(p,{className:"h-14 rounded-lg"})]})]},`listing-skeleton-${n}`))}):h.isError?e.jsx("div",{className:"rounded-xl border border-border/60 bg-red-500/5 p-4 text-sm text-red-200",children:r("marketplace.listingsLoadFailed")}):E.length>0?e.jsx("div",{className:"space-y-3",children:E.map(s=>{const n=j&&D===s.id,a=$.includes(s.id),o=q(s.tags),S=[s.pinDurationHours?Y(r,s.pinDurationHours):null,s.visibilityDurationHours?Z(r,s.visibilityDurationHours):null].filter(Boolean).join(" • ");return e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/70 p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.priceTon}),S?e.jsx("p",{className:"text-[11px] text-muted-foreground",children:S}):null]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>V(s.id),disabled:j,className:"inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground disabled:opacity-60",children:[n?e.jsx(_,{size:14,className:"animate-spin"}):null,r("common.select")]}),e.jsx("button",{type:"button",onClick:()=>H(s.id),"aria-expanded":a,className:"flex h-8 w-8 items-center justify-center rounded-lg border border-border/60 bg-background/70 text-muted-foreground transition hover:text-foreground",children:e.jsx(re,{size:16,className:`transition-transform ${a?"rotate-180":""}`})})]})]}),o.visible.length>0?e.jsxs("div",{className:"flex flex-wrap gap-2 text-[11px] text-muted-foreground",children:[o.visible.map(m=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2 py-0.5 text-foreground",children:m},`${s.id}-${m}`)),o.hiddenCount>0?e.jsxs("span",{className:"rounded-full border border-border/60 bg-card px-2 py-0.5",children:["+",o.hiddenCount]}):null]}):null,a?e.jsxs("div",{className:"space-y-2 text-[11px] text-muted-foreground",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:[r("listings.allowEdits.label"),":"," ",ee(r,s.allowEdits)]}),e.jsxs("span",{className:"rounded-full border border-border/60 bg-muted/40 px-2 py-0.5",children:[r("listings.allowLinkTracking.label"),":"," ",se(r,s.allowLinkTracking)]})]}),s.tags.length>0?e.jsx("div",{className:"flex flex-wrap gap-2 text-[11px] text-foreground",children:s.tags.map(m=>e.jsx("span",{className:"rounded-full border border-border/60 bg-card px-2 py-0.5",children:m},`${s.id}-expanded-${m}`))}):null,s.contentRulesText?e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-muted-foreground",children:r("listings.rules")}),e.jsx("p",{className:"line-clamp-3",children:s.contentRulesText})]}):null]}):null]},s.id)})}):e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-card/80 p-6 text-center",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:r("marketplace.emptyListingsTitle")}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:r("marketplace.emptyListingsSubtitle")})]})]})]})})})}export{fe as default};
