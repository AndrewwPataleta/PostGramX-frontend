import{d as R,u as w,r as u,b as p,j as e,h as g}from"./index-BCQQ6zpL.js";import{u as D}from"./useQuery-iFZJMQz6.js";import{u as T}from"./useMutation-ByUVrACc.js";import{a as C,b as P}from"./predealsApi-X80QtMrl.js";import{E as b}from"./ErrorState-C2o6ti_8.js";import{P as i}from"./PageContainer-BzWp3KSK.js";import{S as l}from"./skeleton-DufSVfEO.js";import{g as A}from"./errors-3kY4UU5q.js";import{o as j}from"./telegramLinks-DFMIlj7w.js";const _=new Set(["API","ID","TON","USD"]),S=r=>{const o=r.replace(/[_-]+/g," ").replace(/\s+/g," ").trim();return o?o.split(" ").map(a=>{const n=a.toUpperCase();if(_.has(n))return n;const t=a.toLowerCase();return`${t.charAt(0).toUpperCase()}${t.slice(1)}`}).join(" "):""},v={ACTIVE:"Active",ADMIN_REVIEW:"Admin review",APPROVED_SCHEDULED:"Scheduled",AWAITING_ADMIN_APPROVAL:"Awaiting admin approval",AWAITING_CONFIRMATION:"Awaiting confirmation",AWAITING_CREATIVE:"Awaiting creative",AWAITING_PAYMENT:"Awaiting payment",CANCELED:"Canceled",CANCELLED:"Canceled",COMPLETED:"Completed",CREATIVE_AWAITING_ADMIN_REVIEW:"Awaiting admin review",CREATIVE_AWAITING_CONFIRM:"Awaiting confirmation",CREATIVE_AWAITING_SUBMIT:"Awaiting creative",CREATIVE_APPROVED:"Creative approved",CREATIVE_DRAFTING:"Creative drafting",CREATIVE_REVIEW:"Creative review",CREATIVE_SUBMITTED:"Creative submitted",DISPUTED:"Disputed",EXPIRED:"Expired",FUNDS_CONFIRMED:"Funds confirmed",FUNDS_LOCKED:"Funds locked",FUNDS_PENDING:"Funds pending",PAYMENT_AWAITING:"Awaiting payment",PAYMENT_CONFIRMING:"Payment confirming",PAYMENT_REQUIRED:"Payment required",PAYMENT_WINDOW_PENDING:"Payment window",PENDING:"Pending",POSTED:"Posted",POSTED_VERIFYING:"Post verifying",READY_FOR_PAYMENT:"Ready for payment",REFUNDED:"Refunded",REJECTED:"Rejected",RELEASED:"Released",REQUESTED:"Requested",SCHEDULED:"Scheduled",SCHEDULING_PENDING:"Scheduling pending",VERIFYING:"Verifying"},M=r=>r?v[r]??S(r):"",L={AWAITING_CREATIVE:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_CONFIRMATION:"border-border/60 bg-secondary/40 text-muted-foreground",AWAITING_ADMIN_APPROVAL:"border-border/60 bg-secondary/40 text-muted-foreground",READY_FOR_PAYMENT:"border-emerald-500/30 bg-emerald-500/15 text-emerald-200",REJECTED:"border-rose-500/30 bg-rose-500/15 text-rose-200",EXPIRED:"border-rose-500/30 bg-rose-500/15 text-rose-200",CANCELED:"border-rose-500/30 bg-rose-500/15 text-rose-200"},O=new Set(["READY_FOR_PAYMENT","REJECTED","EXPIRED","CANCELED"]),U=r=>{const o=Math.max(0,Math.floor(r)),a=Math.floor(o/3600),n=Math.floor(o%3600/60),t=o%60;return a>0?`${a}h ${n}m`:n>0?`${n}m ${t}s`:`${t}s`},F=r=>M(r)||"Awaiting update",x=({title:r,children:o,className:a})=>e.jsxs("div",{className:g("rounded-2xl border border-border/60 bg-card/80 p-4 space-y-3",a),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground",children:"Step"}),e.jsx("h2",{className:"text-sm font-semibold text-foreground",children:r})]}),o]});function H(){const{id:r}=R(),o=w(),[a,n]=u.useState(Date.now()),t=D({queryKey:["predeal",r],queryFn:()=>P({id:r??""}),enabled:!!r,refetchInterval:d=>{const N=d.state.data?.status;return N&&O.has(N)?!1:4e3}}),c=T({mutationFn:C,onSuccess:()=>{p.success("Pre-deal canceled"),o("/marketplace",{replace:!0})},onError:d=>{p.error(A(d,"Unable to cancel pre-deal"))}});if(u.useEffect(()=>{t.error&&p.error(A(t.error,"Unable to load pre-deal"))},[t.error]),u.useEffect(()=>{if(!t.data?.paymentExpiresAt)return;const d=window.setInterval(()=>n(Date.now()),1e3);return()=>window.clearInterval(d)},[t.data?.paymentExpiresAt]),!r)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(i,{className:"py-6",children:e.jsx(b,{message:"Pre-deal not found",description:"Return to the marketplace to choose a listing.",onRetry:()=>o("/marketplace")})})});if(t.isLoading)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(i,{className:"py-6 space-y-4",children:[e.jsx(l,{className:"h-6 w-40"}),e.jsx(l,{className:"h-4 w-64"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(l,{className:"h-36 w-full"}),e.jsx(l,{className:"h-36 w-full"}),e.jsx(l,{className:"h-36 w-full"})]})]})});if(t.isError||!t.data)return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsx(i,{className:"py-6",children:e.jsx(b,{message:"Unable to load pre-deal",description:"We could not fetch the latest status.",onRetry:()=>t.refetch()})})});const s=t.data,I=F(s.status),h=L[s.status]??"border-border/60 bg-secondary/40 text-muted-foreground",y=s.status==="READY_FOR_PAYMENT",E=s.paymentExpiresAt?new Date(s.paymentExpiresAt):null,m=E?(E.getTime()-a)/1e3:null,f=m!=null?m>0?U(m):"Payment window expired":null;return e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(i,{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Pre-deal status"}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Send your post to the bot"})]}),e.jsxs(x,{title:"Send post to bot",children:[e.jsx("p",{className:"text-sm text-foreground",children:s.botInstructions?.message??"Open the bot and send your post for review."}),s.botInstructions?.startUrl?e.jsx("button",{type:"button",onClick:()=>j(s.botInstructions?.startUrl??""),className:"w-full rounded-lg border border-border/60 bg-secondary/40 px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border",children:"Open bot"}):null]}),e.jsxs(x,{title:"Wait for approvals",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("span",{className:g("inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold",h),children:I}),e.jsx("button",{type:"button",onClick:()=>t.refetch(),className:"rounded-lg border border-border/60 bg-secondary/40 px-3 py-1.5 text-xs font-semibold text-foreground transition hover:border-border",children:"Refresh"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"We will keep checking for status updates every few seconds."})]}),e.jsx(x,{title:"Payment",children:y?e.jsxs("div",{className:"space-y-3",children:[f?e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Payment window: ",e.jsx("span",{className:"font-semibold text-foreground",children:f})]}):null,s.payment?.escrowAddress?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Escrow address"}),e.jsx("p",{className:"text-xs font-semibold text-foreground break-all",children:s.payment.escrowAddress})]}):null,s.payment?.expectedAmountNano?e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background px-3 py-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Amount (nano)"}),e.jsx("p",{className:"text-xs font-semibold text-foreground",children:s.payment.expectedAmountNano})]}):null,e.jsx("button",{type:"button",onClick:()=>o(`/escrow/${s.id}`),className:"w-full rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground",children:"Open Mini App Payment"})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Payment details will appear once the post is approved."})}),e.jsx("button",{type:"button",onClick:()=>c.mutate({id:s.id}),disabled:c.isPending,className:"w-full rounded-lg border border-border/60 bg-background px-4 py-2.5 text-sm font-semibold text-foreground transition hover:border-border disabled:opacity-60",children:c.isPending?"Canceling...":"Cancel pre-deal"})]})})}export{H as default};
